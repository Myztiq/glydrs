try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(e$$5){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(w,z,t,r,n){function o(a,b){if("object"!==typeof a)return q("enumerator validation failed, invalid type base object."),n;if(b===n)return n;if("number"===typeof b)return b;if("string"===typeof b){var f=parseInt(b,10);if(""!==b&&isFinite(f))return f;f=b.toUpperCase();f=a[f];if(f!==n)return f;q("enumerator validation failed, unknown enum value: "+b);var f="",d;for(d in a)a.hasOwnProperty(d)&&(""!==f&&(f+=", "),f+=d.toLowerCase());q("possible enum values are: "+f)}return n}function c(a,b){A.registry[a]=
!0;var f=b(A),d;for(d in f)f.hasOwnProperty(d)&&(h[d]=f[d])}var g="";try{for(var a=z.querySelectorAll("script"),b=0,e=a.length;b<e;b++){var d=a[b].src.lastIndexOf("/CubicVR.js");-1<d&&(g=a[b].src.substr(0,d)+"/")}}catch(f){}var h=w.CubicVR={},m={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,resize_active:!1,emptyLight:null,resizeList:[],canvasSizeFactor:1},
q;try{q=void 0!==console&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(y){q=r}var s={quality:{LOW:0,MEDIUM:1,HIGH:2}};w.cubicvr=s;var A={undef:n,nop:r,scriptLocation:g,GLCore:m,Textures:[],Textures_obj:[],Textures_ref:[],Images:[],ShaderPool:[],log:q,registry:{},enums:s,MAX_LIGHTS:6,features:{},quality:s.HIGH},v={antiAlias:!1,lightPerPixel:!1,lightShadows:!1,texturePerPixel:!1,postProcess:!1},H={antiAlias:!1,lightPerPixel:!0,lightShadows:!1,texturePerPixel:!1,postProcess:!1},
J={antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0};A.features=J;m.init=function(a,b,f){var d,e=h.util;b&&f?(b=e.getScriptContents(b),f=e.getScriptContents(f)):h.CubicVRCoreVS&&h.CubicVRCoreFS?(b=h.CubicVRCoreVS,f=h.CubicVRCoreFS):(b=e.getScriptContents(g+"CubicVR_Core.vs"),f=e.getScriptContents(g+"CubicVR_Core.fs"));if(a===n){a=z.createElement("canvas");if(!d)try{d=a.getContext("experimental-webgl",{antialias:A.features.antiAlias})}catch(c){return null}m.gl=d;if(null!==
m.fixed_size)m.width=m.fixed_size[0],m.height=m.fixed_size[1],m.resizeElement(a,m.width,m.height);else if(m.addResizeable(a),1!==m.canvasSizeFactor&&a.getContext!==n){var e=t.round(w.innerWidth*m.canvasSizeFactor),y=t.round(w.innerHeight*m.canvasSizeFactor);m.resizeElement(a,e,y);a.style.top=w.innerHeight/2-y/2+"px";a.style.left=w.innerWidth/2-e/2+"px";a.style.position="absolute"}else m.resizeElement(a,w.innerWidth,w.innerHeight);z.body.appendChild(a)}if(a.getContext!==n&&a.width!==n&&a.height!==
n){try{d||(d=a.getContext("experimental-webgl",{antialias:A.features.antiAlias})),d.viewport(0,0,a.width,a.height),m.canvas=a,m.width=a.width,m.height=a.height,d.clearColor(0,0,0,1),d.clearDepth(1),d.enable(d.DEPTH_TEST),d.depthFunc(d.LEQUAL)}catch(v){}if(!d)return null}else d=a;m.gl=d;m.CoreShader_vs=b;m.CoreShader_fs=f;d.enable(d.CULL_FACE);d.cullFace(d.BACK);d.frontFace(d.CCW);for(b=s.light.type.NULL;b<s.light.type.MAX;b++)A.ShaderPool[b]=[];f=new h.Texture;a=new h.Material;for(b=0;b<s.texture.map.MAX;b++)b!==
s.texture.map.BUMP&&a.setTexture(f,b);a.opacity=0.5;for(b=1;;){if(!a.use(s.light.type.POINT,b)||8===b){A.MAX_LIGHTS=b;break}b++}a=m.emptyLight=new h.Light(s.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;q("Calibrated maximum lights per pass to: "+b);for(b=s.light.type.NULL;b<s.light.type.MAX;b++)A.ShaderPool[b]=[];if(m.resizeList.length)w.addEventListener("resize",function(){h.GLCore.onResize()},!1),m.resize_active=!0;return d};m.addResizeable=function(a){h.GLCore.resizeList.push(a)};
m.onResize=function(){var a=w.innerWidth,b=w.innerHeight;null!==m.fixed_size&&(a=h.GLCore.fixed_size[0],b=h.GLCore.fixed_size[1]);for(var f=0,d=h.GLCore.resizeList.length;f<d;f++)m.resizeElement(h.GLCore.resizeList[f],a,b)};m.setFixedAspect=function(a){h.GLCore.fixed_aspect=a};m.setFixedSize=function(a,b){h.GLCore.fixed_size=[a,b]};m.getCanvas=function(){return h.GLCore.canvas};m.resizeElement=function(a,b,f){var d=m.gl;if(0!==m.fixed_aspect){var q=b*(1/h.GLCore.fixed_aspect);q>f&&(q=f,b=f*h.GLCore.fixed_aspect);
f=q}if(a.getContext!==n){a.width=b;a.height=f;if(!h.GLCore.fixed_size)a.style.left=(w.innerWidth/2-b/2|0)+"px",a.style.top=(w.innerHeight/2-f/2|0)+"px",a.style.position="absolute";d.viewport(0,0,b,f)}else a.resize(b,f)};m.setDepthAlpha=function(a,b,f){m.depth_alpha=a;m.depth_alpha_near=b;m.depth_alpha_far=f};m.setDefaultFilter=function(a){m.default_filter=o(h.enums.texture.filter,a)};m.setSoftShadows=function(a){m.soft_shadow=a};m.setCanvasSizeFactor=function(a){m.canvasSizeFactor=a};m.setQuality=
function(a){a=o(s.quality,a);if(a===s.quality.HIGH)A.features=J;else if(a===s.quality.MEDIUM)A.features=H;else if(a===s.quality.LOW)A.features=v;A.quality=a;return A.features};m.getQuality=function(){return A.features};var E=function(a,b,f){for(var d,h=z.getElementsByTagName("script"),q=0;q<h.length;++q){var e=h[q];if(e.getAttribute("data-cubicvr")){var c=e.getAttribute("src");if(c){var s=new XMLHttpRequest;s.open("GET",c,!1);s.send(null);if(200===s.status||0===s.status)e.text=s.responseText}}}"object"===
typeof a?a.getContext?d=a:(d=a.canvas,b=a.vertexShader||b,f=a.fragmentShader||f):a&&("#"==a[0]&&(a=a.substr(1)),d=z.getElementById(a));return m.init(d,b,f)},u={GLCore:m,init:E,start:function(a,b,f,d,m){"string"===typeof a&&"auto"===a.toLowerCase()&&(a=n);f=f||"Sorry, your browser does not appear to support WebGL :-(";if(a=E(a,d,m))return b&&"function"===typeof b&&b(a,h.getCanvas()),a;if(!a)return f&&"function"===typeof f?f():alert(f),!1},addResizeable:m.addResizeable,setFixedAspect:m.setFixedAspect,
setFixedSize:m.setFixedSize,setCanvasSizeFactor:m.setCanvasSizeFactor,getCanvas:m.getCanvas,enums:s,IdentityMatrix:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Textures:A.Textures,Textures_obj:A.Textures_obj,Images:A.Images,globalAmbient:[0.1,0.1,0.1],setGlobalAmbient:function(a){h.globalAmbient=a},setGlobalDepthAlpha:m.setDepthAlpha,setDefaultFilter:m.setDefaultFilter,setSoftShadows:m.setSoftShadows,setQuality:m.setQuality,getQuality:m.getQuality,RegisterModule:c,getScriptLocation:function(){return g},parseEnum:o};
c("Core",function(){return u})})(window,window.document,Math,function(){});
CubicVR.RegisterModule("Math",function(w){function z(a){return this.clearStack(a)}function t(){if(1===arguments.length)this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3];if(4===arguments.length)this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3]}var r=w.undef,n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],o=Math.PI/2,c={length:function(a){var b=a[0],e=a[1],a=a[2];return Math.sqrt(b*b+e*e+a*a)},normalize:function(a){var b=a[0],e=a[1],d=a[2];
return(b=Math.sqrt(b*b+e*e+d*d))?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},angle:function(a,b){return Math.acos((a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])))},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},multiply:function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},subtract:function(a,b){return[a[0]-
b[0],a[1]-b[1],a[2]-b[2]]},equal:function(a,b,e){e===r&&(e=1.0E-7);return a===r&&b===r?!0:a===r||b===r?!1:Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e&&Math.abs(a[2]-b[2])<e},moveViewRelative:function(a,b,e,d,f){var h=Math.atan2(d,e),b=Math.atan2(b[2]-a[2],b[0]-a[0]),e=Math.sqrt(e*e+d*d),h=b+h+o;return"object"===typeof f?[f[0]+e*Math.cos(h),f[1],f[2]+e*Math.sin(h)]:[a[0]+e*Math.cos(h),a[1],a[2]+e*Math.sin(h)]},trackTarget:function(a,b,e,d){var b=c.subtract(b,a),f=c.length(b),h;h=c.normalize(b);h=
c.multiply(h,e*(1/(1/(f-d))));f>d?a=c.add(a,h):f<d?(h=c.normalize(b),h=c.multiply(h,e*(1/(1/Math.abs(f-d)))),a=c.subtract(a,h)):a=[a[0],a[1]+h[2],a[2]];return a},getClosestTo:function(a,b,e){b=c.subtract(b,a);e=c.subtract(e,a);return c.add(c.multiply(b,c.dot(b,e)/c.dot(b,b)),a)},linePlaneIntersect:function(a,b,e,d){var f=-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],b=a[0]*(d[0]-e[0])+a[1]*(d[1]-e[1])+a[2]*(d[2]-e[2]);if(0.001>Math.abs(b))return!1;a=-(f+a[0]*e[0]+a[1]*e[1]+a[2]*e[2])/b;return[e[0]+a*(d[0]-e[0]),
e[1]+a*(d[1]-e[1]),e[2]+a*(d[2]-e[2])]}},g={lookat:function(a,b,e,d,f,h,m,q,g){var s=[],A=[],v=[],A=[];s[0]=d-a;s[1]=f-b;s[2]=h-e;v[0]=m;v[1]=q;v[2]=g;s=c.normalize(s);A=c.cross(s,v);A=c.normalize(A);v=c.cross(A,s);A=[A[0],v[0],-s[0],0,A[1],v[1],-s[1],0,A[2],v[2],-s[2],0,0,0,0,1];d=new CubicVR.Transform(A);d.translate([-a,-b,-e]);return d.getResult()},multiply:function(a,b,e){e===r&&(e=[]);e[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3];e[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3];e[2]=a[2]*b[0]+a[6]*
b[1]+a[10]*b[2]+a[14]*b[3];e[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3];e[4]=a[0]*b[4]+a[4]*b[5]+a[8]*b[6]+a[12]*b[7];e[5]=a[1]*b[4]+a[5]*b[5]+a[9]*b[6]+a[13]*b[7];e[6]=a[2]*b[4]+a[6]*b[5]+a[10]*b[6]+a[14]*b[7];e[7]=a[3]*b[4]+a[7]*b[5]+a[11]*b[6]+a[15]*b[7];e[8]=a[0]*b[8]+a[4]*b[9]+a[8]*b[10]+a[12]*b[11];e[9]=a[1]*b[8]+a[5]*b[9]+a[9]*b[10]+a[13]*b[11];e[10]=a[2]*b[8]+a[6]*b[9]+a[10]*b[10]+a[14]*b[11];e[11]=a[3]*b[8]+a[7]*b[9]+a[11]*b[10]+a[15]*b[11];e[12]=a[0]*b[12]+a[4]*b[13]+a[8]*b[14]+a[12]*
b[15];e[13]=a[1]*b[12]+a[5]*b[13]+a[9]*b[14]+a[13]*b[15];e[14]=a[2]*b[12]+a[6]*b[13]+a[10]*b[14]+a[14]*b[15];e[15]=a[3]*b[12]+a[7]*b[13]+a[11]*b[14]+a[15]*b[15];return e},vec4_multiply:function(a,b,e){e===r&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];e[3]=b[3]*a[0]+b[7]*a[1]+b[11]*a[2]+b[15]*a[3];return e},vec3_multiply:function(a,b,e){e===r&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12];e[1]=
b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14];return e},perspective:function(a,b,e,d){a=Math.tan(a*Math.PI/360);return[1/(a*b),0,0,0,0,1/a,0,0,0,0,-(d+e)/(d-e),-1,0,0,-(2*d*e)/(d-e),0]},ortho:function(a,b,e,d,f,h){return[2/(b-a),0,0,0,0,2/(d-e),0,0,0,0,-2/(h-f),0,-(a+b)/(b-a),-(d+e)/(d-e),-(h+f)/(h-f),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*a[14]-a[10]*
a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var b=[],e=a[0],d=a[1],f=a[2],h=a[4],m=a[5],q=a[6],c=a[8],s=a[9],a=a[10],g=a*m-q*s,v=-a*h+q*c,H=s*h-m*c,n=e*g+d*v+f*H;if(!n)return null;n=1/n;b[0]=g*n;b[1]=(-a*d+f*s)*n;b[2]=(q*d-f*m)*n;b[3]=
v*n;b[4]=(a*e-f*c)*n;b[5]=(-q*e+f*h)*n;b[6]=H*n;b[7]=(-s*e+d*c)*n;b[8]=(m*e-d*h)*n;return b},inverse:function(a,b){var e=a[0]*a[5]-a[1]*a[4],d=a[0]*a[6]-a[2]*a[4],f=a[0]*a[7]-a[3]*a[4],h=a[1]*a[6]-a[2]*a[5],m=a[1]*a[7]-a[3]*a[5],q=a[2]*a[7]-a[3]*a[6],c=a[8]*a[13]-a[9]*a[12],s=a[8]*a[14]-a[10]*a[12],g=a[8]*a[15]-a[11]*a[12],v=a[9]*a[14]-a[10]*a[13],H=a[9]*a[15]-a[11]*a[13],n=a[10]*a[15]-a[11]*a[14],o=e*n-d*H+f*v+h*g-m*s+q*c;return 0!==o?(b===r&&(b=[]),b[0]=0+a[5]*n-a[6]*H+a[7]*v,b[4]=0-a[4]*n+a[6]*
g-a[7]*s,b[8]=0+a[4]*H-a[5]*g+a[7]*c,b[12]=0-a[4]*v+a[5]*s-a[6]*c,b[1]=0-a[1]*n+a[2]*H-a[3]*v,b[5]=0+a[0]*n-a[2]*g+a[3]*s,b[9]=0-a[0]*H+a[1]*g-a[3]*c,b[13]=0+a[0]*v-a[1]*s+a[2]*c,b[2]=0+a[13]*q-a[14]*m+a[15]*h,b[6]=0-a[12]*q+a[14]*f-a[15]*d,b[10]=0+a[12]*m-a[13]*f+a[15]*e,b[14]=0-a[12]*h+a[13]*d-a[14]*e,b[3]=0-a[9]*q+a[10]*m-a[11]*h,b[7]=0+a[8]*q-a[10]*f+a[11]*d,b[11]=0-a[8]*m+a[9]*f-a[11]*e,b[15]=0+a[8]*h-a[9]*d+a[10]*e,e=1/o,b[0]*=e,b[1]*=e,b[2]*=e,b[3]*=e,b[4]*=e,b[5]*=e,b[6]*=e,b[7]*=e,b[8]*=
e,b[9]*=e,b[10]*=e,b[11]*=e,b[12]*=e,b[13]*=e,b[14]*=e,b[15]*=e,b):null},identity:function(a){if(a==r)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,b,e,d){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,b,e,1];if(d===r)return a;g.multiply(d.slice(0),a,d)},rotateAxis:function(a,b,e,d,f){var h=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),b=[a+b*b*(1-a),b*e*(1-a)-d*h,b*d*(1-a)+
e*h,0,e*b*(1-a)+d*h,a+e*e*(1-a),e*d*(1-a)-b*h,0,d*b*(1-a)-e*h,d*e*(1-a)+b*h,a+d*d*(1-a),0,0,0,0,1];if(f===r)return b;g.multiply(f.slice(0),b,f)},rotate:function(a,b,e,d){var f;d===r&&(d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);0!==e&&(f=Math.sin(e*(Math.PI/180)),e=Math.cos(e*(Math.PI/180)),g.multiply(d.slice(0),[e,f,0,0,-f,e,0,0,0,0,1,0,0,0,0,1],d));0!==b&&(f=Math.sin(b*(Math.PI/180)),e=Math.cos(b*(Math.PI/180)),g.multiply(d.slice(0),[e,0,-f,0,0,1,0,0,f,0,e,0,0,0,0,1],d));0!==a&&(f=Math.sin(a*(Math.PI/
180)),e=Math.cos(a*(Math.PI/180)),g.multiply(d.slice(0),[1,0,0,0,0,e,f,0,0,-f,e,0,0,0,0,1],d));return d},scale:function(a,b,e,d){if(d===r)return[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1];g.multiply(d.slice(0),[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1],d)},transform:function(a,b,e){var d=g.identity();a&&g.translate(a[0],a[1],a[2],d);b&&(0===b[0]&&0===b[1]&&0===b[2]||g.rotate(b[0],b[1],b[2],d));e&&(1===e[0]&&1===e[1]&&1===e[2]||g.scale(e[0],e[1],e[2],d));return d}};z.prototype={setIdentity:function(){this.m_stack[this.c_stack]=
[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=0;this.result=null;return this},getResult:function(){var a=CubicVR.mat4;if(!this.c_stack)return this.m_stack[0];var b=n;if(this.valid>this.c_stack-1)this.valid=this.c_stack-1;for(var e=this.valid;e<this.c_stack+1;e++)b=a.multiply(b,this.m_stack[e]),this.m_cache[e]=b;this.valid=this.c_stack-1;return this.result=
this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:n;return this},popMatrix:function(){if(0!==this.c_stack)return this.c_stack--,this},clearStack:function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==r?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,b,e){var d=CubicVR.mat4;if("object"===typeof a)return this.translate(a[0],a[1],a[2]);var f=this.getIdentity();f[12]=a;f[13]=b;f[14]=e;this.m_stack[this.c_stack]=
d.multiply(this.m_stack[this.c_stack],f);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,b,e){var d=CubicVR.mat4;if("object"===typeof a)return this.scale(a[0],a[1],a[2]);var f=this.getIdentity();f[0]=a;f[5]=b;f[10]=e;this.m_stack[this.c_stack]=d.multiply(this.m_stack[this.c_stack],f);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,b,e,d){var f=CubicVR.mat4;if("object"===typeof a)return this.rotate(a[0],1,0,0),this.rotate(a[1],
0,1,0),this.rotate(a[2],0,0,1),this;var h,m;if(b||e||d)h=Math.sin(-a*(Math.PI/180)),m=Math.cos(-a*(Math.PI/180));b&&(a=this.getIdentity(),a[5]=m*b,a[9]=h*b,a[6]=-h*b,a[10]=m*b,this.m_stack[this.c_stack]=f.multiply(a,this.m_stack[this.c_stack]));e&&(b=this.getIdentity(),b[0]=m*e,b[8]=-h*e,b[2]=h*e,b[10]=m*e,this.m_stack[this.c_stack]=f.multiply(b,this.m_stack[this.c_stack]));d&&(e=this.getIdentity(),e[0]=m*d,e[4]=h*d,e[1]=-h*d,e[5]=m*d,this.m_stack[this.c_stack]=f.multiply(e,this.m_stack[this.c_stack]));
this.valid===this.c_stack&&this.c_stack&&this.valid--;return this}};t.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var b=1+a[0]+a[5]+a[10],e,d,f;1.0E-8<b?(e=2*Math.sqrt(b),b=(a[9]-a[6])/e,d=(a[2]-a[8])/e,f=(a[4]-a[1])/e,a=0.25*e):a[0]>a[5]&&a[0]>a[10]?(e=2*Math.sqrt(1+a[0]-a[5]-a[10]),b=0.25*e,d=(a[4]+a[1])/e,f=(a[2]+a[8])/e,
a=(a[9]-a[6])/e):a[5]>a[10]?(e=2*Math.sqrt(1+a[5]-a[0]-a[10]),b=(a[4]+a[1])/e,d=0.25*e,f=(a[9]+a[6])/e,a=(a[2]-a[8])/e):(e=2*Math.sqrt(1+a[10]-a[0]-a[5]),b=(a[2]+a[8])/e,d=(a[9]+a[6])/e,f=0.25*e,a=(a[4]-a[1])/e);this.x=b;this.y=d;this.z=f;this.w=a},fromEuler:function(a,b,e){var d=Math.cos(Math.PI/180*b/2),b=Math.sin(Math.PI/180*b/2),f=Math.cos(Math.PI/180*e/2),e=Math.sin(Math.PI/180*e/2),h=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),m=d*f,q=b*e;this.w=m*h-q*a;this.x=m*a+q*h;this.y=b*f*h+
d*e*a;this.z=d*e*h-b*f*a},toEuler:function(){var a=this.w*this.w,b=this.x*this.x,e=this.y*this.y,d=this.z*this.z,f=180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-b-e+d+a),h=180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),a=180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),b-e-d+a);return[f,h,a]},multiply:function(a,b){b===r&&(b=a,a=this);return new t(a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,a.y*b.w+a.w*b.y+a.z*b.x-a.x*b.z,a.z*b.w+a.w*b.z+a.x*b.y-a.y*b.x,a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z)}};
return{vec2:{equal:function(a,b,e){e===r&&(e=1.0E-8);return a===r&&b===r?!0:a===r||b===r?!1:Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e}},vec3:c,mat3:{transpose_inline:function(a){var b=a[1],e=a[2],d=a[5];a[1]=a[3];a[2]=a[6];a[3]=b;a[5]=a[7];a[6]=e;a[7]=d},vec3_multiply:function(a,b,e){e===r&&(e=[]);e[0]=b[0]*a[0]+b[3]*a[1]+b[6]*a[2];e[1]=b[1]*a[0]+b[4]*a[1]+b[7]*a[2];e[2]=b[2]*a[0]+b[5]*a[1]+b[8]*a[2];return e}},mat4:g,aabb:{engulf:function(a,b){a[0][0]>b[0]&&(a[0][0]=b[0]);a[0][1]>b[1]&&(a[0][1]=
b[1]);a[0][2]>b[2]&&(a[0][2]=b[2]);a[1][0]<b[0]&&(a[1][0]=b[0]);a[1][1]<b[1]&&(a[1][1]=b[1]);a[1][2]<b[2]&&(a[1][2]=b[2])},reset:function(a,b){void 0===b&&(b=[0,0,0]);a[0][0]=b[0];a[0][1]=b[1];a[0][2]=b[2];a[1][0]=b[0];a[1][1]=b[1];a[1][2]=b[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,b){var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3];return 0>
e?-1:0<e?1:0},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=b;a[1]/=b;a[2]/=b;a[3]/=b}},sphere:{intersects:function(a,b){var e=CubicVR.vec3.subtract([a[0],a[1],a[2]],[b[0],b[1],b[2]]),e=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),d=a[3]+b[3];return e*e<d*d?!0:!1}},triangle:{normal:function(a,b,e,d){d===r&&(d=[]);var f=a[0]-b[0],h=a[1]-b[1],a=a[2]-b[2],m=b[0]-e[0],q=b[1]-e[1],b=b[2]-e[2];d[0]=h*b-a*q;d[1]=a*m-f*b;d[2]=f*q-h*m;return d}},Transform:z,Quaternion:t}});
CubicVR.RegisterModule("Utility",function(w){var z=w.undef,t=w.log,r={},n={},o={multiSplit:function(c,g){for(var a=c.split(g[0]),b=1,e=g.length;b<e;b++)for(var d=g[b],f=0,h=a.length;f<h;f++){var m=a[f].trim().split(d),q=!0;if(1<m.length)for(var y=0;y<m.length;y++)""!==m[y].trim()&&(a.splice(f+y,0===y?1:0,m[y]),y&&h++,q=!1);else a[f]=a[f].trim().replace(d,""),""!==a[f]&&(q=!1);q&&(a.splice(f,1),h--,f--)}return a},getJSONScriptObj:function(c,g){if("string"===typeof c&&0<c.length&&"#"===c.charAt(0)){var a=
document.getElementById(c.substr(1));if(a)return a=JSON.parse(a.innerHTML||a.text),g&&g(a),a}return c},getScriptContents:function(c){var g=document.getElementById(c),a="",b="";if(g){if(""!==g.src||g.attributes.srcUrl!==z)b=""!==g.src?g.src:g.attributes.srcUrl.value}else b=c;if(0!==b.length){if(c=new XMLHttpRequest,c.open("GET",b,!1),c.send(null),200===c.status||0===c.status)a=c.responseText}else for(b=g.firstChild;b;)3===b.nodeType&&(a+=b.textContent),b=b.nextSibling;return a},xmlNeedsBadgerFish:function(c){for(c=
[c];c.length;){var g=c.pop();if(g.attributes&&g.attributes.length)return!0;for(var a=0,b=g.childNodes.length;a<b;a++)c.push(g.childNodes[a])}return!1},getFirstEntry:function(c){for(var g in c)if(c.hasOwnProperty(g))return c[g]},getURIFileType:function(c){function g(a){for(var b in e)if(e.hasOwnProperty(b)&&-1!==e[b].indexOf(a))return b;return z}var a=c.toLowerCase(),b=["_ext","ext"],e={json:["js","javascript","json"],xml:["xml"]};if(-1!==a.indexOf("?")){var d=a.split("?"),a=d[0];if(d[1])for(var d=
-1===d[1].indexOf("&")?[d[1]]:d[1].split("&"),f=0,h=d.length;f<h;f++){var m=d[f];if(-1!==m.indexOf("=")&&(m=m.split("="),-1!==b.indexOf(m[0]))){var q=g(m[1]);if(q)return q;t("Unable to determine extension type '"+m[1]+"' provided for URI: ["+c+"], falling back to filename part.")}}}return-1!==a.indexOf(".")?(c=a.split("."),g(c[c.length-1])):z},get:function(c,g){var a=null,b=null,e=null,g=g||null;if(c===z)return z;if(isFinite(c))return c;"function"===typeof c&&(c=c(g));if("object"===typeof c)return g&&
!(c instanceof g)?new g(c):c;if("string"==typeof c){if(-1!==c.indexOf("\n"))return c;"#"==c[0]&&(a=c.substr(1),(e=document.getElementById(a))&&(b=e.src||null));!e&&!a&&!b&&c&&(b=c)}if(e&&!b)return CubicVR.util.collectTextNode(e);if(b){var a=null,d=n[b]||null;if(!d){var f=o.getURIFileType(b);if(f===z&&!e)return b;"json"===f?d=CubicVR.util.getJSON(b):a="xml"===f?CubicVR.util.getXML(b):CubicVR.util.getURL(b);a&&a.childNodes?d=o.getFirstEntry(o.xml2json(a)):a&&(d=a)}d&&n[b]===z&&(n[b]=d);if(g){if(r[b]&&
r[b]instanceof g)return r[b];if(d)return r[b]=new g(d),r[b]}else if(d)return d;return b}a&&!e&&console.log("Unable to retrieve requested ID: '"+c+"'");return z},clearCache:function(){r={};n={}},getURL:function(c){try{var g=new XMLHttpRequest;g.open("GET",c,!1);g.send(null);if(200===g.status||0===g.status){if(g.responseText.length)return g.responseText;if(g.responseXML)return g.responseXML}}catch(a){alert(c+" failed to load.")}return null},getXML:function(c){try{var g=new XMLHttpRequest;g.open("GET",
c,!1);g.overrideMimeType("application/xml");g.send(null);if(200===g.status||0===g.status)return g.responseXML}catch(a){try{alert(c+" failed to load.")}catch(b){throw a;}}return null},getJSON:function(c){try{var g=new XMLHttpRequest;g.open("GET",c,!1);g.overrideMimeType("application/json");g.send(null);if(200===g.status||0===g.status)return eval("("+g.responseText+")")}catch(a){try{alert(c+" failed to load.")}catch(b){throw a;}}return null},repackArray:function(c,g,a){c.length!==parseInt(g,10)*parseInt(a,
10)&&t("array repack error, data size !== stride*count: data.length="+c.length+" stride="+g+" count="+a);for(var a=[],b=0,e=0,d=c.length;e<d;e++){var f=e%g;0===f&&(a[b]=[]);a[b][f]=c[e];f===g-1&&b++}return a},collectTextNode:function(c){if(!c)return"";for(var g="",c=c.childNodes,a=0,b=c.length;a<b;a++)g+=c[a].nodeValue;return g},floatDelimArray:function(c,g){for(var a=c.split(g?g:","),b=0,e=a.length;b<e;b++)a[b]=parseFloat(a[b]);a[a.length-1]!==a[a.length-1]&&a.pop();return a},intDelimArray:function(c,
g){for(var a=c.split(g?g:","),b=0,e=a.length;b<e;b++)a[b]=parseInt(a[b],10);a[a.length-1]!==a[a.length-1]&&a.pop();return a},textDelimArray:function(c,g){for(var a=c.split(g?g:","),b=0,e=a.length;b<e;b++)a[b]=a[b];return a},xmlstring2json:function(c){for(var c=c.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,a,b=[],e=[],d={},f=d,h=0,m=c.length;h<m;h++){var q=c[h];if(!(g.test(q)||""===q)&&!/<\?\s?xml[^>]*>/.test(q))if(/<.*?>/.test(q)){a=q.split(/<([^>]*?)(.*)?>/g)[2];
if("/"!==a[0]&&(q=a.split(" "),a=q[0],q=q.slice(1).join(" "),b.push(a),e.push(d),d[a]&&!(d[a]instanceof Array)?d[a]=[d[a]]:(d[a]||(d[a]={}),d=d[a]),d instanceof Array&&(d.push({}),d=d[d.length-1]),"/"===a.substr(a.length-1)||"/"===q.substr(q.length-1)))a="/"+a;if("/"===a[0]){a=a.substr(1);if(b.length&&b[b.length-1]!==a)return console.log("Unmatched tag, aborting: "+a),!1;b.pop();d=e.length?e[e.length-1]:null;e.pop()}}else{var y=e[e.length-1][a];y instanceof Array?(y.pop(),y.push(o.parseNumeric(q))):
e[e.length-1][a]=o.parseNumeric(q)}}return f},xmlstring2badgerfish:function(c){for(var c=c.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,a,b=[],e=[],d={},f=d,h=0,m=c.length;h<m;h++)if(a=c[h],!(g.test(a)||""===a)&&!/<\?\s?xml[^>]*>/.test(a))if(/<.*?>/.test(a)){a=a.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==a[0]){var q=a.split(" ");a=q[0];q=q.slice(1).join(" ");b.push(a);e.push(d);d[a]&&!(d[a]instanceof Array)?d[a]=[d[a]]:d[a]||(d[a]={});d=d[a];d instanceof Array&&
(d.push({}),d=d[d.length-1]);if("/"===a.substr(a.length-1)||"/"===q.substr(q.length-1))a="/"+a;for(var q=o.multiSplit(q,"= "),y="",s=0;s<q.length;s++){var A=q[s];"/"===A[A.length-1]&&(A=A.substr(0,A.length-1));if(1===s%2){if("'"===A[0]||'"'===A[0]){for(var v=A[0],A=A.substr(1);A[A.length-1]!==v&&q.length+1<s;)A+=q.splice(s+1,1);A[A.length-1]===v&&(A=A.substr(0,A.length-1))}d["@"+y]=A}else y=A}}if("/"===a[0]){a=a.substr(1);if(b.length&&b[b.length-1]!==a)return console.log("Unmatched tag, aborting: "+
b[b.length-1]),!1;b.pop();d=e.length?e[e.length-1]:null;e.pop()}}else d.$=a;return f},xml2badgerfish:function(c){var g={},a=[],b,e,d,f,h,m=/^\s+|\s+$/g;c.jsonParent=g;for(a.push(c);a.length;){e=a.pop();var q=null;d=e.jsonParent;for(c=0,b=e.childNodes.length;c<b;c++)f=e.childNodes[c],h=f.tagName,h!==z&&(q=q||{},q[h]=q[h]||0,q[h]++);if(e.attributes&&e.attributes.length)for(c=0,b=e.attributes.length;c<b;c++)f=e.attributes[c],d["@"+f.name]=f.value;for(c=0,b=e.childNodes.length;c<b;c++)if(f=e.childNodes[c],
h=f.tagName,1===f.nodeType)1<q[h]?(d[h]=d[h]||[],d[h].push({}),f.jsonParent=d[h][d[h].length-1]):(d[h]=d[h]||{},f.jsonParent=d[h]),a.push(f);else if(3===f.nodeType&&""!==f.nodeValue.replace(m,""))d.$=d.$||"",d.$+=f.nodeValue}return g},isTextNode:function(c){for(var c=c.childNodes,g=0,a=c.length;g<a;g++)if(3!==c[g].nodeType||c[g].childNodes.length)return!1;return!0},parseNumeric:function(c){var g=null,a,g=c.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\n/g," ").replace(/ *, */gm,",").replace(/\s+/g,
" ");if(""===g)return g;if((-1!==g.indexOf(" ")||-1!==g.indexOf(","))&&/[0-9\.,e\-\+ ]+/g.test(g))if(/[^0-9\-\+]+/g.test(g))if(/[^0-9\- ]+/g.test(g))if(/[^0-9\-,]+/g.test(g))if(/[^0-9\.e\-\+ ]+/g.test(g))if(/[^0-9\.,e\+\-]+/g.test(g))if(/[^0-9,\-\+ ]+/g.test(g)){if(!/[^0-9\.,e\-\+ ]+/g.test(g)){g=g.split(" ");for(c=0,a=g.length;c<a;c++)g[c]=o.floatDelimArray(g[c],",");return g}}else{g=g.split(" ");for(c=0,a=g.length;c<a;c++)g[c]=o.intDelimArray(g[c],",");return g}else return o.floatDelimArray(g,",");
else return o.floatDelimArray(g," ");else return o.intDelimArray(g,",");else return o.intDelimArray(g," ");else return parseInt(g,10);a=parseFloat(g);return!isNaN(a)?/[^0-9\-\+]+/g.test(g)?a:parseInt(g,10):c},xml2json:function(c){var g={},a=[],b,e,d,f,h;c.jsonParent=g;for(a.push(c);a.length;){e=a.pop();var m=null;d=e.jsonParent;for(c=0,b=e.childNodes.length;c<b;c++)f=e.childNodes[c],h=f.tagName,h!==z&&(m=m||{},m[h]=m[h]||0,m[h]++);for(c=0,b=e.childNodes.length;c<b;c++){f=e.childNodes[c];h=f.tagName;
var q=o.isTextNode(f);if(1===f.nodeType)1<m[h]?(d[h]=d[h]||[],q?d[h].push(o.parseNumeric(o.collectTextNode(f))):(d[h].push({}),f.jsonParent=d[h][d[h].length-1])):q?d[h]=o.parseNumeric(o.collectTextNode(f)):(d[h]=d[h]||{},f.jsonParent=d[h]),q||a.push(f)}}return g}};return{util:o,get:o.get,clearCache:o.clearCache}});
CubicVR.RegisterModule("COLLADA",function(w){function z(g,a){function b(a){return!a.color?!1:(a=a.color)?d.floatDelimArray(a.$," "):!1}function e(a){var I;return!a["float"]?!1:(I=(a=a["float"])?parseFloat(a.$):0,a=I)}var d=CubicVR.util;new CubicVR.Mesh;new CubicVR.Scene;var f,h,m,q,y,s;s="object"==typeof g?g:-1!=g.indexOf(".js")?d.getJSON(g):CubicVR.util.xml2badgerfish(d.getXML(g));var A,v,H,n,E,u,x,B,C,D,w,z,F,G,L,O,N,Y,ca,U,na,Q=s;s=null;if(!Q.COLLADA)throw Error(g+" does not appear to be a valid COLLADA file.");
var Q=Q.COLLADA,M={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(Q.asset){var La=Q.asset.up_axis.$;if("X_UP"===La)M.up_axis=0;else if("Y_UP"===La)M.up_axis=1;else if("Z_UP"===La)M.up_axis=2}var gb=M.up_axis;if(Q.library_images){if(Q.library_images.image&&!Q.library_images.image.length)Q.library_images.image=[Q.library_images.image];if(Q.library_images.image.length)for(var hb=Q.library_images.image,Ma=0,pb=hb.length;Ma<pb;Ma++){var Na=hb[Ma],
ib=Na["@id"],Gc=Na["@name"],$b=Na.init_from;if($b.$){var ra=$b.$;a!==t&&-1!==ra.lastIndexOf("/")&&(ra=ra.substr(ra.lastIndexOf("/")+1));a!==t&&-1!==ra.lastIndexOf("\\")&&(ra=ra.substr(ra.lastIndexOf("\\")+1));M.images[ib]={source:ra,id:ib,name:Gc}}}}var jb,qb,ac,V,Oa,ka,Pa,da,P,W,S,Da,ga,Qa,Ra,Z,aa;if(Q.library_effects){var Sa=Q.library_effects.effect;Sa&&!Sa.length&&(Sa=[Sa]);for(qb=0,ac=Sa.length;qb<ac;qb++){var Cb=Sa[qb];jb=Cb["@id"];var T={};T.id=jb;T.surfaces=[];T.samplers=[];(da=Cb.profile_COMMON.newparam)&&
!da.length&&(da=[da]);if(da)for(Y=0,ca=da.length;Y<ca;Y++){var sa=da[Y],Ta=sa["@sid"];if(sa.surface){T.surfaces[Ta]={};var bc=sa.surface.init_from.$;if("object"===typeof M.images[bc])T.surfaces[Ta].source=a+"/"+M.images[bc].source}else if(sa.sampler2D){T.samplers[Ta]={};T.samplers[Ta].source=sa.sampler2D.source.$;if(sa.sampler2D.minfilter)T.samplers[Ta].minfilter=sa.sampler2D.minfilter.$;if(sa.sampler2D.magfilter)T.samplers[Ta].magfiter=sa.sampler2D.magfilter.$}}var va=Cb.profile_COMMON.technique;
va&&!va.length&&(va=[va]);T.material={textures_ref:[]};for(V=0,Oa=va.length;V<Oa;V++){f=va[V].blinn;if(!f)f=va[V].phong;if(!f)f=va[V].lambert;if(f)for(var ea in f){var rb=f[ea],ta=b(rb),cc=e(rb),Db;Db=rb.texture?rb.texture["@texture"]:!1;!1!==ta&&3<ta.length&&ta.pop();if("emission"==ea){if(!1!==ta)T.material.ambient=ta}else if("ambient"!=ea)if("diffuse"==ea){if(!1!==ta)T.material.color=ta}else if("specular"==ea){if(!1!==ta)T.material.specular=ta}else if("shininess"==ea&&!1!==cc)T.material.shininess=
cc;if(!1!==Db){var Ua=T.surfaces[T.samplers[Db].source].source;"emission"==ea?T.material.textures_ref.push({image:Ua,type:r.texture.map.AMBIENT}):"ambient"==ea?T.material.textures_ref.push({image:Ua,type:r.texture.map.AMBIENT}):"diffuse"==ea?T.material.textures_ref.push({image:Ua,type:r.texture.map.COLOR}):"specular"==ea?T.material.textures_ref.push({image:Ua,type:r.texture.map.SPECULAR}):"shininess"!=ea&&("reflective"==ea?T.material.textures_ref.push({image:Ua,type:r.texture.map.REFLECT}):"reflectivity"!=
ea&&"transparent"==ea&&T.material.textures_ref.push({image:Ua,type:r.texture.map.ALPHA}))}}M.effects[jb]=T}}}var Eb=c.getAllOf(Q,"instance_geometry"),sb=[];if(Eb.length)for(u=0,B=Eb.length;u<B;u++){var dc=Eb[u],Fb=c.getAllOf(dc,"instance_material");if(Fb.length)for(U=0,na=Fb.length;U<na;U++){var ec=Fb[U],Hc=ec["@symbol"],Ic=ec["@target"].substr(1);sb[dc["@url"].substr(1)+":"+Hc]=Ic}}var Gb=Q.library_materials;if(Gb&&Gb.material){var Va=Gb.material;Va&&!Va.length&&(Va=[Va]);for(D=0,w=Va.length;D<w;D++){var Hb=
Va[D],Jc=Hb["@id"],Kc=Hb["@name"],fc=Hb.instance_effect;fc&&(jb=fc["@url"].substr(1),M.materials.push({id:Jc,name:Kc,mat:M.effects[jb].material}))}}var gc=Q.library_geometries,Wa;if(gc){var ua=gc.geometry;ua&&!ua.length&&(ua=[ua]);if(ua.length)for(var kb=0,Lc=ua.length;kb<Lc;kb++){var ma={id:t,points:[],parts:[]},Xa=ua[kb].mesh;if(Xa){Wa=ua[kb]["@id"];y=ua[kb]["@name"];var Ya=Xa.source;Ya&&!Ya.length&&(Ya=[Ya]);for(var R=[],Ib=0,Mc=Ya.length;Ib<Mc;Ib++){var tb=Ya[Ib];h=tb["@id"];var Nc=tb["@name"],
Jb=tb.float_array;Jb&&(R[h]={id:h,name:Nc,data:d.floatDelimArray(Jb.$?Jb.$:""," ")});var Kb=tb.technique_common.accessor;if(Kb&&(R[h].count=Kb["@count"]|0,R[h].stride=Kb["@stride"]|0,R[h].count))R[h].data=d.repackArray(R[h].data,R[h].stride,R[h].count)}var Lb=Xa.vertices,lb=null,Mb=null,Ea=null,Fa=null,Ga=null;if(Lb&&(Mb=Lb["@id"],(P=Lb.input)&&!P.length&&(P=[P]),P))for(ka=0,Pa=P.length;ka<Pa;ka++)W=P[ka],"POSITION"===W["@semantic"]&&(lb=W["@source"].substr(1));var oa=Xa.triangles;oa&&!oa.length&&
(oa=[oa]);if(oa)for(V=0,Oa=oa.length;V<Oa;V++){aa={material:0,faces:[],normals:[],texcoords:[],colors:[]};var Oc=parseInt(oa[V]["@count"],10);(P=oa[V].input)&&!P.length&&(P=[P]);S=[];if(P.length)for(ka=0,Pa=P.length;ka<Pa;ka++)W=P[ka],Z=parseInt(W["@offset"],10),q=W["@source"].substr(1),"VERTEX"===W["@semantic"]?(q===Mb&&(q=lb),S[Z]=0):"NORMAL"===W["@semantic"]?(Ea=q,R[Ea].count&&(S[Z]=1)):"TEXCOORD"===W["@semantic"]?(Ga=q,R[Ga].count&&(S[Z]=2)):"COLOR"===W["@semantic"]?(Fa=q,R[Fa].count&&(S[Z]=3)):
S[Z]=4;n=S.length;m=Wa+":"+oa[V]["@material"];null===m?aa.material=0:sb[m]===t?(o("missing material ["+m+"]@"+Wa+"?"),aa.material=0):aa.material=sb[m];var hc=oa[V].p,wa=[];hc&&(wa=d.intDelimArray(hc.$," "));if(wa.length&&(E=wa.length/S.length/3,E===Oc)){if(0===ma.points.length)ma.points=R[lb].data;Z=0;for(u=0,B=wa.length,C=S.length;u<B;u+=3*C){A=[];v=[];H=[];ha=[];for(U=0;U<3*C;U++){var ub=U%C;0===S[ub]?v.push(wa[u+U]):1===S[ub]?A.push(wa[u+U]):2===S[ub]?H.push(wa[u+U]):3===S[ub]&&ha.push(wa[u+U])}v.length&&
(aa.faces.push(v),3===A.length&&aa.normals.push([c.fixuaxis(M.up_axis,R[Ea].data[A[0]]),c.fixuaxis(M.up_axis,R[Ea].data[A[1]]),c.fixuaxis(M.up_axis,R[Ea].data[A[2]])]),3===H.length&&aa.texcoords.push([R[Ga].data[H[0]],R[Ga].data[H[1]],R[Ga].data[H[2]]]),3===ha.length&&aa.colors.push([R[Fa].data[ha[0]],R[Fa].data[ha[1]],R[Fa].data[ha[2]]]))}}ma.parts.push(aa)}var ia=Xa.polylist;if(!ia)ia=Xa.polygons;ia&&!ia.length&&(ia=[ia]);if(ia)for(V=0,Oa=ia.length;V<Oa;V++){aa={material:0,faces:[],normals:[],texcoords:[],
colors:[]};var ic=parseInt(ia[V]["@count"],10);(P=ia[V].input)&&!P.length&&(P=[P]);S=[];if(P.length)for(ka=0,Pa=P.length;ka<Pa;ka++){W=P[ka];var Nb=W["@offset"];null===Nb&&(Nb=W["@idx"]);Z=parseInt(Nb,10);q=W["@source"].substr(1);"VERTEX"===W["@semantic"]?(q===Mb&&(q=lb),S[Z]=0):"NORMAL"===W["@semantic"]?(Ea=q,S[Z]=1):"TEXCOORD"===W["@semantic"]?(Ga=q,S[Z]=2):"COLOR"===W["@semantic"]?(Fa=q,S[Z]=3):S[Z]=4}var jc=ia[V].vcount,Za=[];jc&&(Za=d.intDelimArray(jc.$," "));m=Wa+":"+ia[V]["@material"];aa.material=
m===t?0:sb[m];var mb=ia[V].p;n=S.length;var xa=[];if(1<mb.length&&!Za.length)for(Y=0,ca=mb.length;Y<ca;Y++){var kc=d.intDelimArray(mb[Y].$," ");Za[Y]=parseInt(kc.length/n,10);xa.splice(xa.length,0,kc)}else mb&&(xa=d.intDelimArray(mb.$," "));if(xa.length)if(E=Za.length,E!==ic)o("poly vcount data doesn't add up, skipping object load: "+E+" !== "+ic);else{if(0===ma.points.length)ma.points=R[lb].data;Z=0;for(u=0,B=Za.length;u<B;u++){A=[];v=[];H=[];ha=[];for(U=0,na=Za[u]*n;U<na;U++)0===S[U%n]?v.push(xa[Z]):
1===S[U%n]?A.push(xa[Z]):2===S[U%n]?H.push(xa[Z]):3===S[U%n]&&ha.push(xa[Z]),Z++;var $a;if(v.length){aa.faces.push(v);if(A.length){$=[];for(z=0,F=A.length;z<F;z++)$.push(c.fixuaxis(M.up_axis,R[Ea].data[A[z]]));aa.normals.push($)}if(H.length){$a=[];for(z=0,F=H.length;z<F;z++)$a.push(R[Ga].data[H[z]]);aa.texcoords.push($a)}if(ha.length){$a=[];for(z=0,F=ha.length;z<F;z++)$a.push(R[Fa].data[ha[z]]);aa.colors.push($a)}}}}ma.parts.push(aa)}if(1!==gb)for(u=0,B=ma.points.length;u<B;u++)ma.points[u]=c.fixuaxis(M.up_axis,
ma.points[u]);ma.id=Wa;M.meshes.push(ma)}}}var lc=Q.library_cameras;if(lc){(Qa=lc.camera)&&!Qa.length&&(Qa=[Qa]);for(G=0,L=Qa.length;G<L;G++){ga=Qa[G];var Pc=ga["@id"],vb=0,wb=0,xb=0;if(ga.optics&&ga.optics.technique_common&&ga.optics.technique_common.perspective)vb=ga.optics.technique_common.perspective.yfov,wb=ga.optics.technique_common.perspective.znear,xb=ga.optics.technique_common.perspective.zfar;var Ob,Pb,Qb;if(!vb&&!wb&&!xb){(da=ga.param)&&!da.length&&(da=[da]);for(u=0,B=da.length;u<B;u++){var Rb=
da[u].$,Sb=da[u]["@name"];"YFOV"==Sb?Ob=parseFloat(Rb):"ZNEAR"==Sb?Pb=parseFloat(Rb):"ZFAR"==Sb&&(Qb=parseFloat(Rb))}}else Ob=vb?parseFloat(vb.$):60,Pb=wb?parseFloat(wb.$):0.1,Qb=xb?parseFloat(xb.$):1E3;M.cameras.push({id:Pc,targeted:!1,fov:parseFloat(Ob),nearclip:parseFloat(Pb),farclip:parseFloat(Qb)})}}var mc=Q.library_lights,ab;if(mc){var Ha=mc.light;Ha&&!Ha.length&&(Ha=[Ha]);if(Ha)for(var Tb=0,Qc=Ha.length;Tb<Qc;Tb++){ab=Ha[Tb];var nc=ab.technique_common.point,yb=nc?nc:null,oc=ab["@id"];if(null!==
yb){var pc=yb.intensity,Rc=pc?parseFloat(pc.$):1,qc=yb.distance,Sc=qc?parseFloat(qc.$):10,rc=yb.color,ha=[1,1,1];rc&&(ha=d.floatDelimArray(rc.$," "));M.lights.push({id:oc,name:oc,type:r.light.type.POINT,method:r.light.method.STATIC,diffuse:ha,specular:[0,0,0],distance:Sc,intensity:Rc})}}}var sc=Q.library_visual_scenes;if(sc){var bb=null;(bb=sc.visual_scene)&&!bb.length&&(bb=[bb]);for(var Ub=0,Tc=bb.length;Ub<Tc;Ub++){Ra=bb[Ub];var ya={id:Ra["@id"],sceneObjects:[],cameras:[],lights:[],parentMap:[]},
pa=[],cb=[],za,Vb,la,ba,$,tc=Q.library_nodes;if(tc){var db=tc.node;db&&!db.length&&(db=[db]);pa=[];for(u=0,B=db.length;u<B;u++)Vb=db[u],mnodeId=Vb["@id"],pa[la]=Vb;for(za=[Ra];za.length;){ba=za.pop();if(ba.node&&(($=ba.node)&&!$.length&&($=[$]),$))for(u=0,B=$.length;u<B;u++)za.push($[u]);if(ba.instance_node){var eb=ba.instance_node;eb&&!eb.length&&(eb=[eb]);for(u=0,B=eb.length;u<B;u++){var Wb=eb[u]["@url"].substr(1);if(pa[Wb]){if(ba.node&&ba.node.length)ba.node=[ba.node];ba.node?ba.node.push(pa[Wb]):
ba.node=[pa[Wb]]}}}}}for(za=[Ra];za.length;)if(ba=za.pop(),ba.node&&(($=ba.node)&&!$.length&&($=[$]),$))for(u=0,B=$.length;u<B;u++)$[u].parentNode=ba,cb.push($[u]),za.push($[u]);if(cb.length)for(var nb=0,Uc=cb.length;nb<Uc;nb++){var Aa=cb[nb],Ba=Aa.instance_geometry;ab=cb[nb].instance_light;ga=cb[nb].instance_camera;la=Aa["@id"];var fa=Aa["@name"],ja=c.cl_getInitalTransform(M.up_axis,Aa);if(2===gb)ja.rotation=c.quaternionFilterZYYZ(ja.rotation,ga?[-90,0,0]:t);var ob=null,X=null,fb;if(Ba){Ba&&!Ba.length&&
(Ba=[Ba]);for(u=0,B=Ba.length;u<B;u++){y=Ba[u]["@url"].substr(1);X={};X.name=(fa?fa:la)+(u?u:"");X.id=(la?la:fa)+(u?u:"");X.meshId=Wa;X.meshName=y;if(!ob)X.position=ja.position,X.rotation=ja.rotation,X.scale=ja.scale,X.matrix=ja.matrix;ya.sceneObjects.push(X);pa[X.id]=!0;Aa.parentNode&&((fb=Aa.parentNode["@id"])&&pa[fb]?ya.parentMap.push({parent:fb,child:X.id}):1<Ba.length&&(ob?pa[ob.id]&&ya.parentMap.push({parent:ob.id,child:X.id}):(ob=X,X={})))}}else if(ga){var Vc=ga["@url"].substr(1);ya.cameras.push({name:fa?
fa:la,id:fa?fa:la,source:Vc,position:ja.position,rotation:ja.rotation})}else if(ab){var Wc=ab["@url"].substr(1);ya.lights.push({name:fa?fa:la,id:fa?fa:la,source:Wc,position:ja.position})}else X={position:ja.position,rotation:ja.rotation,scale:ja.scale,matrix:ja.matrix},X.name=fa?fa:la,X.id=la?la:fa,ya.sceneObjects.push(X),pa[X.id]=!0,Aa.parentNode&&(fb=Aa.parentNode["@id"])&&pa[fb]&&ya.parentMap.push({parent:fb,child:X.id})}M.scenes.push(ya)}}var uc=Q.library_animations,qa;if(uc){var Ia=uc.animation;
Ia&&!Ia.length&&(Ia=[Ia]);if(Ia)for(var Xb=0,Xc=Ia.length;Xb<Xc;Xb++){var zb=Ia[Xb];qa=zb["@id"];M.animations[qa]={};M.animations[qa].sources=[];var Ja=zb.source;Ja&&!Ja.length&&(Ja=[Ja]);if(Ja.length)for(O=0,N=Ja.length;O<N;O++){var Ca=Ja[O];h=Ca["@id"];var vc=Ca.technique_common,Ab=null,wc=null;Ca.name_array?Ab=d.textDelimArray(Ca.name_array.$," "):Ca.Name_array?Ab=d.textDelimArray(Ca.Name_array.$," "):Ca.float_array&&(wc=d.floatDelimArray(Ca.float_array.$," "));var Yb=0,xc="",Bb=1;if(vc){f=vc;
var Zb=f.accessor,Yb=parseInt(Zb["@count"],10),xc=Zb["@source"].substr(1),yc=Zb["@stride"];yc&&(Bb=parseInt(yc,10))}M.animations[qa].sources[h]={data:Ab?Ab:wc,count:Yb,source:xc,stride:Bb};if(1!==Bb)M.animations[qa].sources[h].data=d.repackArray(M.animations[qa].sources[h].data,Bb,Yb)}(Da=zb.sampler)&&!Da.length&&(Da=[Da]);if(Da){M.animations[qa].samplers=[];for(O=0,N=Da.length;O<N;O++){var zc=Da[O],Yc=zc["@id"];(P=zc.input)&&!P.length&&(P=[P]);if(P){var Ac=[];for(x=0,B=P.length;x<B;x++)W=P[x],Ac[W["@semantic"]]=
W["@source"].substr(1);M.animations[qa].samplers[Yc]=Ac}}}var Ka=zb.channel;Ka&&!Ka.length&&(Ka=[Ka]);if(Ka){M.animations[qa].channels=[];for(G=0,L=Ka.length;G<L;G++){var Bc=Ka[G],Zc=Bc["@source"].substr(1),Cc=Bc["@target"],Dc=Cc.split("/"),$c=Dc[0],Ec=Dc[1].split(".");M.animations[qa].channels.push({source:Zc,target:Cc,targetName:$c,paramName:Ec[0],typeName:Ec[1]})}}}}var Fc=Q.scene;if(Fc&&(Ra=Fc.instance_visual_scene)){var ad=Ra["@url"].substr(1);M.scene=ad}return M}var t=w.undef,r=CubicVR.enums,
n=w.GLCore,o=w.log,c={fixuaxis:function(c,a){if(0===c)return[a[1],a[0],a[2]];if(1===c)return a;if(2===c)return[a[0],a[2],-a[1]]},fixscaleaxis:function(c,a){if(0===c)return[a[1],a[0],a[2]];if(1===c)return a;if(2===c)return[a[0],a[2],a[1]]},fixukaxis:function(c,a,b,e){return a===r.motion.POS&&b===r.motion.Z&&c===r.motion.Z?-e:e},getAllOf:function(c,a){for(var b=[c],e=[],d,f,h,m;b.length;)for(f in d=b.pop(),d)if(d.hasOwnProperty(f)){if(f===a)if(d[f].length)for(h=0,m=d[f].length;h<m;h++)e.push(d[f][h]);
else e.push(d[f]);if("object"==typeof d[f])if(d[f].length)for(h=0,m=d[f].length;h<m;h++)b.push(d[f][h]);else b.push(d[f])}return e},quaternionFilterZYYZ:function(c,a){var b=CubicVR.vec3,e=c,d=new CubicVR.Quaternion;a!==t&&(e=b.add(c,a));d.fromEuler(e[0],e[2],-e[1]);return d.toEuler()},cl_getInitalTransform:function(g,a){var b=CubicVR.util,e={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},d=a.translate,f=a.rotate,h=a.scale;if(a.matrix&&!d&&!f&&!h)return e;if(d)e.position=c.fixuaxis(g,b.floatDelimArray(d.$,
" "));if(f)for(var d=0,m=f.length;d<m;d++){var q=f[d],y=q["@sid"],q=b.floatDelimArray(q.$," ");if("rotateX"==y||"rotationX"==y)e.rotation[0]=q[3];else if("rotateY"==y||"rotationY"==y)e.rotation[1]=q[3];else if("rotateZ"==y||"rotationZ"==y)e.rotation[2]=q[3]}if(h)e.scale=c.fixscaleaxis(g,b.floatDelimArray(h.$," "));return e}};return{loadCollada:function(g,a,b){var a=z(g,a,b),e=a.up_axis,d=[],f,h,m,q,y,s,A,v;for(h=0,m=a.materials.length;h<m;h++){y=a.materials[h];A=new CubicVR.Material(y.mat);for(s=
0,q=y.mat.textures_ref.length;s<q;s++){v=y.mat.textures_ref[s];var H=null,H=void 0===w.Textures_ref[v.image]?new CubicVR.Texture(v.image,n.default_filter,b,g):w.Textures_obj[w.Textures_ref[v.image]];A.setTexture(H,v.type)}d[y.id]=A}s=[];for(h=0,m=a.meshes.length;h<m;h++){var H=a.meshes[h],o=new CubicVR.Mesh({name:H.id});o.points=H.points;var E=!1;for(A=0,v=H.parts.length;A<v;A++){var u=H.parts[A];0!==u.material&&((q=d[u.material])||(q=new CubicVR.Material({name:u.material})),o.setFaceMaterial(q));
var x=u.normals.length?!0:!1,B=u.texcoords.length?!0:!1,C=u.colors.length?!0:!1;if(C)d[u.material].color_map=!0;for(q=0,y=u.faces.length;q<y;q++){var D=o.addFace(u.faces[q]);if(x)o.faces[D].point_normals=u.normals[q];if(B)o.faces[D].uvs=u.texcoords[q];if(C)o.faces[D].point_colors=u.colors[q]}E|=x}o.faces.length&&(b?b.addMesh(g,g+":"+meshId,o):(E||o.calcNormals(),o.triangulateQuads(),o.compile()),s[H.id]=o)}m=[];for(g=0,q=a.cameras.length;g<q;g++)m[a.cameras[g].id]=a.cameras[g];H=[];for(q=0,y=a.lights.length;q<
y;q++)H[a.lights[q].id]=a.lights[q];b={};d={};h={};g={};for(A=0,v=a.scenes.length;A<v;A++){o=a.scenes[A];E=new CubicVR.Scene;for(q=0,y=o.sceneObjects.length;q<y;q++)u=o.sceneObjects[q],x=new CubicVR.SceneObject(u),x.obj=(s[u.meshName]?s[u.meshName]:s[u.meshId])||null,u.matrix&&x.setMatrix(u.matrix),b[u.id]=x,E.bindSceneObject(x);for(q=0,y=o.lights.length;q<y;q++)u=o.lights[q],x=new CubicVR.Light(H[u.source]),x.position=u.position,d[u.id]=x,E.bindLight(x);if(o.cameras.length)q=o.cameras[0],y=new CubicVR.Camera(m[q.source]),
y.position=q.position,y.rotation=q.rotation,h[q.id]=y,E.camera=y;for(q=0,y=o.parentMap.length;q<y;q++)u=o.parentMap[q],b[u.parent].bindChild(b[u.child]);g[o.id]=E}for(var K in a.animations)if(a.animations.hasOwnProperty(K)&&(s=a.animations[K],s.channels.length))for(cCount=0,q=s.channels.length;cCount<q;cCount++){m=s.channels[cCount];u=s.samplers[m.source];y=s.sources[u.INPUT];A=s.sources[u.OUTPUT];v=s.sources[u.INTERPOLATION];var H=s.sources[u.IN_TANGENT],o=s.sources[u.OUT_TANGENT],E=u.IN_TANGENT!==
t,u=u.OUT_TANGENT!==t,x=null,C=b[m.targetName],B=h[m.targetName],I=d[m.targetName];if(C){if(null===C.motion)C.motion=new CubicVR.Motion;x=C.motion}else if(B){if(null===B.motion)B.motion=new CubicVR.Motion;x=B.motion}else if(I){if(null===I.motion)I.motion=new CubicVR.Motion;x=I.motion}if(null!==x){C=r.motion.POS;D=r.motion.X;if(2===e)x.yzflip=!0;f=m.paramName;if("rotateX"===f||"rotationX"===f)C=r.motion.ROT,D=r.motion.X;else if("rotateY"===f||"rotationY"===f)C=r.motion.ROT,D=r.motion.Y;else if("rotateZ"===
f||"rotationZ"===f)C=r.motion.ROT,D=r.motion.Z;else if("location"===f){C=r.motion.POS;if("X"===m.typeName)D=r.motion.X;if("Y"===m.typeName)D=r.motion.Y;if("Z"===m.typeName)D=r.motion.Z}else if("translate"===f){C=r.motion.POS;if("X"===m.typeName)D=r.motion.X;if("Y"===m.typeName)D=r.motion.Y;if("Z"===m.typeName)D=r.motion.Z}else if("LENS"===f)continue;else if("FOV"===f)C=r.motion.FOV,D=3;else if("ZNEAR"===f)C=r.motion.NEARCLIP,D=3;else if("ZFAR"===f)C=r.motion.FARCLIP,D=3;else if("intensity"===f)C=
r.motion.INTENSITY,D=3;if(I&&3>C)I.method=r.light.method.DYNAMIC;for(mCount=0,m=y.data.length;mCount<m;mCount++)if(k=null,"object"===typeof A.data[mCount])for(i=0,iMax=A.data[mCount].length;i<iMax;i++){if(I=i,2===e&&2===i?I=1:2===e&&1===i&&(I=2),k=x.setKey(C,I,y.data[mCount],c.fixukaxis(a.up_axis,C,I,A.data[mCount][i])),v)if(f=v.data[mCount][i],"LINEAR"===f)k.shape=r.envelope.shape.LINE;else if("BEZIER"===f)k.shape=!E&&!u?r.envelope.shape.LINEAR:r.envelope.shape.BEZI}else if(I=D,ofs=0,B&&C===r.motion.ROT&&
2===e&&0===I&&(ofs=-90),C===r.motion.ROT?k=x.setKey(C,I,y.data[mCount],A.data[mCount]+ofs):(2===e&&2===D?I=1:2===e&&1===D&&(I=2),k=x.setKey(C,I,y.data[mCount],c.fixukaxis(a.up_axis,C,I,A.data[mCount]))),v)if(f=v.data[mCount],"LINEAR"===f)k.shape=r.envelope.shape.LINE;else if("BEZIER"===f)if(!E&&!u)k.shape=r.envelope.shape.LINEAR,k.continutity=1;else{k.shape=r.envelope.shape.BEZ2;f=H.data[mCount][0];var F,G=o.data[mCount][0];C===r.motion.ROT?(F=H.data[mCount][1],I=o.data[mCount][1],k.param[0]=f-k.time,
k.param[1]=F-k.value+ofs,k.param[2]=G-k.time,k.param[3]=I-k.value+ofs):(F=c.fixukaxis(a.up_axis,C,I,H.data[mCount][1]),I=c.fixukaxis(a.up_axis,C,I,o.data[mCount][1]),k.param[0]=f-k.time,k.param[1]=F-k.value,k.param[2]=G-k.time,k.param[3]=I-k.value)}}}K=null;return K=a.scene?g[a.scene]:g.pop()},parseCollada:z}});
CubicVR.RegisterModule("CVRXML",function(w){function z(a,d,f,h){var m=CubicVR.util,q=null,c=null;h.triangles&&(c=m.intDelimArray(b.getTextNode(h,"triangles")," "));if(c&&(h.segments&&(q=m.intDelimArray(b.getTextNode(h,"segments")," ")),null===q&&(q=[0,parseInt(c.length/3,10)]),h=0,a.setFaceMaterial(d),c.length))for(p=0,pMax=q.length;p<pMax;p+=2){d=3*q[p+1];a.setSegment(q[p]);for(j=h,jMax=h+d;j<jMax;j+=3)m=a.addFace([c[j],c[j+1],c[j+2]]),f&&a.faces[m].setUV([f[j],f[j+1],f[j+2]]);h+=d}}function t(a){var d=
CubicVR.util,f=new CubicVR.UVMapper,h=null,m=null;if(a.type)switch(h=b.getTextNode(a,"type"),h){case "planar":f.projection_mode=g.uv.projection.PLANAR;break;case "cylindrical":f.projection_mode=g.uv.projection.CYLINDRICAL;break;case "spherical":f.projection_mode=g.uv.projection.SPHERICAL;break;case "cubic":f.projection_mode=g.uv.projection.CUBIC}if(!h)return null;"uv"===h&&a.uv&&(m=b.getPoints(a,"uv"));if(a.axis)switch(b.getTextNode(a,"axis")){case "x":f.projection_axis=g.uv.axis.X;break;case "y":f.projection_axis=
g.uv.axis.Y;break;case "z":f.projection_axis=g.uv.axis.Z}if(a.center)f.center=d.floatDelimArray(b.getTextNode(a,"center"));if(a.rotation)f.rotation=d.floatDelimArray(b.getTextNode(a,"rotation"));if(a.scale)f.scale=d.floatDelimArray(b.getTextNode(a,"scale"));if(a.wrap_w)f.wrap_w_count=parseFloat(b.getTextNode(a,"wrap_w"));if(a.wrap_h)f.wrap_h_count=parseFloat(b.getTextNode(a,"wrap_h"));return""!==h&&"uv"!==h?f:m}function r(e,d){if(a[e]!==c)return a[e];var f=CubicVR.util,h,m,q,y;h=null;h="object"==
typeof e?e:-1!=e.indexOf(".js")?f.getJSON(e):CubicVR.util.xml2badgerfish(f.getXML(e));if(h.root)h=h.root;if(h.properties)h=h.properties;f=new CubicVR.Mesh;h.points&&(q=b.getPoints(h,"points"))&&f.addPoint(q);var s=h.material;s&&!s.length&&(s=[s]);var A=[];if(s)for(h=0,q=s.length;h<q;h++){var v=s[h],n;n=v;var o=d,r=new CubicVR.Material({name:n.name?n.name.$:null});if(n.shininess)r.shininess=b.getFloatNode(n,"shininess",r.shininess)/100;r.opacity=b.getFloatNode(n,"alpha",r.opacity);r.max_smooth=b.getFloatNode(n,
"max_smooth",r.max_smooth);r.color=b.getFloatDelimNode(n,"color",r.color);r.ambient=b.getFloatDelimNode(n,"ambient",r.ambient);r.diffuse=b.getFloatDelimNode(n,"diffuse",r.diffuse);r.specular=b.getFloatDelimNode(n,"specular",r.specular);m=void 0;if(m=b.getTextNode(n,"texture"))m=(o?o:"")+m,tex=w.Textures_ref[m]!==c?w.Textures_obj[w.Textures_ref[m]]:new CubicVR.Texture(m),r.setTexture(tex,g.texture.map.COLOR);if(m=b.getTextNode(n,"texture_luminosity"))m=(o?o:"")+m,tex=w.Textures_ref[m]!==c?w.Textures_obj[w.Textures_ref[m]]:
new CubicVR.Texture(m),r.setTexture(tex,g.texture.map.AMBIENT);if(m=b.getTextNode(n,"texture_normal"))m=(o?o:"")+m,tex=w.Textures_ref[m]!==c?w.Textures_obj[w.Textures_ref[m]]:new CubicVR.Texture(m),r.setTexture(tex,g.texture.map.NORMAL);if(m=b.getTextNode(n,"texture_specular"))m=(o?o:"")+m,tex=w.Textures_ref[m]!==c?w.Textures_obj[w.Textures_ref[m]]:new CubicVR.Texture(m),r.setTexture(tex,g.texture.map.SPECULAR);if(m=b.getTextNode(n,"texture_bump"))m=(o?o:"")+m,tex=w.Textures_ref[m]!==c?w.Textures_obj[w.Textures_ref[m]]:
new CubicVR.Texture(m),r.setTexture(tex,g.texture.map.BUMP);if(m=b.getTextNode(n,"texture_envsphere"))m=(o?o:"")+m,tex=w.Textures_ref[m]!==c?w.Textures_obj[w.Textures_ref[m]]:new CubicVR.Texture(m),r.setTexture(tex,g.texture.map.ENVSPHERE);if(m=b.getTextNode(n,"texture_alpha"))m=(o?o:"")+m,tex=w.Textures_ref[m]!==c?w.Textures_obj[w.Textures_ref[m]]:new CubicVR.Texture(m),r.setTexture(tex,g.texture.map.ALPHA);n=r;var u=null;m=o=null;v.uvmapper&&((o=t(v.uvmapper))&&!o.length?A.push([o,n]):m=o);(r=v.part)&&
!r.length&&(r=[r]);if(r&&r.length){var x=null,B=null;for(m=0,y=r.length;m<y;m++){var C=r[m],x=null;if(u=C.uvmapper)if(x=t(u),v.triangles)B=u=f.faces.length,x&&!x.length?(z(f,n,null,C),B=f.faces.length-1,f.calcFaceNormals(u,B),x.apply(f,n,c,u,B)):x&&x.length?z(f,n,x,C):o&&!o.length&&(z(f,n,null,C),B=f.faces.length-1,f.calcFaceNormals(u,B),o.apply(f,n,c,u,B));if(C.procedural){(u=C.uvmapper)&&(x=t(u));var B=C.transform?b.getTransform(C.transform):c,u=c,C=C.procedural,D=b.getTextNode(C,"type");B&&(u=
new CubicVR.Transform,u.translate(B.position),u.pushMatrix(),u.rotate(B.rotation),u.pushMatrix(),u.scale(B.scale));o||(o=c);x={material:n,uvmapper:o||x};if("box"===D||"cube"===D)x.size=b.getFloatNode(C,"size"),f.booleanAdd(CubicVR.primitives.box(x),u);else if("sphere"===D)x.radius=b.getFloatNode(C,"radius"),x.lat=b.getIntNode(C,"lat"),x.lon=b.getIntNode(C,"lon"),f.booleanAdd(CubicVR.primitives.sphere(x),u);else if("cone"===D)x.base=b.getFloatNode(C,"base"),x.height=b.getFloatNode(C,"height"),x.lon=
b.getIntNode(C,"lon"),f.booleanAdd(CubicVR.primitives.cone(x),u);else if("plane"===D)x.size=b.getFloatNode(C,"size"),f.booleanAdd(CubicVR.primitives.plane(x),u);else if("cylinder"===D)x.radius=b.getFloatNode(C,"radius"),x.height=b.getFloatNode(C,"height"),x.lon=b.getIntNode(C,"lon"),f.booleanAdd(CubicVR.primitives.cylinder(x),u);else if("torus"===D)x.innerRadius=b.getFloatNode(C,"innerRadius"),x.outerRadius=b.getFloatNode(C,"outerRadius"),x.lat=b.getIntNode(C,"lat"),x.lon=b.getIntNode(C,"lon"),f.booleanAdd(CubicVR.primitives.torus(x),
u);else if("lathe"===D)x.points=b.getPoints(C,"p"),x.lon=b.getIntNode(C,"lon"),f.booleanAdd(CubicVR.primitives.lathe(x),u);else if("polygon"===D){B=b.getPoints(C,"p");B=new CubicVR.Polygon(B);(D=C.cut)&&!D.length&&(D=[D]);if(D.length)for(m=0,q=D.length;m<y;m++)B.cut(new CubicVR.Polygon(b.getPoints(D[m])));x.front=0;x.back=0;x.frontShift=0;x.backShift=0;x.frontDepth=0;x.backDepth=0;if(C.extrude){C=C.extrude;x.front=b.getFloatNode(C,"front",0);x.back=b.getFloatNode(C,"back",0);x.frontShift=b.getFloatNode(C,
"frontBevelShift",0);x.backShift=b.getFloatNode(C,"backBevelShift",0);x.frontDepth=b.getFloatNode(C,"frontBevelDepth",0);x.backDepth=b.getFloatNode(C,"backBevelDepth",0);x.depth=b.getFloatNode(C,"depth",0);x.shift=b.getFloatNode(C,"shift",0);x.bevel=b.getFloatNode(C,"bevel",0);if(x.depth&&!x.backDepth&&!x.frontDepth)x.front=-x.depth/2,x.back=x.depth/2;if(x.shift&&!x.backShift&&!x.frontShift)x.frontShift=x.shift,x.backShift=x.shift;if(x.bevel&&!x.backDepth&&!x.frontDepth)x.frontDepth=x.bevel,x.backDepth=
x.bevel}C=B.toExtrudedBeveledMesh(new CubicVR.Mesh,x);C.setFaceMaterial(x.material);f.booleanAdd(C,u)}}}}else z(f,n,m,v)}f.triangulateQuads();f.calcNormals();for(h=0,q=A.length;h<q;h++)A[h][0].apply(f,A[h][1]);f.compile();return a[e]=f}function n(a){return null===a?!1:a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function o(a,b,f){var h=CubicVR.util,m=[];m[0]=a.getElementsByTagName("x");m[1]=a.getElementsByTagName("y");
m[2]=a.getElementsByTagName("z");m[3]=a.getElementsByTagName("fov");var q,y,s,A,v,n;for(n in m)if(m.hasOwnProperty(n)&&m[n]!==c&&m[n].length){q=m[n][0].getElementsByTagName("time");y=m[n][0].getElementsByTagName("value");s=m[n][0].getElementsByTagName("in");A=m[n][0].getElementsByTagName("out");v=m[n][0].getElementsByTagName("tcb");var o=null,r=null,u=null,x=a=null;s.length&&(a=h.collectTextNode(s[0]));A.length&&(x=h.collectTextNode(A[0]));q.length&&(o=h.floatDelimArray(h.collectTextNode(q[0])," "));
y.length&&(r=h.floatDelimArray(h.collectTextNode(y[0])," "));v.length&&(u=h.floatDelimArray(h.collectTextNode(v[0])," "));if(null!==o&&null!==r){q=0;for(y=o.length;q<y;q++)if(s=f.setKey(b,n,o[q],r[q]),u)s.tension=u[3*q],s.continuity=u[3*q+1],s.bias=u[3*q+2]}r=o=g.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":o=g.envelope.behavior.RESET;break;case "constant":o=g.envelope.behavior.CONSTANT;break;case "repeat":o=g.envelope.behavior.REPEAT;break;case "oscillate":o=g.envelope.behavior.OSCILLATE;
break;case "offset":o=g.envelope.behavior.OFFSET;break;case "linear":o=g.envelope.behavior.LINEAR}if(x)switch(x){case "reset":r=g.envelope.behavior.RESET;break;case "constant":r=g.envelope.behavior.CONSTANT;break;case "repeat":r=g.envelope.behavior.REPEAT;break;case "oscillate":r=g.envelope.behavior.OSCILLATE;break;case "offset":r=g.envelope.behavior.OFFSET;break;case "linear":r=g.envelope.behavior.LINEAR}f.setBehavior(b,n,o,r)}}var c=w.undef,g=CubicVR.enums,a=[],b={getPoints:function(a,d,f){a=d?
b.getTextNode(a,d):a.$;if(!a)return c;a=a.split(" ");for(i=0,iMax=a.length;i<iMax;i++){a[i]=a[i].split(",");for(j=0,jMax=a[i].length;j<jMax;j++)a[i][j]=parseFloat(a[i][j]);f&&(a[i][2]=0)}return a},getTransform:function(a){var b=CubicVR.util;if(!a)return null;var f={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},h;postition=a.position;h=a.rotation;a=a.scale;if(h)f.rotation=b.floatDelimArray(h.$);if(a)f.scale=b.floatDelimArray(a.$);return h||a?f:null},getTextNode:function(a,b,f){a=a[b];if(!a)return f;
a.length&&(a=a[0]);return a.$?a.$:f},getFloatNode:function(a,d,f){return(a=b.getTextNode(a,d))?(a=parseFloat(a),a!=a?f:a):f},getIntNode:function(a,d,f){return(a=b.getTextNode(a,d))?(a=parseInt(a,10),a!=a?f:a):f},getFloatDelimNode:function(a,d,f,h){var m=CubicVR.util;return(a=b.getTextNode(a,d))?m.floatDelimArray(a,h):f},getIntDelimNode:function(a,d,f,h){var m=CubicVR.util;return(a=b.getTextNode(a,d))?m.intDelimArray(a,h):f}};return{loadMesh:r,loadScene:function(a,b,f){var h=CubicVR.util;b===c&&(b=
"");f===c&&(f="");for(var m=new CubicVR.Mesh,q=h.getXML(a),a=new CubicVR.Scene,y=[],s=q.getElementsByTagName("sceneobjects"),A,v,H,t=0,E=s[0].childNodes.length;t<E;t++){var u=s[0].childNodes[t];if("sceneobject"===u.tagName){var x="unnamed",B="",C="",m=u.getElementsByTagName("name");m.length&&(x=h.collectTextNode(m[0]));m=u.getElementsByTagName("parent");m.length&&(B=h.collectTextNode(m[0]));m=u.getElementsByTagName("model");m.length&&(C=h.collectTextNode(m[0]));H=v=A=null;m=u.getElementsByTagName("position");
m.length&&(A=m[0]);m=u.getElementsByTagName("rotation");m.length&&(v=m[0]);m=u.getElementsByTagName("scale");m.length&&(H=m[0]);m=null;""!==C&&(m=r(b+C,f));m=new CubicVR.SceneObject(m,x);if(n(A)){if(!m.motion)m.motion=new CubicVR.Motion;o(A,g.motion.POS,m.motion)}else if(A)m.position=h.floatDelimArray(h.collectTextNode(A));if(n(v)){if(!m.motion)m.motion=new CubicVR.Motion;o(v,g.motion.ROT,m.motion)}else m.rotation=h.floatDelimArray(h.collectTextNode(v));if(n(H)){if(!m.motion)m.motion=new CubicVR.Motion;
o(H,g.motion.SCL,m.motion)}else m.scale=h.floatDelimArray(h.collectTextNode(H));a.bindSceneObject(m);""!==B&&y.push([m,B])}}for(var D in y)y.hasOwnProperty(D)&&a.getSceneObject(y[D][1]).bindChild(y[D][0]);b=q.getElementsByTagName("camera");if(b.length){v=A=null;f="";m=b[0].getElementsByTagName("name");D=a.camera;q=null;if(m.length)f=m[0].firstChild.nodeValue;m=b[0].getElementsByTagName("target");if(m.length)f=m[0].firstChild.nodeValue;if(""!==f)D.targetSceneObject=a.getSceneObject(f);m=b[0].getElementsByTagName("position");
m.length&&(A=m[0]);m=b[0].getElementsByTagName("rotation");m.length&&(v=m[0]);m=b[0].getElementsByTagName("fov");m.length&&(q=m[0]);if(n(A)){if(!D.motion)D.motion=new CubicVR.Motion;o(A,g.motion.POS,D.motion)}else if(A)D.position=h.floatDelimArray(A.firstChild.nodeValue);if(n(v)){if(!D.motion)D.motion=new CubicVR.Motion;o(v,g.motion.ROT,D.motion)}else if(v)D.rotation=h.floatDelimArray(v.firstChild.nodeValue);if(n(q)){if(!D.motion)D.motion=new CubicVR.Motion;o(q,g.motion.FOV,D.motion)}else if(q)D.fov=
parseFloat(q.firstChild.nodeValue)}return a}}});
CubicVR.RegisterModule("Camera",function(w){function z(a,b,e,d,f){var h=CubicVR.mat4;this.frustum=new CubicVR.Frustum;"object"==typeof a?(this.position=a.position||[0,0,-1],this.rotation=a.rotation||[0,0,0],this.target=a.target||[0,0,0],this.fov=a.fov||60,this.nearclip=a.nearclip||a.nearClip||a.near||0.1,this.farclip=a.farclip||a.farClip||a.far||400,this.targeted=a.targeted!==n?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix!==n?a.calcNormalMatrix:!0,this.name=a.name||"camera"+g,b=a.height?a.height:
n,a=a.width?a.width:n):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=e!==n?e:60,this.nearclip=d!==n?d:0.1,this.farclip=f!==n?f:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+g);this.motion=this.targetSceneObject=null;this.transform=new CubicVR.Transform;this.manual=!1;this.setDimensions(a!==n?a:512,b!==n?b:512);this.mvMatrix=h.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=null;++g}
function t(a){this.position=a!==n?a:[0,0,0]}function r(a,b,e){this.camPath=new CubicVR.Motion;this.targetPath=new CubicVR.Motion;this.start_position=a!==n?a:[8,8,8];this.target=b!==n?b:[0,0,0];this.bounds=e!==n?e:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var n=w.undef,o=CubicVR.enums,c=[1,0,0,0,0,
1,0,0,0,0,1,0,0,0,0,1],g=0;z.prototype={trackTarget:function(a,b,e){this.position=CubicVR.vec3.trackTarget(this.position,a,b,e)},setParent:function(a){this.parent=a},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return null!==this.parent&&this.mvMatrix&&this.parent.tMatrix?CubicVR.mat4.vec3_multiply(this.position,this.parent.tMatrix):this.position},setOrtho:function(a,b,e,d){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=
b;this.ortho_view.bottom=e;this.ortho_view.top=d},control:function(a,b,e){a===o.motion.ROT?this.rotation[b]=e:a===o.motion.POS?this.position[b]=e:a===o.motion.FOV?this.setFOV(e):a===o.motion.LENS?this.setLENS(e):a===o.motion.NEARCLIP?this.setClip(e,this.farclip):a===o.motion.FARCLIP&&this.setClip(this.nearclip,e)},makeFrustum:function(a,b,e,d,f,h){return[2*f/(b-a),0,0,0,0,2*f/(d-e),0,0,(b+a)/(b-a),(d+e)/(d-e),-(h+f)/(h-f),-1,0,0,-2*h*f/(h-f),0]},setTargeted:function(a){this.targeted=a},calcProjection:function(){var a=
CubicVR.mat4,b=CubicVR.mat3;this.pMatrix=this.ortho?a.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):a.perspective(this.fov,this.aspect,this.nearclip,this.farclip);if(!this.targeted&&this.mvMatrix)a.identity(this.mvMatrix),a.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),a.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent&&a.multiply(this.mvMatrix.slice(0),
a.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=a.inverse_mat3(this.mvMatrix),b.transpose_inline(this.nMatrix)):a.identity(this.nMatrix);this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(a,b){this.nearclip=a;this.farclip=b;this.calcProjection()},setDimensions:function(a,b){this.width=a;this.height=b;this.aspect=a/b;this.calcProjection()},resize:function(a,b){this.setDimensions(a,b)},setFOV:function(a){this.fov=a;this.ortho=!1;this.calcProjection()},
setLENS:function(a){this.setFOV(2*Math.atan(16/a)*(180/Math.PI))},lookat:function(a,b,e,d,f,h,m,q,g){var s=CubicVR.mat4,A=CubicVR.mat3;if("object"==typeof a)this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0);else{this.mvMatrix=s.lookat(a,b,e,d,f,h,m,q,g);if(this.rotation[2])this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=this.transform.getResult();null!==this.parent&&s.multiply(this.mvMatrix.slice(0),
s.inverse(this.parent.tMatrix),this.mvMatrix);this.calc_nmatrix?(this.nMatrix=s.inverse_mat3(this.mvMatrix),A.transpose_inline(this.nMatrix)):this.nMatrix=c;this.frustum.extract(this,this.mvMatrix,this.pMatrix)}},unProject:function(a,b,e){var d=CubicVR.mat4,f=CubicVR.vec3,h=[0,0,this.width,this.height],a=d.vec4_multiply(d.vec4_multiply([2*((a-h[0])/h[2])-1,-(2*((b-h[1])/h[3])-1),1,1],d.inverse(this.pMatrix)),d.inverse(this.mvMatrix)),a=[a[0]/a[3],a[1]/a[3],a[2]/a[3]];return e!==n?(b=this.getParentedPosition(),
f.add(b,f.multiply(f.normalize(f.subtract(a,b)),e))):a},project:function(a,b,e){var d=CubicVR.mat4,d=d.vec4_multiply(d.vec4_multiply([a,b,e,1],this.mvMatrix),this.pMatrix);d[2]=CubicVR.vec3.length(CubicVR.vec3.subtract([a,b,e],this.position));return[(d[0]/d[3]+1)/2*this.width,(-d[1]/d[3]+1)/2*this.height,d[2]]}};t.prototype={control:function(a,b,e){a===o.motion.POS&&(this.position[b]=e)}};r.prototype={inBounds:function(a){var b=CubicVR.vec3;if(!(a[0]>this.bounds[0][0]&&a[1]>this.bounds[0][1]&&a[2]>
this.bounds[0][2]&&a[0]<this.bounds[1][0]&&a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var e=0,d=this.avoid_sphere.length;e<d;e++)if(b.length(a,this.avoid_sphere[e][0])<this.avoid_sphere[e][1])return!1;return!0},findNextNode:function(a,b){var e=CubicVR.vec3,d=[0,0,0],f=[0,0,0],h=d=0,m=!1;do if(f[0]=Math.random()-0.5,f[1]=Math.random()-0.5,f[2]=Math.random()-0.5,f=e.normalize(f),d=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,d=e.add(b.position,e.multiply(f,
d)),m=this.inBounds(d),h++,30<h){d=b.position;break}while(!m);return d},run:function(a){this.current_time=a;if(0===this.path_time)this.path_time=this.current_time,this.camPath.setKey(o.motion.POS,o.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(o.motion.POS,o.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(o.motion.POS,o.motion.Z,this.path_time,this.start_position[2]);for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=this.segment_time;
var b=new t,e=new t;this.path_length&&this.camPath.apply(this.path_time-2*this.segment_time,b);this.camPath.apply(this.path_time-this.segment_time,e);b=this.findNextNode(b,e);this.camPath.setKey(o.motion.POS,o.motion.X,this.path_time,b[0]);this.camPath.setKey(o.motion.POS,o.motion.Y,this.path_time,b[1]);this.camPath.setKey(o.motion.POS,o.motion.Z,this.path_time,b[2]);this.path_length++}b=new t;this.camPath.apply(a,b);return b.position},addSafeBound:function(a,b){this.safe_bb.push([a,b])},addAvoidSphere:function(a,
b){this.avoid_sphere.push([a,b])}};return{Camera:z,AutoCamera:r}});
CubicVR.RegisterModule("CollisionMap",function(){var w=CubicVR.enums;w.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var z=function(t){this.shapes=[];this.result=null;if(t){t&&!t.length&&(t=[t]);for(var r=0,n=t.length;r<n;r++)this.addShape(t[r])}};z.prototype={addShape:function(t){t.type=CubicVR.parseEnum(w.collision.shape,t.type);t.position=t.position||[0,0,0];t.rotation=t.rotation||[0,0,0];t.size=t.size||[1,1,1];t.radius=t.radius||1;t.height=t.height||
1;t.margin=t.margin||0;t.mesh=t.mesh||null;this.shapes.push(t)},getShapes:function(){return this.shapes},setResult:function(t){this.result=t},getResult:function(){return this.result}};return{CollisionMap:z}});
CubicVR.RegisterModule("GML",function(w){function z(r){var n=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(r!==t){var r=n.getXML(r),o=r.getElementsByTagName("header");if(!o.length)return null;var c=o[0],o=r.getElementsByTagName("environment");if(!o.length)return null;this.name=null;c=c.getElementsByTagName("name");if(c.length)this.name=n.collectTextNode(c[0]);c=o[0].getElementsByTagName("screenBounds");if(c.length)this.bounds=
[parseFloat(n.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(n.collectTextNode(c[0].getElementsByTagName("y")[0])),parseFloat(n.collectTextNode(c[0].getElementsByTagName("z")[0]))];c=o[0].getElementsByTagName("origin");if(c.length)this.origin=[parseFloat(n.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(n.collectTextNode(c[0].getElementsByTagName("y")[0])),parseFloat(n.collectTextNode(c[0].getElementsByTagName("z")[0]))];o=o[0].getElementsByTagName("up");if(o.length)this.upvector=
[parseFloat(n.collectTextNode(o[0].getElementsByTagName("x")[0])),parseFloat(n.collectTextNode(o[0].getElementsByTagName("y")[0])),parseFloat(n.collectTextNode(o[0].getElementsByTagName("z")[0]))];r=r.getElementsByTagName("drawing");o=0;for(c=r.length;o<c;o++)for(var g=r[o].getElementsByTagName("stroke"),a=0,b=0,e=0,d=0,f=0,h=g.length;f<h;f++){for(var m=g[f].getElementsByTagName("pt"),q=m.length,y=Array(q),s,A,v,H=0,J=q;H<J;H++)v=m[H],q=parseFloat(n.collectTextNode(v.getElementsByTagName("x")[0])),
s=parseFloat(n.collectTextNode(v.getElementsByTagName("y")[0])),A=parseFloat(n.collectTextNode(v.getElementsByTagName("z")[0])),v=parseFloat(n.collectTextNode(v.getElementsByTagName("time")[0])),1===this.upvector[0]?y[H]=[s!==s?0:s,q!==q?0:-q,A!==A?0:A,v]:1===this.upvector[1]?y[H]=[q!==q?0:q,s!==s?0:s,A!==A?0:A,v]:1===this.upvector[2]&&(y[H]=[q!==q?0:q,A!==A?0:-A,s!==s?0:s,v]),a<q&&(a=q),b<s&&(b=s),e<A&&(e=A),d<v&&(d=v);if(e>d){m=0;for(H=y.length;m<H;m++)q=y[m][3],y[m][3]=y[m][2],y[m][2]=q/this.bounds[2]}this.strokes[f]=
y}}}var t=w.undef;z.prototype={addStroke:function(r,n){var o=[];n===t&&(n=0.1);for(var c=0,g=r.length;c<g;c++){var a=[r[c][0],r[c][1],r[c][2]];this.manual_pos+=n;a.push(this.manual_pos);o.push(a)}this.strokes.push(o)},recenter:function(){var r=CubicVR.vec3,n=[0,0,0],o=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],c,g,a,b;for(a=0,b=this.strokes.length;a<b;a++)for(c=0,g=this.strokes[a].length;c<g;c++)n[0]>this.strokes[a][c][0]&&(n[0]=this.strokes[a][c][0]),n[1]>this.strokes[a][c][1]&&
(n[1]=this.strokes[a][c][1]),n[2]>this.strokes[a][c][2]&&(n[2]=this.strokes[a][c][2]),o[0]<this.strokes[a][c][0]&&(o[0]=this.strokes[a][c][0]),o[1]<this.strokes[a][c][1]&&(o[1]=this.strokes[a][c][1]),o[2]<this.strokes[a][c][2]&&(o[2]=this.strokes[a][c][2]);r=r.multiply(r.subtract(o,n),0.5);for(a=0,b=this.strokes.length;a<b;a++)for(c=0,g=this.strokes[a].length;c<g;c++)this.strokes[a][c][0]-=r[0],this.strokes[a][c][1]-=this.upvector[1]?r[1]:-r[1],this.strokes[a][c][2]-=r[2]},generateObject:function(r,
n,o,c,g){var a=CubicVR.vec3;r===t&&(r=0);n===t&&(n=0);g===t&&(g=!1);c===t&&(c=0.02);o===t&&(o=0.015);for(var b=0!==n,e=0,d=0,f=new CubicVR.Mesh(this.name),h,m,q,y,s,A,v=0,H=this.strokes.length;v<H;v++){A=new CubicVR.Envelope;var J=new CubicVR.Envelope,E=new CubicVR.Envelope,u=this.strokes[v].length,x=[],B=[],C=0,D=this.strokes[v];for(s=0;s<u;s++){var w=D[s],z=A.addKey(w[3],w[0]),F=J.addKey(w[3],w[1]),G;G=g?E.addKey(w[3],w[2]):E.addKey(w[3],0);z.tension=0.5;F.tension=0.5;G.tension=0.5;0!==s?(h=w[0]-
h,m=w[1]-m,q=w[2]-q,y=w[3]-y,q=Math.sqrt(h*h+m*m+q*q),x[s-1]=q,B[s-1]=y):C=w[3];h=w[0];m=w[1];q=w[2];y=w[3]}u=f.points.length;for(s=0;s<x.length;s++){D=B[s];F=Math.ceil(3*(x[s]/c));w=C;z=C+D;for(F=D/F;w<z-F;w+=F){w===C&&(h=A.evaluate(w),m=J.evaluate(w),q=E.evaluate(w));var L,O;G=A.evaluate(w+F);L=J.evaluate(w+F);O=E.evaluate(w+F);var N=G-h,Y=L-m,ca=O-q;Math.sqrt(N*N+Y*Y+ca*ca);N=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([N,Y,ca]))),o/2);f.addPoint([h-N[0],-(m-N[1]),q-N[2]+(b?n/2:
0)]);f.addPoint([h+N[0],-(m+N[1]),q+N[2]+(b?n/2:0)]);h=G;m=L;q=O}C+=D}J=f.points.length;if(b)for(s=u,A=J;s<A;s++)f.addPoint([f.points[s][0],f.points[s][1],f.points[s][2]-(b?n/2:0)]);for(s=0,A=J-u;s<=A-4;s+=2)0===e%r&&d++,f.setSegment(d),E=[u+s,u+s+1,u+s+3,u+s+2],f.addFace(E),b&&(E=[E[3]+J-u,E[2]+J-u,E[1]+J-u,E[0]+J-u],f.addFace(E),E=[u+s,u+s+2,u+s+2+J-u,u+s+J-u],f.addFace(E),E=[u+s+1+J-u,u+s+3+J-u,u+s+3,u+s+1],f.addFace(E),0===s&&(E=[u+s+J-u,u+s+1+J-u,u+s+1,u+s],f.addFace(E)),s===A-4&&(E=[u+s+2,u+
s+3,u+s+3+J-u,u+s+2+J-u],f.addFace(E))),e++}f.calcFaceNormals();f.triangulateQuads();f.calcNormals();f.compile();return f}};return{GML:z}});
CubicVR.RegisterModule("Landscape",function(w){function z(n,c,g,a){this.doTransform=function(){};this.tMatrix=r;this.parent=null;this.position=[0,0,0];this.scale=[1,1,1];this.rotation=[0,0,0];this.size=n;this.divisions_w=c;this.divisions_h=g;this.matRef=a;this.children=null;this.visible=!0;this.obj=new CubicVR.Mesh({dynamic:!0,buildWireframe:!0});this.divisions_w>this.divisions_h?(this.size_w=n,this.size_h=n/this.divisions_w*this.divisions_h):(this.size_w=this.divisions_h>this.divisions_w?n/this.divisions_h*
this.divisions_w:n,this.size_h=n);for(c=-(this.size_h/2);c<this.size_h/2;c+=this.size_h/this.divisions_h)for(n=-(this.size_w/2);n<this.size_w/2;n+=this.size_w/this.divisions_w)this.obj.addPoint([n+this.size_w/this.divisions_w/2,0,c+this.size_h/this.divisions_h/2]);this.obj.setFaceMaterial(this.matRef);for(c=0;c<this.divisions_h-1;c++)for(n=0;n<this.divisions_w-1;n++)this.obj.addFace([n+(c+1)*this.divisions_w,n+1+c*this.divisions_w,n+c*this.divisions_w]),this.obj.addFace([n+(c+1)*this.divisions_w,
n+1+(c+1)*this.divisions_w,n+1+c*this.divisions_w])}var t=w.undef,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],n=Math.PI/2;z.prototype={isWireframe:function(){return!1},getMesh:function(){return this.obj},getEventHandler:function(){return t},setIndexedHeight:function(n,c,g){obj.points[n+c*this.divisions_w][1]=g},mapGen:function(n,c,g,a,b){if(c!==t&&g!==t&&a!==t&&b!==t){if(!(c>=this.divisions_w)&&!(g>=this.divisions_h)&&(c+a>=this.divisions_w&&(a=this.divisions_w-1-c),g+b>=this.divisions_h&&(b=this.divisions_h-
1-g),!(0>=a||0>=b)))for(var e=c,a=c+a;e<a;e++)for(var d=g,f=g+b;d<f;d++){var h=e+d*this.divisions_w,c=this.obj.points[h];c[1]=n(c[0],c[2],h)}}else{g=0;for(b=this.obj.points.length;g<b;g++)c=this.obj.points[g],c[1]=n(c[0],c[2],g)}},getFaceAt:function(n,c){if("object"===typeof n)return this.getFaceAt(n[0],n[2]);var g=this.size_h/2-this.size_h/this.divisions_h/2,a=parseInt(Math.floor((n+(this.size_w/2-this.size_w/this.divisions_w/2))/this.size_w*this.divisions_w),10),g=parseInt(Math.floor((c+g)/this.size_h*
this.divisions_h),10);if(0>a)return-1;if(a>=this.divisions_w-1)return-1;if(0>g)return-1;if(g>=this.divisions_h-1)return-1;var a=2*parseInt(a+g*(this.divisions_w-1),10),g=parseInt(a+1,10),b=this.obj.points[this.obj.faces[a].points[0]];return 1<=Math.abs(c-b[2])/Math.abs(n-b[0])?a:g},getHeightValue:function(n,c){var g=CubicVR.triangle;if("object"===typeof n)return this.getHeightValue(n[0],n[2]);var a,b=this.getFaceAt(n,c);if(-1===b)return 0;a=this.obj.points[this.obj.faces[b].points[0]];var e=g.normal(this.obj.points[this.obj.faces[b].points[0]],
this.obj.points[this.obj.faces[b].points[1]],this.obj.points[this.obj.faces[b].points[2]]),g=e[0],b=e[1],e=e[2];return(g*n+e*c+(-(g*a[0])-b*a[1]-e*a[2]))/-b},orient:function(r,c,g,a,b,e){e===t&&(e=0);var d,f,h=[];d=g/2;var m=a/2;f=Math.sqrt(m*m+d*d);m=Math.atan2(m,d);b*=Math.PI/180;d=r+Math.sin(b)*e;e=c+Math.cos(b)*e;h[0]=this.getHeightValue([d+f*Math.cos(-m-n+b),0,e+f*-Math.sin(-m-n+b)]);h[1]=this.getHeightValue([d+f*Math.cos(m-n+b),0,e+f*-Math.sin(m-n+b)]);h[2]=this.getHeightValue([d+f*Math.cos(-m+
n+b),0,e+f*-Math.sin(-m+n+b)]);h[3]=this.getHeightValue([d+f*Math.cos(m+n+b),0,e+f*-Math.sin(m+n+b)]);f=-Math.atan2(h[1]-h[2],g);e=-Math.atan2(h[0]-h[1],a);f+=-Math.atan2(h[0]-h[3],g);e+=-Math.atan2(h[3]-h[2],a);return[[r,(h[2]+h[3]+h[1]+h[0])/4,c],[f/2*(180/Math.PI),b,e/2*(180/Math.PI)]]}};return{Landscape:z}});
CubicVR.RegisterModule("Layout",function(){function w(t){this.texture=t.texture?t.texture:null;this.width=t.width?t.width:128;this.height=t.height?t.height:128;this.x=t.x?t.x:0;this.y=t.y?t.y:0;this.blend=t.blend?t.blend:!1;this.opacity="undefined"!==typeof t.opacity?t.opacity:1;this.tint=t.tint?t.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function z(t){this.texture=t.texture?t.texture:null;this.width=t.width?t.width:128;this.height=t.height?t.height:128;
this.x=t.x?t.x:0;this.y=t.y?t.y:0;this.blend=t.blend?t.blend:!1;this.opacity="undefined"!==typeof t.opacity?t.opacity:1;this.tint=t.tint?t.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}w.prototype={addSubview:function(t){this.childViews.push(t);t.superView=this},makePanel:function(t){return this.superView.makePanel(t)}};z.prototype={resize:function(t,r){this.width=t;this.height=r},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(t){t.setInt("srcTex",0);t.addVector("screen");t.addVector("position");t.addVector("tint");t.addVector("size")}})},addSubview:function(t){this.childViews.push(t);t.superView=this},removeSubview:function(t){t=this.childViews.indexOf(t);-1<t&&this.childViews.splice(t,
1)},makePanel:function(t){var r=CubicVR.GLCore.gl,n={};n.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);n.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);n.gl_points=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,n.gl_points);r.bufferData(r.ARRAY_BUFFER,n.vbo_points,r.STATIC_DRAW);n.gl_uvs=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,n.gl_uvs);r.bufferData(r.ARRAY_BUFFER,n.vbo_uvs,r.STATIC_DRAW);t.panel=n},renderPanel:function(t){if(!t.texture)return!1;t.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(t){if(t.texture){var r=CubicVR.GLCore.gl,n=t.offsetLeft,o=t.offsetTop;n||(n=0);o||(o=0);var c=this.shader.shader;c.use();c.setVector("screen",[this.width,this.height,0]);c.setVector("position",[t.x+n,t.y+o,0]);c.setVector("size",[t.width,t.height,0]);c.setVector("tint",t.tint);t.blend&&(r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA));t.texture.use(r.TEXTURE0);r.drawArrays(r.TRIANGLES,0,6);t.blend&&(r.disable(r.BLEND),r.blendFunc(r.ONE,r.ZERO))}},render:function(){var t=
CubicVR.GLCore.gl;t.disable(t.DEPTH_TEST);this.texture&&this.renderView(this);var r=[];this.offsetTop=this.offsetLeft=0;r.push(this);var n=this.shader.shader;n.use();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null);t.bindBuffer(t.ARRAY_BUFFER,this.panel.gl_points);t.vertexAttribPointer(n.uniforms.aVertex,3,t.FLOAT,!1,0,0);t.enableVertexAttribArray(n.uniforms.aVertex);t.bindBuffer(t.ARRAY_BUFFER,this.panel.gl_uvs);t.vertexAttribPointer(n.uniforms.aTex,2,t.FLOAT,!1,0,0);t.enableVertexAttribArray(n.uniforms.aTex);
for(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null);r.length;){var o=r.pop();this.renderView(o);if(o.childViews.length)for(var c=o.childViews.length-1;0<=c;c--)o.childViews[c].offsetLeft=o.x+o.offsetLeft,o.childViews[c].offsetTop=o.y+o.offsetTop,r.push(o.childViews[c])}t.disableVertexAttribArray(n.uniforms.aTex);t.enable(t.DEPTH_TEST)}};return{Layout:z,View:w}});
CubicVR.RegisterModule("Light",function(w){function z(c,g){var a=CubicVR.aabb,c=CubicVR.get(c)||{};if(c===n)c=r.light.type.POINT;if(g===n)g=r.light.method.DYNAMIC;"object"==typeof c?(this.light_type=c.type!==n?CubicVR.parseEnum(r.light.type,c.type):r.light.type.POINT,this.diffuse=c.diffuse!==n?c.diffuse:[1,1,1],this.specular=c.specular!==n?c.specular:[1,1,1],this.intensity=c.intensity!==n?c.intensity:1,this.position=c.position!==n?c.position:[0,0,0],this.direction=c.direction!==n?c.direction:[0,0,
0],this.distance=c.distance!==n?c.distance:this.light_type===r.light.type.AREA?30:10,this.cutoff=c.cutoff!==n?c.cutoff:60,this.map_res=c.map_res!==n?c.map_res:this.light_type===r.light.type.AREA?2048:512,this.map_res=c.mapRes!==n?c.mapRes:this.map_res,this.method=c.method!==n?CubicVR.parseEnum(r.light.method,c.method):g,this.areaCam=c.areaCam!==n?c.areaCam:null,this.areaCeiling=c.areaCeiling!==n?c.areaCeiling:40,this.areaFloor=c.areaFloor!==n?c.areaFloor:-40,this.areaAxis=c.areaAxis!==n?c.areaAxis:
[1,1,0],this.projectorTex=c.projector!==n?c.projector:null):(this.light_type=CubicVR.parseEnum(r.light.type,c),this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===r.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===r.light.type.AREA?2048:512,this.method=CubicVR.parseEnum(r.light.method,g),this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);if(this.projectorTex&&
"string"===typeof this.projectorTex){var b=this.projectorTex;this.projectorTex=w.Textures_ref[b]!==n?w.Textures_obj[w.Textures_ref[b]]:new CubicVR.Texture(b)}this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];a.reset(this.aabb,this.position);this.adjust_octree=CubicVR.SceneObject.prototype.adjust_octree;
this.motion=null;this.rotation=[0,0,0];(this.light_type===r.light.type.SPOT_SHADOW||this.light_type===r.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===r.light.type.AREA&&w.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var t=w.GLCore,r=CubicVR.enums,n=w.undef,o=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];r.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,
DYNAMIC:2}};z.prototype={setType:function(c){if(c===r.light.type.AREA&&!w.features.lightShadows)this.dummyCam=new CubicVR.Camera,this.areaCam=new CubicVR.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,c=r.light.type.DIRECTIONAL;else if((c===r.light.type.SPOT_SHADOW||c===r.light.type.SPOT_SHADOW_PROJECTOR)&&!w.features.lightShadows)c=r.light.type.SPOT;this.light_type=c},setParent:function(c){this.parent=c},setMethod:function(c){this.method=c},setDiffuse:function(c){this.diffuse=c},setSpecular:function(c){this.specular=
c},setIntensity:function(c){this.intensity=c},setPosition:function(c){this.position=c},setDistance:function(c){this.distance=c},setCutoff:function(c){this.cutoff=c},prepare:function(c){var g=CubicVR.mat4,a=CubicVR.mat3,b=this.light_type;if(this.parent)if(b===r.light.type.SPOT||b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR)b=g.inverse_mat3(this.parent.tMatrix),a.transpose_inline(b),this.lDir=a.vec3_multiply(this.direction,b),this.lDir=a.vec3_multiply(this.lDir,c.nMatrix),this.lPos=
g.vec3_multiply(this.position,g.multiply(c.mvMatrix,this.parent.tMatrix));else{if(b===r.light.type.POINT)this.lPos=g.vec3_multiply(this.position,g.multiply(c.mvMatrix,this.parent.tMatrix))}else if(b===r.light.type.DIRECTIONAL)this.lDir=a.vec3_multiply(this.direction,c.nMatrix);else if(b===r.light.type.SPOT||b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR)this.lDir=a.vec3_multiply(this.direction,c.nMatrix),this.lPos=g.vec3_multiply(this.position,c.mvMatrix);else if(b===r.light.type.POINT)this.lPos=
g.vec3_multiply(this.position,c.mvMatrix);else if(b===r.light.type.AREA)this.lDir=a.vec3_multiply(this.direction,c.nMatrix)},control:function(c,g,a){if(c===r.motion.POS)this.position[g]=a;else if(c===r.motion.INTENSITY)this.intensity=a},getAABB:function(){var c=CubicVR.vec3,g=CubicVR.aabb,a=[[0,0,0],[0,0,0]];g.engulf(a,[this.distance,this.distance,this.distance]);g.engulf(a,[-this.distance,-this.distance,-this.distance]);a[0]=c.add(a[0],this.position);a[1]=c.add(a[1],this.position);return this.aabb=
a},setDirection:function(c,g,a){var b=CubicVR.vec3;if("object"===typeof c)this.setDirection(c[0],c[1],c[2]);else return this.direction=b.normalize([c,g,a]),this},lookat:function(c,g,a){var b=CubicVR.vec3;if("object"===typeof c)this.lookat(c[0],c[1],c[2]);else return this.direction=b.normalize(b.subtract([c,g,a],this.position)),this},setRotation:function(c,g,a){var b=CubicVR.mat4,e=CubicVR.vec3;if("object"===typeof c)this.setRotation(c[0],c[1],c[2]);else{var d=new CubicVR.Transform;d.rotate([-c,-g,
-a]);d.pushMatrix();this.direction=e.normalize(b.vec3_multiply([1,0,0],d.getResult()));this.rotation=[c,g,a];return this}},setupShader:function(c,g){var a=t.gl;a.uniform3fv(c.lightDiffuse[g],this.diffuse);a.uniform3fv(c.lightSpecular[g],this.specular);this.lPos&&a.uniform3fv(c.lightPosition[g],this.lPos);this.lDir&&a.uniform3fv(c.lightDirection[g],this.lDir);a.uniform1f(c.lightIntensity[g],this.intensity);a.uniform1f(c.lightDistance[g],this.distance);(this.light_type===r.light.type.SPOT_SHADOW||this.light_type===
r.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===r.light.type.SPOT)&&a.uniform1f(c.lightCutOffAngle[g],this.cutoff);if(this.light_type===r.light.type.SPOT_SHADOW||this.light_type===r.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===r.light.type.AREA)this.light_type===r.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(t.gl.TEXTURE0+2*g),a.uniform1i(c.lightShadowMap[g],2*g),this.projectorTex.use(t.gl.TEXTURE0+2*g+1),a.uniform1i(c.lightProjectionMap[g],2*g+1)):(this.shadowMapTex.texture.use(t.gl.TEXTURE0+
g),a.uniform1i(c.lightShadowMap[g],g)),a.uniform3fv(c.lightDepthClip[g],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),a.uniformMatrix4fv(c.lightShadowMatrix[g],!1,this.spMatrix)},setShadow:function(c){if(w.features.lightShadows)this.map_res=c,this.shadowMapTex=new CubicVR.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(r.texture.filter.NEAREST),this.dummyCam=new CubicVR.Camera(this.map_res,this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=
!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0},hasShadow:function(){return has_shadow},setProjector:function(c){this.projectorTex=c},hasProjector:function(){return null!==this.projectorTex?!0:!1},shadowBegin:function(){var c=t.gl,g=CubicVR.mat4,a=CubicVR.mat3;this.shadowMapTex.use();c.viewport(0,0,this.map_res,this.map_res);c.clear(c.DEPTH_BUFFER_BIT|c.COLOR_BUFFER_BIT);this.light_type!==r.light.type.AREA?(this.dummyCam.setClip(0.1,this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();
if(this.parent){var b=g.inverse_mat3(this.parent.tMatrix);a.transpose_inline(b);a.vec3_multiply(this.direction,b);g.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);g.multiply(this.dummyCam.mvMatrix.slice(0),g.inverse(this.parent.tMatrix),this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],
this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);c.cullFace(c.FRONT)},shadowEnd:function(){var c=t.gl;c.bindFramebuffer(c.FRAMEBUFFER,null);c.cullFace(c.BACK);this.setupTexGen()},setupTexGen:function(){var c=CubicVR.mat4;this.spMatrix=c.multiply(o,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=c.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=c.multiply(this.spMatrix,this.dummyCam.mvMatrix)},
setAreaAxis:function(c){this.areaAxis=c},updateAreaLight:function(){var c=CubicVR.vec3,g=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var a=0,a=Math.tan(this.areaCam.fov/2*(Math.PI/180)),b=c.subtract(this.areaCam.target,this.areaCam.position);b[1]=0;b=c.normalize(b);c.normalize(c.cross(b,[0,1,0]));var e=-Math.atan2(b[2],b[0]),a=this.distance/2*Math.abs(a)-this.distance/2;a<this.distance/3/2&&(a=this.distance/3/2);var b=c.multiply(b,a),a=this.areaAxis[1]*(Math.PI/
180),d=Math.tan(this.areaAxis[0]*(Math.PI/180)),a=[Math.tan(a),0,d],e=e-Math.atan2(a[0],a[2]);this.position=c.add(c.add(this.areaCam.position,b),c.multiply(a,g));this.position[1]=this.areaCeiling;this.target=c.add(c.add(this.areaCam.position,b),c.multiply(a,-g));this.target[1]=this.areaFloor;this.direction=c.normalize(c.subtract(this.target,this.position));this.dummyCam.rotation[2]=e*(180/Math.PI);c=this.dummyCam.nearclip;g=this.dummyCam.farclip*Math.abs(this.direction[1])*g;c=this.orthoBounds(this.position,
this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);c[0][1]<this.areaCeiling&&Math.abs(this.direction[1]);c=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);c[1][1]>this.areaFloor&&(c=c[1][1]-this.areaFloor,g+=c/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=g;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/
2)},orthoBounds:function(c,g,a,b,e,d){var b=CubicVR.vec3,f=b.normalize([e[0],e[4],e[8]]),h=b.normalize([e[1],e[5],e[9]]),e=b.normalize(b.cross(h,f)),m;m=a/2;a=[];g=b.multiply(f,g/2);f=b.multiply(h,m);d=b.multiply(e,d);a[0]=b.add(b.subtract(c,g),b.add(f,d));a[1]=b.add(b.add(c,g),b.add(f,d));a[2]=b.subtract(b.subtract(c,g),b.add(f,d));a[3]=b.subtract(b.add(c,g),b.add(f,d));aabb1=a[0];aabb2=a[0];for(c=1;4>c;c++)aabb1[0]>a[c][0]&&(aabb1[0]=a[c][0]),aabb1[1]>a[c][1]&&(aabb1[1]=a[c][1]),aabb1[2]>a[c][2]&&
(aabb1[2]=a[c][2]),aabb2[0]<a[c][0]&&(aabb2[0]=a[c][0]),aabb2[1]<a[c][1]&&(aabb2[1]=a[c][1]),aabb2[2]<a[c][2]&&(aabb2[2]=a[c][2]);return[aabb1,aabb2]}};return{Light:z}});
CubicVR.RegisterModule("PDF",function(){return{PDF:function(w){if(!w.src)throw"PDF Error: you must specify a src url for a PDF.";var z=w.src,t=w.callback||function(){},r,n=[],o=[];this.__defineGetter__("pages",function(){return r?r.numPages:0});this.getPage=function(c){var g=r.numPages,c=1>c?1:c;return n[(c>g?g:c)-1]};this.getPageTexture=function(c,g,a){c=this.getPage(c);g=g||c.width;a=a||c.height;return new CubicVR.PdfTexture(c,{width:g,height:a})};getPdf({url:z,error:function(){console.log("PDF Error: error loading pdf `"+
z+"`")}},function(c){r=new PDFDoc(c);for(var c=1,g=r.numPages;c<=g;c++){var a=r.getPage(c);n.push(a);o.push(a)}t()})}}});
CubicVR.RegisterModule("MainLoop",function(w){function z(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function t(){null!==CubicVR.GLCore.mainloop&&(window.requestAnimationFrame&&window.requestAnimationFrame(t),CubicVR.GLCore.mainloop.interval())}function r(a,b,e){if(window.requestAnimationFrame===o)window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null;if(null!==CubicVR.GLCore.mainloop)!window.requestAnimationFrame&&CubicVR.GLCore.mainloop&&clearInterval(CubicVR.GLCore.mainloop.interval),CubicVR.GLCore.mainloop=null;if(null===a)CubicVR.GLCore.mainloop=null;else{this.renderList=[];var d=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],f=new z;f.start();this.timer=f;this.func=a;this.doclear=b!==o?b:!0;CubicVR.GLCore.mainloop=this;if(g.resizeList.length&&!CubicVR.GLCore.resize_active)window.addEventListener("resize",
function(){CubicVR.GLCore.onResize()},!1),CubicVR.GLCore.resize_active=!0;b=function(){return function(){var b=CubicVR.GLCore.gl;f.update();CubicVR.GLCore.mainloop.doclear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);a(f,CubicVR.GLCore.gl);var m=d[d.length-1],q=m.scenes;m.update&&m.update(f,b);if(q){b=0;for(m=q.length;b<m;++b){var e=q[b];e.paused||(e.update&&e.update(f,CubicVR.GLCore.gl),e.render())}}}}();e?this.loopFunc=b:window.requestAnimationFrame?(this.interval=b,window.requestAnimationFrame(t)):
this.interval=setInterval(b,20)}}function n(a,b,e){this.canvas=a;this.camera=b;this.mpos=[0,0];this.mdown=!1;var d=this;this.mEvents={};this.keyState=[];for(var f in c.keyboard)this.keyState[f]=!1;this.onMouseDown=function(){return function(a){d.mdown=!0;d.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];d.mEvents.mouseDown&&d.mEvents.mouseDown(d,d.mpos,d.keyState)}}();this.onMouseUp=function(){return function(a){d.mdown=!1;d.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];
d.mEvents.mouseUp&&d.mEvents.mouseUp(d,d.mpos,d.keyState)}}();this.onMouseMove=function(){return function(a){var b=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];b[0]=a[0]-d.mpos[0];b[1]=a[1]-d.mpos[1];d.mpos=a;d.mEvents.mouseMove&&d.mEvents.mouseMove(d,d.mpos,b,d.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:100*-a.detail;d.mEvents.mouseWheel&&d.mEvents.mouseWheel(d,d.mpos,a,d.keyState)}}();this.onKeyDown=function(){return function(a){var a=
a.keyCode,b=null;d.mEvents.keyPress?(b=d.mEvents.keyPress(d,d.mpos,a,d.keyState),d.keyState[a]=b!==o?!!b:!0):d.keyState[a]=!0;d.keyState[a]&&d.mEvents.keyDown&&(b=d.mEvents.keyDown(d,d.mpos,a,d.keyState),d.keyState[a]=b!==o?!!b:!0)}}();this.onKeyUp=function(){return function(a){a=a.keyCode;d.mEvents.keyUp&&d.mEvents.keyUp(d,d.mpos,a,d.keyState);d.keyState[a]=!1}}();this.eventDefaults={mouseMove:function(a,b,f){a.mdown&&a.orbitView(f)},mouseWheel:function(a,b,f){a.zoomView(f)},mouseDown:null,mouseUp:null,
keyDown:null,keyUp:null,keyPress:null};!1!==e&&this.setEvents(e===o?this.eventDefaults:e);this.bind()}var o=w.undef,c=CubicVR.enums,g=w.GLCore;c.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,
KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,
SEMICOLON:186,EQUALS:187,COMMA:188,DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};z.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(a){this.lock_rate=1/a;this.lock_state=
!0},unlock:function(){var a=this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=a-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.system_milliseconds=this.lock_state?this.system_milliseconds+(1E3*this.lock_rate|0):Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);
this.time_elapsed=this.system_milliseconds-this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(a){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-a},setSeconds:function(a){this.setMilliseconds(1E3*a|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-
this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(a){this.paused_state=a},getPaused:function(){return this.paused_state}};r.prototype={setPaused:function(a){this.timer.setPaused(a)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(a){this.timer.setSeconds(a)},getTimerSeconds:function(){return this.timer.getSeconds()},
resetTimer:function(){this.timer.reset()},addScene:function(a){this.renderStack[this.renderStack.length-1].scenes.push(a);return a},pushSceneGroup:function(a){a.scenes=a.scenes||[];this.renderStack.push(a);for(var b=0;b<a.scenes.length;++b)a.scenes[b].enable();a.start&&a.start()},popSceneGroup:function(){for(var a=this.renderStack[this.renderStack.length-1],b=0;b<a.scenes.length;++b)a.scenes[b].disable();1<this.renderStack.length&&this.renderStack.pop();a.stop&&a.stop()},getScene:function(a){for(var b=
renderStack[renderStack.length-1],e,d=0,f=b.scenes.length;d<f;++d)if(b.scenes[d].scene.name===a){e=b.scenes[d];break}return e},resumeScene:function(a){"string"===typeof a&&(a=this.getScene(a));a.enable();a.paused=!1},pauseScene:function(a){"string"===typeof a&&(a=this.getScene(a));a.paused=!0;a.disable()},removeScene:function(a){var b=renderStack[renderStack.length-1];"string"===typeof a&&(a=this.getScene(a));var e=b.scenes.indexOf(a);-1<e&&b.scenes.splice(e,1);return a},runOnce:function(){this.loopFunc()}};
n.prototype={isKeyPressed:function(a){return this.keyState[a]},setEvents:function(a){this.mEvents={};for(var b in a)this.bindEvent(b,a[b])},orbitView:function(a){var b=CubicVR.vec3,e=b.subtract(this.camera.target,this.camera.position),e=b.length(e);this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,0);this.camera.position[1]+=e*a[1]/300;this.camera.position=b.add(this.camera.target,b.multiply(b.normalize(b.subtract(this.camera.position,this.camera.target)),
e))},panView:function(a,b){var e=CubicVR.vec3;b||(b=!1);var d=e.subtract(this.camera.target,this.camera.position),d=e.length(d),f=this.camera.position;b?this.camera.position=e.moveViewRelative(this.camera.position,this.camera.target,-d*a[0]/300,-d*a[1]/300):(this.camera.position=e.moveViewRelative(this.camera.position,this.camera.target,-d*a[0]/300,0),this.camera.position[1]+=d*a[1]/300);d=e.subtract(this.camera.position,f);this.camera.target=e.add(this.camera.target,d)},zoomView:function(a,b,e){var d=
CubicVR.vec3,f=d.subtract(this.camera.target,this.camera.position),f=d.length(f),f=f-a/1E3;b||(b=0.1);e||(e=1E3);f<b&&(f=b);f>e&&(f=e);this.camera.position=d.add(this.camera.target,d.multiply(d.normalize(d.subtract(this.camera.position,this.camera.target)),f))},bindEvent:function(a,b){this.mEvents[a]=b===o?this.eventDefaults[a]:b},unbindEvent:function(a){this.bindEvent(a,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,
!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,
!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(a){this.camera=a},getMousePosition:function(){return this.mpos}};return{Timer:z,MainLoop:r,MouseViewController:n,setMainLoop:function(a){CubicVR.GLCore.mainloop=a},keyboard:c.keyboard}});
CubicVR.RegisterModule("Texture",function(w){function z(a,b){if(1===a||1===b)return!1;if(1!==a)for(;0===a%2;)a/=2;if(1!==b)for(;0===b%2;)b/=2;return 1<a?!1:1<b?!1:!0}function t(a){var f=CubicVR.GLCore.gl;if("CANVAS"===a.nodeName||"IMG"===a.nodeName||"VIDEO"===a.nodeName)this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(void 0===a.width||void 0===a.height)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=a.width;
this.canvasSource.height=a.height;this.canvasContext=this.canvasSource.getContext("2d")}this.updateFunction=a.update;this.texture=new CubicVR.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;var h=this.canvasSource;(!h.height||!h.width)&&d("Warning - CanvasTexture input has no initial width and height, edges clamped.");!h.height||!h.width||!z(h.width,h.height)?(this.setFilter(b.texture.filter.LINEAR),
f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE)):(this.setFilter(b.texture.filter.LINEAR_MIP),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT));"IMG"===a.nodeName&&this.update()}function r(a,f){if(!a)throw"PDF Texture Error: page is null.";var d=this,h=CubicVR.GLCore.gl,e=this.canvasSource=document.createElement("canvas"),c;e.mozOpaque=!0;e.width=f.width;e.height=
f.height;c=this.canvasContext=e.getContext("2d");c.save();c.fillStyle="rgb(255, 255, 255)";c.fillRect(0,0,e.width,e.height);c.restore();a.startRendering(c,function(){d.update()});this.texture=new CubicVR.Texture;this.updateFunction=f.update||function(){};this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;z(e.width,e.height)?(this.setFilter(b.texture.filter.LINEAR_MIP),h.texParameteri(h.TEXTURE_2D,
h.TEXTURE_WRAP_S,h.REPEAT),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE))}function n(a,f,d){var h=CubicVR.GLCore.gl;this.texture=new CubicVR.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=f;this.canvas.height=d;this.pjs=new Processing(this.canvas,CubicVR.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();
this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;z(this.canvas.width,this.canvas.height)?this.setFilter(b.texture.filter.LINEAR_MIP):(this.setFilter(b.texture.filter.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE))}function o(f,d,h){var e=a.gl;this.width=d;this.height=h;this.srcTex=f;this.outTex=new CubicVR.RenderBuffer(d,
h);z(d,h);f=[1/d,1/h,0];this.outputBuffer=new CubicVR.RenderBuffer(d,h,!1);this.fsQuad=CubicVR.fsQuad.make(d,h);shaderNMap=new CubicVR.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",f);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(e.TEXTURE0);this.setFilter(b.texture.filter.LINEAR);
e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)}function c(f,d,h){var e=a.gl;this.width=f;this.height=d;this.outTex=new CubicVR.RenderBuffer(f,d,h);this.texture=this.outTex.texture;var c=z(f,d);this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;this.filterType=this.outTex.texture.filterType;this.texture.use(e.TEXTURE0);c?(this.setFilter(b.texture.filter.LINEAR),
e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE));this.dims=[f,d];this.depth=h?!0:!1}function g(a,b){this.scene=a;this.renderTex=new c(b?b.width:a.camera.width,b?b.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;
this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var a=w.GLCore,b=CubicVR.enums,e=w.undef,d=w.log;b.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var f=function(a,b){this.img_path=a;this.filter_type=b};f.prototype={getTexture:function(a,b){return new h(this.img_path,this.filter_type,a,b)}};var h=function(f,d,h,c,g){var v=
a.gl;this.tex_id=w.Textures.length;this.filterType=-1;this.onready=g;this.loaded=!1;w.Textures[this.tex_id]=v.createTexture();w.Textures_obj[this.tex_id]=this;if(f)"string"===typeof f?w.Images[this.tex_id]=new Image:"object"===typeof f&&"IMG"===f.nodeName&&(w.Images[this.tex_id]=f),w.Textures_ref[f]=this.tex_id;v.bindTexture(v.TEXTURE_2D,w.Textures[this.tex_id]);v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MAG_FILTER,v.LINEAR);v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,v.LINEAR);if(f){var n=this.tex_id,
r=d!==e?d:a.default_filter,o=this;w.Images[this.tex_id].onload=function(){v.bindTexture(v.TEXTURE_2D,w.Textures[n]);v.pixelStorei(v.UNPACK_FLIP_Y_WEBGL,!0);v.pixelStorei(v.UNPACK_COLORSPACE_CONVERSION_WEBGL,v.NONE);var a=w.Images[n];v.texImage2D(v.TEXTURE_2D,0,v.RGBA,v.RGBA,v.UNSIGNED_BYTE,a);(a=z(a.width,a.height))?(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.REPEAT),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,v.REPEAT)):(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,
v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE));if(-1===w.Textures_obj[n].filterType){if(a)r=b.texture.filter.LINEAR_MIP;else if(r===b.texture.filter.LINEAR_MIP)r=b.texture.filter.LINEAR;-1===w.Textures_obj[n].filterType&&w.Textures_obj[n].setFilter(r)}else w.Textures_obj[n].setFilter(w.Textures_obj[n].filterType);if(o.onready)o.onready();v.bindTexture(v.TEXTURE_2D,null);o.loaded=!0};if(h)w.Images[this.tex_id].deferredSrc=f,h.addImage(c,f,w.Images[this.tex_id]);else if("string"===typeof f)w.Images[this.tex_id].src=
f}this.active_unit=-1};h.prototype={setFilter:function(a){if(-1<this.tex_id){var f=CubicVR.GLCore.gl;f.bindTexture(f.TEXTURE_2D,w.Textures[this.tex_id]);a===b.texture.filter.LINEAR?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR)):a===b.texture.filter.LINEAR_MIP?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR_MIPMAP_NEAREST),f.generateMipmap(f.TEXTURE_2D)):
a===b.texture.filter.NEAREST?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST)):a===b.texture.filter.NEAREST_MIP&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST_MIPMAP_LINEAR),f.generateMipmap(f.TEXTURE_2D));this.filterType=a}},use:function(b){if(-1<this.tex_id)a.gl.activeTexture(b),a.gl.bindTexture(a.gl.TEXTURE_2D,w.Textures[this.tex_id]),this.active_unit=
b},clear:function(){if(-1<this.tex_id&&-1!==this.active_unit)a.gl.activeTexture(this.active_unit),a.gl.bindTexture(a.gl.TEXTURE_2D,null),this.active_unit=-1},destroy:function(){var a=CubicVR.GLCore.gl;if(-1<this.tex_id&&w.Textures[this.tex_id])a.deleteTexture(w.Textures[this.tex_id]),delete w.Textures_obj[this.tex_id],this.tex_id=-1}};t.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=CubicVR.GLCore.gl;a.bindTexture(a.TEXTURE_2D,w.Textures[this.texture.tex_id]);
a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};r.prototype={update:function(){this.updateFunction(this.canvasSource,this.canvasContext);var a=CubicVR.GLCore.gl;a.bindTexture(a.TEXTURE_2D,w.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,
this.canvasSource);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};n.prototype={update:function(){var a=CubicVR.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,w.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};o.prototype=
{update:function(){var b=a.gl,f=b.getParameter(b.VIEWPORT);this.outputBuffer.use();b.viewport(0,0,this.width,this.height);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);this.srcTex.use(b.TEXTURE0);CubicVR.fsQuad.render(this.shaderNorm,this.fsQuad);b.bindFramebuffer(b.FRAMEBUFFER,null);b.viewport(f[0],f[1],f[2],f[3])}};c.prototype={begin:function(){var b=a.gl;this.dims=b.getParameter(b.VIEWPORT);this.outTex.use();b.viewport(0,0,this.width,this.height);this.depth?b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT):
b.clear(b.COLOR_BUFFER_BIT)},end:function(){var b=a.gl;b.bindFramebuffer(b.FRAMEBUFFER,null);b.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};g.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:h,DeferredLoadTexture:f,CanvasTexture:t,PdfTexture:r,TextTexture:function(a,b){var f=b&&b.color||"#fff",d=b&&b.bgcolor,h=b&&b.font||"18pt Arial",c=b&&b.align||"start",g=b&&b.y||0,n=b&&b.width||e,r=b&&b.height||
e,u,o=document.createElement("CANVAS"),B=o.getContext("2d"),C=0,C="string"===typeof a?1:a.length;B.font=h;var w=b&&b.lineHeight||B.measureText("OO").width,z;if(1===C)z=B.measureText(a).width;else for(u=z=0;u<C;++u){var I=B.measureText(a[u]).width;I>z&&(z=I)}o.width=n||z;o.height=r||w*C;if(d)B.fillStyle=d,B.fillRect(0,0,o.width,o.height);B.fillStyle=f;B.font=h;B.textAlign=c;B.textBaseline="top";if(1===C)f=b&&b.x||"center"===c?o.width/2:"right"===c?o.width:0,B.fillText(a,f,g);else for(u=0;u<C;++u)f=
b&&b.x||"center"===c?o.width/2:"right"===c?o.width:0,B.fillText(a[u],f,g+u*w);B.fill();this.use=t.prototype.use;this.clear=t.prototype.clear;this.update=t.prototype.update;t.apply(this,[o]);this.update();this.canvasSource=null},PJSTexture:n,NormalMapGen:o,RenderTexture:c,SceneRenderTexture:g}});
CubicVR.RegisterModule("Material",function(w){function z(a){this.blendEnabled=this.dirtyFlag=this.initialized=!1;this.textures=[];this.shader=[];this.customShader=(a=CubicVR.get(a)||{},a.shader||null);null===o&&(o=new CubicVR.CustomShader({vertex:"precision lowp float; \nattribute vec3 vertexPosition; uniform mat4 matrixModelView; uniform mat4 matrixProjection; uniform mat4 matrixObject;\nvoid main(void) { gl_Position = matrixProjection * matrixModelView * matrixObject * vec4(vertexPosition,1.0); }",
fragment:"precision lowp float; \nvoid main(void) { gl_FragColor = vec4(1.0,0.0,1.0,1.0); }\n"}),o._init_shader(o._vertex,o._fragment,!1));if(this.customShader&&!this.customShader._init_shader&&"object"===typeof this.customShader)this.customShader=new CubicVR.CustomShader(this.customShader);this.diffuse=a.diffuse||[1,1,1];this.specular=a.specular||[0.1,0.1,0.1];this.color=a.color||[1,1,1];this.ambient=a.ambient||[0,0,0];this.name=a.name||null;this.opacity=a.opacity===t?1:a.opacity;this.shininess=
a.shininess===t?1:a.shininess;this.max_smooth=a.max_smooth===t?60:a.max_smooth;this.env_amount=a.env_amount===t?0.75:a.env_amount;this.morph=a.morph===t?!1:a.morph;this.color_map=a.colorMap===t?!1:a.colorMap;this.uvOffset=a.uvOffset===t?[0,0]:a.uvOffset;if(a.textures)for(var e in a.textures)this.setTexture(a.textures[e],e)}var t=w.undef,r=w.GLCore,n=CubicVR.enums,o=null,c=[n.texture.map.REFLECT,n.texture.map.SPECULAR,n.texture.map.NORMAL,n.texture.map.BUMP],g=[],a="textureColor,textureEnvSphere,textureNormal,textureBump,textureReflect,textureSpecular,textureAmbient,textureAlpha,matrixModelView,matrixProjection,matrixObject,matrixNormal,vertexPosition,vertexNormal,vertexColor,vertexTexCoord,materialTexOffset,vertexMorphPosition,vertexMorphNormal,materialMorphWeight,lightDiffuse,lightSpecular,lightIntensity,lightDistance,lightPosition,lightDirection,lightCutOffAngle,lightShadowMap,lightProjectionMap,lightDepthClip,lightShadowMatrix,lightAmbient,materialDiffuse,materialColor,materialAmbient,materialSpecular,materialShininess,materialEnvironment,materialAlpha,postDepthInfo".split(",");
z.prototype={clone:function(){var a=new CubicVR.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,name:this.name}),e;for(e in this.textures)this.textures.hasOwnProperty(e)&&a.setTexture(this.textures[e],e);return a},setTexture:function(a,e){if(a&&(e=CubicVR.parseEnum(n.texture.map,e)||0,w.features.texturePerPixel||-1===
c.indexOf(e)))!a.use&&"string"===typeof a&&(a=w.Textures_ref[a]!==t?w.Textures_obj[w.Textures_ref[a]]:new CubicVR.Texture(a)),this.textures[e]=a},calcShaderMask:function(){var a;a=0+("object"===typeof this.textures[n.texture.map.COLOR]?n.shader.map.COLOR:0);a+="object"===typeof this.textures[n.texture.map.SPECULAR]?n.shader.map.SPECULAR:0;a+="object"===typeof this.textures[n.texture.map.NORMAL]?n.shader.map.NORMAL:0;a+="object"===typeof this.textures[n.texture.map.BUMP]?n.shader.map.BUMP:0;a+="object"===
typeof this.textures[n.texture.map.REFLECT]?n.shader.map.REFLECT:0;a+="object"===typeof this.textures[n.texture.map.ENVSPHERE]?n.shader.map.ENVSPHERE:0;a+="object"===typeof this.textures[n.texture.map.AMBIENT]?n.shader.map.AMBIENT:0;a+="object"===typeof this.textures[n.texture.map.ALPHA]?n.shader.map.ALPHA:0;a+=1!==this.opacity?n.shader.map.ALPHA:0;a+=this.color_map?n.shader.map.COLORMAP:0;if(1!==this.opacity)this.blendEnabled=!0;return a},getShaderHeader:function(a,e){return(e!==t?"#define LIGHT_COUNT "+
e+"\n":"")+"#define TEXTURE_COLOR "+("object"===typeof this.textures[n.texture.map.COLOR]?1:0)+"\n#define TEXTURE_SPECULAR "+("object"===typeof this.textures[n.texture.map.SPECULAR]?1:0)+"\n#define TEXTURE_NORMAL "+("object"===typeof this.textures[n.texture.map.NORMAL]?1:0)+"\n#define TEXTURE_BUMP "+("object"===typeof this.textures[n.texture.map.BUMP]?1:0)+"\n#define TEXTURE_REFLECT "+("object"===typeof this.textures[n.texture.map.REFLECT]?1:0)+"\n#define TEXTURE_ENVSPHERE "+("object"===typeof this.textures[n.texture.map.ENVSPHERE]?
1:0)+"\n#define TEXTURE_AMBIENT "+("object"===typeof this.textures[n.texture.map.AMBIENT]?1:0)+"\n#define TEXTURE_ALPHA "+("object"===typeof this.textures[n.texture.map.ALPHA]?1:0)+"\n#define MATERIAL_ALPHA "+(1!==this.opacity?1:0)+"\n#define LIGHT_IS_POINT "+(a===n.light.type.POINT?1:0)+"\n#define LIGHT_IS_DIRECTIONAL "+(a===n.light.type.DIRECTIONAL?1:0)+"\n#define LIGHT_IS_SPOT "+(a===n.light.type.SPOT||a===n.light.type.SPOT_SHADOW||a===n.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED "+
(a===n.light.type.SPOT_SHADOW||a===n.light.type.SPOT_SHADOW_PROJECTOR||a===n.light.type.AREA?1:0)+"\n#define LIGHT_IS_PROJECTOR "+(a===n.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED_SOFT "+(r.soft_shadow?1:0)+"\n#define LIGHT_IS_AREA "+(a===n.light.type.AREA?1:0)+"\n#define LIGHT_DEPTH_PASS "+(a===n.light.type.DEPTH_PACK?1:0)+"\n#define FX_DEPTH_ALPHA "+(r.depth_alpha?1:0)+"\n#define VERTEX_MORPH "+(this.morph?1:0)+"\n#define VERTEX_COLOR "+(this.color_map?1:0)+"\n#define LIGHT_PERPIXEL "+
(w.features.lightPerPixel?1:0)+"\n\n"},bindObject:function(a,e){var d=r.gl,f=e.vertexPosition,h=e.vertexTexCoord,m=e.vertexNormal,q=e.vertexColor;d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_points);d.vertexAttribPointer(f,3,d.FLOAT,!1,0,0);d.enableVertexAttribArray(f);null!==h&&null!==a.compiled.gl_uvs&&-1!==h&&(d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_uvs),d.vertexAttribPointer(h,2,d.FLOAT,!1,0,0),d.enableVertexAttribArray(h));g.uv=h;null!==m&&null!==a.compiled.gl_normals&&-1!==m&&(d.bindBuffer(d.ARRAY_BUFFER,
a.compiled.gl_normals),d.vertexAttribPointer(m,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(m));g.un=m;null!==q&&null!==a.compiled.gl_colors&&-1!==q&&(d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_colors),d.vertexAttribPointer(q,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(q));g.uc=q;if(a.morphTarget)f=e.vertexMorphPosition,m=e.vertexMorphNormal,d.bindBuffer(d.ARRAY_BUFFER,a.morphTarget.gl_points),d.vertexAttribPointer(f,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(f),null!==m&&null!==a.morphTarget.gl_normals&&
-1!==m&&(d.bindBuffer(d.ARRAY_BUFFER,a.morphTarget.gl_normals),d.vertexAttribPointer(m,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(m)),d.uniform1f(e.materialMorphWeight,a.morphWeight);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a.compiled.gl_elements)},clearObject:function(a,e){var d=r.gl;g.uv!==t&&-1!==g.uv&&d.disableVertexAttribArray(g.uv);g.un!==t&&-1!==g.un&&d.disableVertexAttribArray(g.un);g.uc!==t&&-1!==g.uc&&d.disableVertexAttribArray(g.uc);if(a.morphTarget&&e)up=e.vertexMorphPosition,d.disableVertexAttribArray(up),
un=e.vertexMorphNormal,null!==un&&null!==a.compiled.gl_normals&&-1!==un&&d.disableVertexAttribArray(un)},use:function(b,e){var d,f=r.gl,h=this.textures,m=!0,e=e||0,b=b||0;this.shader[b]||(this.shader[b]=[]);var q=this.shader[b][e];d=this.customShader&&b===n.light.type.DEPTH_PACK&&!this.customShader.hasDepthPack();if(q&&1!==this.opacity&&!0!==this.blendEnabled)this.dirtyFlag=!0;if(!0===this.dirtyFlag)q=null,this.dirtyFlag=!1;if(q)m=q!==o,q.use(),this.customShader&&!d&&this.customShader._doUpdate();
else{var c=this.calcShaderMask(b);if(!this.customShader||d)w.ShaderPool[b][c]||(w.ShaderPool[b][c]=[]),q=w.ShaderPool[b][c][e];if(!q){var s=this.getShaderHeader(b,e),g=s+r.CoreShader_vs,s=s+r.CoreShader_fs;this.customShader&&!d?this.customShader._initialized||(this.customShader._init_shader(g,s,a),q=this.customShader.getShader(),q.isCompiled()||(m=!1,q=o.getShader())):(q=new CubicVR.Shader(g,s),q.isCompiled()||(m=!1,q=o.getShader()),w.ShaderPool[b][c][e]=q);d=0;if(b!==n.light.type.DEPTH_PACK){if(b===
n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)d+=e,b===n.light.type.SPOT_SHADOW_PROJECTOR&&(d+=e);"object"===typeof h[n.texture.map.COLOR]&&q.addInt("textureColor",d++);"object"===typeof h[n.texture.map.ENVSPHERE]&&q.addInt("textureEnvSphere",d++);"object"===typeof h[n.texture.map.NORMAL]&&q.addInt("textureNormal",d++);"object"===typeof h[n.texture.map.BUMP]&&q.addInt("textureBump",d++);"object"===typeof h[n.texture.map.REFLECT]&&q.addInt("textureReflect",
d++);"object"===typeof h[n.texture.map.SPECULAR]&&q.addInt("textureSpecular",d++);"object"===typeof h[n.texture.map.AMBIENT]&&q.addInt("textureAmbient",d++)}"object"===typeof h[n.texture.map.ALPHA]&&q.addInt("textureAlpha",d++);q.addMatrix("matrixModelView");q.addMatrix("matrixProjection");q.addMatrix("matrixObject");q.addMatrix("matrixNormal");q.addVertexArray("vertexPosition");q.addVertexArray("vertexNormal");this.color_map&&q.addVertexArray("vertexColor");this.morph&&(q.addVertexArray("vertexMorphPosition"),
q.addVertexArray("vertexMorphNormal"),q.addFloat("materialMorphWeight",0));for(d=0;d<e;d++)if(q.addVector("lightDiffuse["+d+"]"),q.addVector("lightSpecular["+d+"]"),q.addFloat("lightIntensity["+d+"]"),q.addFloat("lightDistance["+d+"]"),q.addVector("lightPosition["+d+"]"),q.addVector("lightDirection["+d+"]"),(b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.SPOT)&&q.addFloat("lightCutOffAngle["+d+"]"),b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||
b===n.light.type.AREA)q.addInt("lightShadowMap["+d+"]"),b===n.light.type.SPOT_SHADOW_PROJECTOR&&q.addInt("lightProjectionMap["+d+"]"),q.addVector("lightDepthClip["+d+"]"),q.addMatrix("lightShadowMatrix["+d+"]");b!==n.light.type.DEPTH_PACK&&(q.addVector("lightAmbient"),q.addVector("materialDiffuse"),q.addVector("materialColor"),q.addVector("materialAmbient"),q.addVector("materialSpecular"),q.addFloat("materialShininess"),q.addFloat("materialEnvironment"));q.addFloat("materialAlpha");(r.depth_alpha||
b===n.light.type.DEPTH_PACK||b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)&&q.addVector("postDepthInfo");q.addUVArray("vertexTexCoord");q.addVector("materialTexOffset")}this.shader[b][e]=q;q.use();-1!=q.materialTexOffset&&f.uniform2fv(q.materialTexOffset,[0,0]);this.customShader&&this.customShader._doUpdate()}d=0;var v;if(b!==n.light.type.DEPTH_PACK){if(b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)d+=e,b===
n.light.type.SPOT_SHADOW_PROJECTOR&&(d+=e);if(v=h[n.texture.map.COLOR])v.use(r.gl.TEXTURE0+d),d++;if(v=h[n.texture.map.ENVSPHERE])v.use(r.gl.TEXTURE0+d),d++,f.uniform1f(q.materialEnvironment,this.env_amount);if(v=h[n.texture.map.NORMAL])v.use(r.gl.TEXTURE0+d),d++;if(v=h[n.texture.map.BUMP])v.use(r.gl.TEXTURE0+d),d++;if(v=h[n.texture.map.REFLECT])v.use(r.gl.TEXTURE0+d),d++;if(v=h[n.texture.map.SPECULAR])v.use(r.gl.TEXTURE0+d),d++;if(v=h[n.texture.map.AMBIENT])v.use(r.gl.TEXTURE0+d),d++}(v=h[n.texture.map.ALPHA])&&
v.use(r.gl.TEXTURE0+d);b!==n.light.type.DEPTH_PACK?(f.uniform3fv(q.materialColor,this.color),f.uniform3fv(q.materialDiffuse,this.diffuse),f.uniform3fv(q.materialAmbient,this.ambient),f.uniform3fv(q.materialSpecular,this.specular),f.uniform1f(q.materialShininess,128*this.shininess),f.uniform3fv(q.lightAmbient,CubicVR.globalAmbient),1!==this.opacity&&f.uniform1f(q.materialAlpha,this.opacity),(r.depth_alpha||b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)&&
f.uniform3fv(q.postDepthInfo,[r.depth_alpha_near,r.depth_alpha_far,0])):f.uniform3fv(q.postDepthInfo,[r.shadow_near,r.shadow_far,0]);q.materialTexOffset&&f.uniform2fv(q.materialTexOffset,this.uvOffset);return m}};return{Material:z}});
CubicVR.RegisterModule("Mesh",function(w){function z(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function t(c){this.compiled=null;this.materials=[];this.edges=this.instanceMaterials=this.bb=null;this.faces=[];this.points=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.morphTarget=this.morphTargets=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.originBuffer=null;c=CubicVR.get(c)||
{};if(c instanceof CubicVR.Mesh)this.booleanAdd(c),c._clones=c._clones||1,c._clones++,this.name=c.name?c.name+"_copy"+c._clones:null;else{this.name=c.name||null;this.dynamic=c.dynamic||!1;if(c.material){var g=c.material;g.length?this.materials=g:"object"===typeof g&&(g.use?this.setFaceMaterial(g):this.setFaceMaterial(new CubicVR.Material(g)))}c.points&&this.build(c);c.part?this.build(c.part):c.parts&&this.build(c.parts);if((this.primitives=c.primitives||c.primitive||null)&&!this.primitives.length||
"string"===typeof this.primitives)this.primitives=[this.primitives];if(this.primitives&&this.primitives.length)for(var g=0,a=this.primitives.length;g<a;g++){var b=this.primitives[g];"string"===typeof b&&(b=CubicVR.get(b));var e=CubicVR.primitives[b.type];if(b.type&&e)this.booleanAdd(e(b));else if(b.type){o("Mesh error, primitive "+b.type+" is unknown.");var b="",d;for(d in CubicVR.primitives)CubicVR.primitives.hasOwnProperty(d)&&(""!==b&&(b+=", "),b+=d);o("Available primitive types are: "+b)}else o("Mesh error, primitive "+
(g+1)+" lacks type.")}this.buildWireframe=c.buildWireframe||c.wireframe||!!c.wireframeMaterial||c.triangulateWireframe||!1;this.triangulateWireframe=c.triangulateWireframe||null;this.wireframeMaterial=CubicVR.get(c.wireframeMaterial,CubicVR.Material)||null;this.wireframe=c.wireframe||!1;c.flipFaces&&this.faces.length&&this.flipFaces();(c.prepare||c.compile&&this.faces.length)&&this.prepare();(c.clean||c.compile&&this.faces.length&&!this.dynamic)&&this.clean();c.calcNormals&&!c.compile&&!c.prepare&&
this.calcNormals()}}var r=w.undef,n=w.GLCore,o=w.log;z.prototype={setUV:function(c,g){g!==r?this.uvs[g]=c:2!==c.length?this.uvs=c:this.uvs.push(c)},setColor:function(c,g){g!==r?this.point_colors[g]=c:"number"!==typeof c[0]?this.point_colors=c:this.point_colors.push(c)},flip:function(){for(var c=0,g=this.point_normals.length;c<g;c++)this.point_normals[c]=[-this.point_normals[c][0],-this.point_normals[c][1],-this.point_normals[c][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();
this.normal=[-this.normal[0],-this.normal[1],-this.normal[2]]}};t.prototype={setWireframe:function(c){this.wireframe=c},isWireframe:function(){return this.wireframe},setWireframeMaterial:function(c){this.wireframeMaterial=c},build:function(c,g){var a,b;"string"===typeof c&&(c=CubicVR.get(c));c&&!c.length&&(c=[c]);var e=this.faces.length;g&&g.length&&this.points.concat(g);for(var d=0,f=c.length;d<f;d++){var h=c[d];a=h.material;b=h.points;var m=h.faces,q=h.uv,y=h.color,h=h.segment||null;null!==h&&this.setSegment(parseInt(h,
10));if(b&&b.length&&(this.points=this.points.concat(b),m&&e)){m=m.slice(0);b=0;for(h=m.length;b<h;b++)for(var s=m[b],A=0,v=m.length;A<v;A++)s[A]+=e}if(a)a.length?this.materials=a:"object"===typeof a&&(a.use?this.setFaceMaterial(a):this.setFaceMaterial(new CubicVR.Material(a)));m&&m.length&&this.addFace(m);if(m&&q&&"object"===typeof q){h=null;if(q.length&&q.length===m.length)if(q.length===m.length)for(a=0,b=q.length;a<b;a++)this.faces[a+e].setUV(q[a]);else o("Mesh error in part, face count: "+m.length+
", uv count:"+q.length);else h=q.apply?q:new CubicVR.UVMapper(q);h&&h.apply(this,this.currentMaterial,this.currentSegment,e,this.faces.length-e)}if(m&&y&&"object"===typeof y)if(y.length&&y.length===m.length){for(a=0,b=y.length;a<b;a++)this.faces[a+e].setColor(y[a]);this.materials[this.currentMaterial].colorMap=!0}else o("Mesh error in part, face count: "+m.length+", color count:"+y.length)}return this},showAllSegments:function(){for(var c in this.segment_state)this.segment_state.hasOwnProperty(c)&&
(this.segment_state[c]=!0)},hideAllSegments:function(){for(var c in this.segment_state)this.segment_state.hasOwnProperty(c)&&(this.segment_state[c]=!1)},setSegment:function(c,g){g!==r?this.segment_state[c]=g:this.currentSegment=c},addPoint:function(c){if(3!==c.length||"object"===typeof c[0])for(var g=0,a=c.length;g<a;g++)this.points.push(c[g]);else this.points.push(c);return this.points.length-1},getMaterialIndex:function(c){return this.materials.indexOf(c)},setFaceMaterial:function(c,g){var a;"number"==
typeof c?a=c:(a=this.materials.indexOf(c),-1===a&&(this.materials.push(c),a=this.materials.length-1));if(g!==r){if(this.faces[g]!==r)this.faces[g].material=a}else this.currentMaterial=a;return this},addFace:function(c,g,a,b){if("number"!==typeof c[0]){g=0;for(a=c.length;g<a;g++)this.addFace(c[g])}else{g===r?(this.currentFace=this.faces.length,this.faces.push(new z)):(this.faces[g]===r&&(this.faces[g]=new z),this.currentFace=g);if("object"===typeof c)this.faces[this.currentFace].points=c;a!==r?this.setFaceMaterial(a,
this.currentFace):this.faces[this.currentFace].material=this.currentMaterial;this.faces[this.currentFace].segment=b!==r?b:this.currentSegment;return this.currentFace}},flipFaces:function(){for(var c=0,g=this.faces.length;c<g;c++)this.faces[c].flip()},triangulateQuads:function(){for(var c=0,g=this.faces.length;c<g;c++)if(4===this.faces[c].points.length){var a=this.faces.length;this.addFace([this.faces[c].points[2],this.faces[c].points[3],this.faces[c].points[0]],this.faces.length,this.faces[c].material,
this.faces[c].segment);this.faces[c].points.pop();this.faces[a].normal=this.faces[c].normal.slice(0);4===this.faces[c].point_colors.length&&(this.faces[a].setColor(this.faces[c].point_colors[2],0),this.faces[a].setColor(this.faces[c].point_colors[3],1),this.faces[a].setColor(this.faces[c].point_colors[0],2),this.faces[c].point_colors.pop());4===this.faces[c].uvs.length&&(this.faces[a].setUV(this.faces[c].uvs[2],0),this.faces[a].setUV(this.faces[c].uvs[3],1),this.faces[a].setUV(this.faces[c].uvs[0],
2),this.faces[c].uvs.pop());4===this.faces[c].point_normals.length&&(this.faces[a].point_normals[0]=this.faces[c].point_normals[2],this.faces[a].point_normals[1]=this.faces[c].point_normals[3],this.faces[a].point_normals[2]=this.faces[c].point_normals[0],this.faces[c].point_normals.pop())}return this},booleanAdd:function(c,g){var a=CubicVR.mat4,b=this.points.length,e,d,f,h;e=g;g=e===r?r:"array"===typeof e?e:"object"===typeof e?e.getResult?e.getResult():e.position||e.rotation||e.scale?CubicVR.mat4.transform(e.position,
e.rotation,e.scale):r:void 0;if(c.wireframeMaterial)this.wireframeMaterial=c.wireframeMaterial;if(g!==r){d=g;for(e=0,f=c.points.length;e<f;e++)this.addPoint(a.vec3_multiply(c.points[e],d))}else for(e=0,f=c.points.length;e<f;e++)this.addPoint([c.points[e][0],c.points[e][1],c.points[e][2]]);a=[];for(e=0,f=c.materials.length;e<f;e++)d=this.materials.indexOf(c.materials[e]),-1===d?(this.materials.push(c.materials[e]),a[e]=this.materials.length-1):a[e]=d;for(e=0,f=c.faces.length;e<f;e++){var m=[];for(d=
0,h=c.faces[e].points.length;d<h;d++)m.push(c.faces[e].points[d]+b);m=this.faces[this.addFace(m)];m.segment=c.faces[e].segment;m.material=a[c.faces[e].material];if(m.material===r)m.material=0;for(d=0,h=c.faces[e].uvs.length;d<h;d++)m.uvs[d]=[c.faces[e].uvs[d][0],c.faces[e].uvs[d][1]];for(d=0,h=c.faces[e].point_normals.length;d<h;d++)m.point_normals[d]=[c.faces[e].point_normals[d][0],c.faces[e].point_normals[d][1],c.faces[e].point_normals[d][2]]}return this},calcFaceNormals:function(c,g){var a=CubicVR.vec3,
b=CubicVR.triangle,e=0,d=this.faces.length,f,h=this.points,m;c&&(e=c);for(g&&(d=g+1);e<d;e++)f=this.faces[e],m=f.points,3>m.length?f.normal=[0,0,0]:a.normalize(b.normal(h[m[0]],h[m[1]],h[m[2]],f.normal));return this},getMaterial:function(c){for(var g=0,a=this.materials.length;g<a;g++)if(this.materials[g].name===c)return this.materials[g];return null},bindInstanceMaterials:function(c){this.instanceMaterials=c},calcNormals:function(c){var g=CubicVR.vec3,a=!1,b;this.dynamic&&(b=[],c=c||{});c!==r&&(b=
[],a=!0);this.calcFaceNormals();var e,d,f,h,m=Array(this.points.length);for(e=0,h=m.length;e<h;e++)m[e]=[];h=this.faces.length;for(e=0;e<h;e++){f=this.faces[e].points.length;for(d=0;d<f;d++)m[this.faces[e].points[d]].push([e,d])}for(e=0,h=this.points.length;e<h;e++){var q=m[e].length;for(d=0;d<q;d++){var y=1,s=m[e][d][0],A=m[e][d][1],v=this.materials.length?this.materials[this.faces[s].material].max_smooth:60,n=this.faces[s];a&&(b[s]===r&&(b[s]=[]),b[s][A]===r&&(b[s][A]=[]));var o=Array(3);o[0]=n.normal[0];
o[1]=n.normal[1];o[2]=n.normal[2];if(0!==v)for(f=0;f<q;f++)if(d!==f){var t=m[e][f][0],u=this.faces[t],x=g.angle(u.normal,n.normal);if(x!==x||x*(180/Math.PI)<=v)a&&b[s][A].push(t),o[0]+=u.normal[0],o[1]+=u.normal[1],o[2]+=u.normal[2],y++}o[0]/=y;o[1]/=y;o[2]/=y;this.faces[s].point_normals[A]=g.normalize(o)}}if(a){g=0;for(e=0,h=b.length;e<h;e++)for(d=0,f=b[e].length;d<f;d++)g+=b[e][d].length;if(!c.faceCount)c.faceCount=new Uint8Array(3*this.faces.length);if(!c.faceNorm)c.faceNorm=new Uint16Array(g);
g=0;for(e=0,h=this.faces.length;e<h;e++)for(d=0;3>d;d++)if(a=b[e][d],c.faceCount[3*e+d]=a?a.length:0,a)for(f=0,a=a.length;f<a;f++)c.faceNorm[g++]=b[e][d][f];else g++;this.normalMapRef=c}return this},recalcNormals:function(c){var g,a,b,e,d,f,h,m,q,y;if(c=c||this.normalMapRef){this.calcFaceNormals();var s=0,A=0,v=0,n;for(g=0,a=this.faces.length;g<a;g++){q=this.faces[g];n=q.normal;for(j=0;3>j;j++){m=q.point_normals[j];d=n[0];f=n[1];h=n[2];y=c.faceCount[A++];for(b=0,iMax=y;b<iMax;b++)e=c.faceNorm[s++],
e=this.faces[e],e=e.normal,d+=e[0],f+=e[1],h+=e[2];y?(b=y+1,d/=b,f/=b,h/=b,b=Math.sqrt(d*d+f*f+h*h),d/=b,f/=b,h/=b,m[0]=d,m[1]=f,m[2]=h):v++}}return this}},removeDoubles:function(c){var g=[],a=[],b,e,d,f;for(b=0,e=this.points.length;b<e;b++){var h=-1,m=this.points[b];for(d=0,f=g.length;d<f;d++)if(CubicVR.vec3.equal(m,g[d],c)){h=d;break}-1!=h?a[b]=h:(a[b]=g.length,g.push(this.points[b]))}this.points=g;for(b=0,e=this.faces.length;b<e;b++){c=this.faces[b];for(d=0,f=c.points.length;d<f;d++)c.points[d]=
a[c.points[d]]}return this},buildEdges:function(){var c,g,a,b,e=[],d=[];for(c=0,a=this.faces.length;c<a;c++){var f=this.faces[c];for(g=0,b=f.points.length;g<b;g++){var h,m,q;q=f.segment;matId=f.material;g?(m=f.points[g],h=f.points[g-1]):(m=f.points[g],h=f.points[b-1]);e[h]=e[h]||{};e[h][matId]=e[h][matId]||{};e[h][matId][q]=e[h][matId][q]||{};!e[h][matId][q][m]&&(!e[m]||!e[m][matId][q][h])&&d.push([matId,q,h,m])}}this.edges=d;return this},subdivide:function(c,g){var a=CubicVR.vec3,g=g===r?!0:g;c===
r&&(c=1);if(0!==c){var b,e,d,f,h,m={},q=[],y=[],s=this.points.length,A=this.faces.length,v=[],n=[],t=[],E=[];for(b=0,d=A;b<d;b++)if(h=this.faces[b],h.points&&(3===h.points.length||4===h.points.length)){var u=[0,0,0];for(e=0,f=h.points.length;e<f;e++){var x=this.points[h.points[e]];u[0]+=x[0];u[1]+=x[1];u[2]+=x[2]}u[0]/=f;u[1]/=f;u[2]/=f;v[b]=this.addPoint(u);if(h.uvs.length===h.points.length){u=[0,0];for(e=0,f=h.uvs.length;e<f;e++)x=h.uvs[e],u[0]+=x[0],u[1]+=x[1];u[0]/=f;u[1]/=f;n[b]=u}if(h.point_colors.length===
h.points.length){u=[0,0,0];for(e=0,f=h.point_colors.length;e<f;e++)x=h.point_colors[e],u[0]+=x[0],u[1]+=x[1],u[2]+=x[2];u[0]/=f;u[1]/=f;u[2]/=f;t[b]=u}if(h.point_normals.length===h.points.length){u=[0,0,0];for(e=0,f=h.point_normals.length;e<f;e++)x=h.point_normals[e],u[0]+=x[0],u[1]+=x[1],u[2]+=x[2];u[0]/=f;u[1]/=f;u[2]/=f;E[b]=u}}for(b=0,d=this.faces.length;b<d;b++){h=this.faces[b];for(e=0,f=h.points.length;e<f;e++){var B,w;e?(B=e,w=e-1):(B=e,w=f-1);x=h.points[B];u=h.points[w];m[u]=m[u]||{};q[u]=
q[u]||[];q[u].push(b);m[u][x]={face:b,a:u,b:x,fpa:B,fpb:w}}}for(b in m)if(m.hasOwnProperty(b))for(e in m[b])if(m[b].hasOwnProperty(e)){d=m[b][e];h=m[e][b];if(h===r){o("Mesh.subdivide error. Hole at face #"+d.face+", Edge:["+d.fpa+"->"+d.fpb+"], holes not yet supported; perhaps use Mesh.removeDoubles()?");return}if(!d.edge_point)f=a.multiply(a.add(this.points[d.a],this.points[d.b]),0.5),g?(u=a.multiply(a.add(this.points[v[d.face]],this.points[v[h.face]]),0.5),d.edge_point=a.multiply(a.add(f,u),0.5)):
d.edge_point=f,h.edge_point=d.edge_point,d.edge_avg=f,h.edge_avg=f,d.ep_idx=this.addPoint(d.edge_point),h.ep_idx=d.ep_idx;y[d.a]=y[d.a]||[];y[d.a].push(d.edge_avg);f=this.faces[d.face].uvs;if(f.length)h=f[d.fpa],f=f[d.fpb],d.uv=[(h[0]+f[0])/2,(h[1]+f[1])/2];h=this.faces[d.face].point_colors;if(h.length)d.color=a.multiply(a.add(h[d.fpa],h[d.fpb]),0.5);h=this.faces[d.face].point_normals;if(h.length)d.normal=a.normalize(a.multiply(a.add(h[d.fpa],h[d.fpb]),0.5))}if(g){h=[];for(b=0,d=s;b<d;b++)if(u=[0,
0,0],q[b]){for(e=0,f=q[b].length;e<f;e++)x=this.points[v[q[b][e]]],u[0]+=x[0],u[1]+=x[1],u[2]+=x[2];u[0]/=f;u[1]/=f;u[2]/=f;h[b]=u}u=[];for(b=0,d=s;b<d;b++)if(x=[0,0,0],y[b]){for(e=0,f=y[b].length;e<f;e++)B=y[b][e],x[0]+=B[0],x[1]+=B[1],x[2]+=B[2];x[0]/=f;x[1]/=f;x[2]/=f;u[b]=x}for(b=0,d=s;b<d;b++)if(q[b])s=q[b].length,e=1/s,y=2/s,s=a.multiply(this.points[b],(s-3)/s),s=a.add(s,a.multiply(h[b],e)),s=a.add(s,a.multiply(u[b],y)),this.points[b]=s}for(b=0;b<A;b++)if(h=this.faces[b],!(3!==h.points.length&&
4!==h.points.length))if(a=h.points.slice(0),q=h.uvs.slice(0),e=h.point_colors.slice(0),y=h.point_normals.slice(0),s=q.length===a.length,d=e.length===a.length,f=y.length===a.length,h=h.material,3===a.length){this.setFaceMaterial(h);u=m[a[0]][a[1]];x=m[a[2]][a[0]];this.addFace([a[0],u.ep_idx,v[b],x.ep_idx],b);if(s)this.faces[b].uvs=[q[0],u.uv,n[b],x.uv];if(d)this.faces[b].point_colors=[e[0],u.color,t[b],x.color];if(f)this.faces[b].point_normals=[y[0],u.normal,E[b],x.normal];u=m[a[1]][a[2]];x=m[a[0]][a[1]];
h=this.addFace([a[1],u.ep_idx,v[b],x.ep_idx]);if(s)this.faces[h].uvs=[q[1],u.uv,n[b],x.uv];if(d)this.faces[h].point_colors=[e[1],u.color,t[b],x.color];if(f)this.faces[h].point_normals=[y[1],u.normal,E[b],x.normal];u=m[a[2]][a[0]];x=m[a[1]][a[2]];h=this.addFace([a[2],u.ep_idx,v[b],x.ep_idx]);if(s)this.faces[h].uvs=[q[2],u.uv,n[b],x.uv];if(d)this.faces[h].point_colors=[e[2],u.color,t[b],x.color];if(f)this.faces[h].point_normals=[y[2],u.normal,E[b],x.normal]}else{this.setFaceMaterial(h);u=m[a[0]][a[1]];
x=m[a[3]][a[0]];this.addFace([a[0],u.ep_idx,v[b],x.ep_idx],b);if(s)this.faces[b].uvs=[q[0],u.uv,n[b],x.uv];if(d)this.faces[b].point_colors=[e[0],u.color,t[b],x.color];if(f)this.faces[b].point_normals=[y[0],u.normal,E[b],x.normal];u=m[a[1]][a[2]];x=m[a[0]][a[1]];h=this.addFace([a[1],u.ep_idx,v[b],x.ep_idx]);if(s)this.faces[h].uvs=[q[1],u.uv,n[b],x.uv];if(d)this.faces[h].point_colors=[e[1],u.color,t[b],x.color];if(f)this.faces[h].point_normals=[y[1],u.normal,E[b],x.normal];u=m[a[2]][a[3]];x=m[a[1]][a[2]];
h=this.addFace([a[2],u.ep_idx,v[b],x.ep_idx]);if(s)this.faces[h].uvs=[q[2],u.uv,n[b],x.uv];if(d)this.faces[h].point_colors=[e[2],u.color,t[b],x.color];if(f)this.faces[h].point_normals=[y[2],u.normal,E[b],x.normal];u=m[a[3]][a[0]];x=m[a[2]][a[3]];h=this.addFace([a[3],u.ep_idx,v[b],x.ep_idx]);if(s)this.faces[h].uvs=[q[3],u.uv,n[b],x.uv];if(d)this.faces[h].point_colors=[e[3],u.color,t[b],x.color];if(f)this.faces[h].point_normals=[y[3],u.normal,E[b],x.normal]}c--;if(0!==c)this.subdivide(c,g);else return this}},
removeInternals:function(){var c,g,a,b,e,d={},f=this.faces.length,h,m,q,y;for(c=0,a=this.faces.length;c<a;c++){e=this.faces[c];for(g=0,b=e.points.length;g<b;g++)g?(q=g,y=g-1):(q=g,y=b-1),h=e.points[q],m=e.points[y],d[h]=d[h]||{},d[h][m]===r?d[h][m]=[c]:d[h][m].push(c)}a=function(a){return-1!==d[m][h].indexOf(a)};for(c=0;c<f;c++){e=this.faces[c];var s=null;for(g=0,b=e.points.length;g<b;g++)g?(q=g,y=g-1):(q=g,y=b-1),h=e.points[q],m=e.points[y],s=s?s.filter(a):d[m][h];s.length&&(this.faces.splice(c,
1),f--,c--)}return this},prepare:function(c){c===r&&(c=!0);this.buildWireframe&&!this.triangulateWireframe&&this.buildEdges();this.triangulateQuads().calcNormals();this.buildWireframe&&this.triangulateWireframe&&this.buildEdges();this.compile();c&&!this.dynamic&&this.clean();return this},clean:function(){var c,g;for(c=0,g=this.points.length;c<g;c++)delete this.points[c],this.points[c]=null;this.points=[];for(c=0,g=this.faces.length;c<g;c++)delete this.faces[c].points,delete this.faces[c].point_normals,
delete this.faces[c].uvs,delete this.faces[c].normal,delete this.faces[c],this.faces[c]=null;this.faces=[];return this},compileMap:function(c){var g=CubicVR.vec3,a=CubicVR.vec2;c===r&&(c=1.0E-5);var b={segments:[],bounds:[]},e=[],d,f,h,m,q,y,s,A;this.materials.length||this.materials.push(new CubicVR.Material);for(d=0,y=this.materials.length;d<y;d++)e[d]=[];for(d=0,y=this.faces.length;d<y;d++)if(3===this.faces[d].points.length)h=this.faces[d].material,m=this.faces[d].segment,e[h][m]===r&&(e[h][m]=
[],b.segments.push(m)),e[h][m].push(d);var v=[],n=0,o=!1,t=!1,u=!1,x;for(d=0,y=e.length;d<y;d++)for(f in e[d])if(e[d].hasOwnProperty(f))for(h=0;h<e[d][f].length;h++)x=e[d][f][h],o=o||0!==this.faces[x].uvs.length,t=t||0!==this.faces[x].point_normals.length,u=u||0!==this.faces[x].point_colors.length;if(o)for(d=0;d<this.faces.length;d++)if(!this.faces[d].uvs.length)for(f=0;f<this.faces[d].points.length;f++)this.faces[d].uvs.push([0,0]);if(t)for(d=0;d<this.faces.length;d++)if(!this.faces[d].point_normals.length)for(f=
0;f<this.faces[d].points.length;f++)this.faces[d].point_normals.push([0,0,0]);if(u)for(d=0;d<this.faces.length;d++)if(!this.faces[d].point_colors.length)for(f=0;f<this.faces[d].points.length;f++)this.faces[d].point_colors.push([0,0,0]);for(d=0,y=e.length;d<y;d++)for(f in e[d])if(e[d].hasOwnProperty(f))for(h=0,s=e[d][f].length;h<s;h++){x=e[d][f][h];for(m=0;3>m;m++){var B=this.faces[x].points[m],w=-1;if(v[B]!==r)for(q=0,A=v[B].length;q<A;q++){var z=v[B][q][0],K=v[B][q][1],w=v[B][q][2];t&&(w=g.equal(this.faces[z].point_normals[K],
this.faces[x].point_normals[m],c)?w:-1);o&&(w=a.equal(this.faces[z].uvs[K],this.faces[x].uvs[m],c)?w:-1);u&&(w=g.equal(this.faces[z].point_colors[K],this.faces[x].point_colors[m],c)?w:-1)}if(-1!==w){if(b.elements===r)b.elements=[];b.elements[d]===r&&(b.elements[d]=[]);b.elements[d][f]===r&&(b.elements[d][f]=[]);b.elements[d][f].push(w)}else{if(b.points===r)b.points=[];b.points.push(B);0===b.bounds.length?(b.bounds[0]=[this.points[B][0],this.points[B][1],this.points[B][2]],b.bounds[1]=[this.points[B][0],
this.points[B][1],this.points[B][2]]):(this.points[B][0]<b.bounds[0][0]&&(b.bounds[0][0]=this.points[B][0]),this.points[B][1]<b.bounds[0][1]&&(b.bounds[0][1]=this.points[B][1]),this.points[B][2]<b.bounds[0][2]&&(b.bounds[0][2]=this.points[B][2]),this.points[B][0]>b.bounds[1][0]&&(b.bounds[1][0]=this.points[B][0]),this.points[B][1]>b.bounds[1][1]&&(b.bounds[1][1]=this.points[B][1]),this.points[B][2]>b.bounds[1][2]&&(b.bounds[1][2]=this.points[B][2]));if(t){if(b.normals===r)b.normals=[];b.normals.push([x,
m])}if(u){if(b.colors===r)b.colors=[];b.colors.push([x,m])}if(o){if(b.uvs===r)b.uvs=[];b.uvs.push([x,m])}if(b.elements===r)b.elements=[];b.elements[d]===r&&(b.elements[d]=[]);b.elements[d][f]===r&&(b.elements[d][f]=[]);b.elements[d][f].push(n);v[B]===r&&(v[B]=[]);v[B].push([x,m,n]);n++}}}if(this.edges){b.line_elements=[];for(d=0,y=this.edges.length;d<y;d++)g=this.edges[d],h=g[0],m=g[1],c=g[2],g=g[3],b.line_elements[h]=b.line_elements[h]||[],b.line_elements[h][m]=b.line_elements[h][m]||[],b.line_elements[h][m].push(v[c][0][2]),
b.line_elements[h][m].push(v[g][0][2])}b.dynamic=this.dynamic;return b},compileVBO:function(c,g,a,b,e,d,f,h){if("object"==typeof g)g=g.element!==r?g.element:!0,a=g.vertex!==r?g.vertex:!0,d=g.color!==r?g.color:!0,b=g.normal!==r?g.normal:!0,e=g.uv!==r?g.uv:!0,f=g.lines!==r?g.lines:!!c.line_elements,h=g.dynamic!==r?g.dynamic:c.dynamic;else if(g===r&&(g=!0),a===r&&(a=!0),d===r&&(d=!0),b===r&&(b=!0),e===r&&(e=!0),f===r&&(f=!!c.line_elements),h===r)h=c.dynamic;var m={},q,y,s,A;if(h)A={points:new Int16Array(c.points.length),
face_points:new Int16Array(2*c.points.length)},m.dynamicMap=A,m.dynamic=!0;if(c.points&&a){q=c.points.length;m.vbo_points=new Float32Array(3*q);for(a=0;a<q;a++)y=c.points[a],m.vbo_points[3*a]=this.points[y][0],m.vbo_points[3*a+1]=this.points[y][1],m.vbo_points[3*a+2]=this.points[y][2],h&&(A.points[a]=y)}if(h){h=c.normals||c.colors||c.uvs;for(a=0,q=h.length;a<q;a++)y=h[a],A.face_points[2*a]=y[0],A.face_points[2*a+1]=y[1]}if(c.normals&&b){q=c.normals.length;m.vbo_normals=new Float32Array(3*q);for(a=
b=0;a<q;a++)y=c.normals[a],m.vbo_normals[b++]=this.faces[y[0]].point_normals[y[1]][0],m.vbo_normals[b++]=this.faces[y[0]].point_normals[y[1]][1],m.vbo_normals[b++]=this.faces[y[0]].point_normals[y[1]][2]}if(c.colors&&d){q=c.colors.length;m.vbo_colors=new Float32Array(3*q);for(a=b=0;a<q;a++)y=c.colors[a],m.vbo_colors[b++]=this.faces[y[0]].point_colors[y[1]][0],m.vbo_colors[b++]=this.faces[y[0]].point_colors[y[1]][1],m.vbo_colors[b++]=this.faces[y[0]].point_colors[y[1]][2]}if(c.uvs&&e){q=c.uvs.length;
m.vbo_uvs=new Float32Array(2*q);for(a=b=0;a<q;a++)y=c.uvs[a],m.vbo_uvs[b++]=this.faces[y[0]].uvs[y[1]][0],m.vbo_uvs[b++]=this.faces[y[0]].uvs[y[1]][1]}if(g){m.elements_ref=[];m.vbo_elements=[];for(a=0,q=c.elements.length;a<q;a++)for(s in m.elements_ref[a]=[],g=0,c.elements[a])if(c.elements[a].hasOwnProperty(s)){b=c.elements[a][s];for(e=0,d=b.length;e<d;e++)m.vbo_elements.push(b[e]);m.elements_ref[a][g]=[s|0,b.length|0];g++}m.vbo_elements=new Uint16Array(m.vbo_elements)}if(f){m.line_elements_ref=[];
m.vbo_line_elements=[];for(a=0,q=c.line_elements.length;a<q;a++)for(s in m.line_elements_ref[a]=[],g=0,c.line_elements[a])if(c.line_elements[a].hasOwnProperty(s)){b=c.line_elements[a][s];for(e=0,d=b.length;e<d;e++)m.vbo_line_elements.push(b[e]);m.line_elements_ref[a][g]=[s|0,b.length|0];g++}m.vbo_line_elements=new Uint16Array(m.vbo_line_elements)}m.segments=c.segments;m.bounds=c.bounds;return m},updateVBO:function(c,g){if(!c.dynamic)return!1;var a,b,e=c.dynamicMap,d=g.points&&!!c.vbo_points,f=g.normals&&
!!c.vbo_normals,h=g.uvs&&!!c.vbo_uvs,m=g.colors&&!!c.vbo_colors,q,y,s;for(a=0,b=e.points.length;a<b;a++)y=this.faces[e.face_points[2*a]],s=e.face_points[2*a+1],d&&(q=this.points[e.points[a]],c.vbo_points[3*a]=q[0],c.vbo_points[3*a+1]=q[1],c.vbo_points[3*a+2]=q[2]),f&&(q=y.point_normals[s],c.vbo_normals[3*a]=q[0],c.vbo_normals[3*a+1]=q[1],c.vbo_normals[3*a+2]=q[2]),m&&(q=y.point_colors[s],c.vbo_colors[3*a]=q[0],c.vbo_colors[3*a+1]=q[1],c.vbo_colors[3*a+2]=q[2]),h&&(q=y.uvs[s],c.vbo_uvs[2*a]=q[0],c.vbo_uvs[2*
a+1]=q[1]);return this},rebufferVBO:function(c,g,a){var b=n.gl;a.points&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_points),b.bufferData(b.ARRAY_BUFFER,c.vbo_points,b.DYNAMIC_DRAW));a.normals&&c.vbo_normals&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_normals),b.bufferData(b.ARRAY_BUFFER,c.vbo_normals,b.DYNAMIC_DRAW));a.uvs&&c.vbo_uvs&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_uvs),b.bufferData(b.ARRAY_BUFFER,c.vbo_uvs,b.DYNAMIC_DRAW));a.colors&&c.vbo_colors&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_colors),b.bufferData(b.ARRAY_BUFFER,
c.vbo_colors,b.DYNAMIC_DRAW));b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);return this},bufferVBO:function(c,g){var a=n.gl,b={};g===r&&(g={});b.gl_points=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b.gl_points);a.bufferData(a.ARRAY_BUFFER,c.vbo_points,a.STATIC_DRAW);c.vbo_normals?(b.gl_normals=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_normals),a.bufferData(a.ARRAY_BUFFER,c.vbo_normals,a.STATIC_DRAW)):b.gl_normals=g.gl_normals?g.gl_normals:null;c.vbo_uvs?(b.gl_uvs=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,
b.gl_uvs),a.bufferData(a.ARRAY_BUFFER,c.vbo_uvs,a.STATIC_DRAW)):b.gl_uvs=g.gl_uvs?g.gl_uvs:null;c.vbo_colors?(b.gl_colors=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_colors),a.bufferData(a.ARRAY_BUFFER,c.vbo_colors,a.STATIC_DRAW)):b.gl_colors=g.gl_colors?g.gl_colors:null;!c.vbo_elements&&g.gl_elements?(b.gl_elements=g.gl_elements,b.elements_ref=g.elements_ref):(b.gl_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.gl_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,c.vbo_elements,
a.STATIC_DRAW),b.elements_ref=c.elements_ref);!c.vbo_line_elements&&g.gl_line_elements?(b.gl_line_elements=g.gl_line_elements,b.line_elements_ref=g.line_elements_ref):(b.gl_line_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.gl_line_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,c.vbo_line_elements,a.STATIC_DRAW),b.line_elements_ref=c.line_elements_ref);b.segments=c.segments;b.bounds=c.bounds;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);return b},update:function(c){var c=c||{},g=c.points||
c.point||c.vertex||c.vertices||c.all||!0,a=c.uvs||c.uv||c.texture||c.all||!1,b=c.normals||c.normal||c.all||!0,c=c.colors||c.color||c.all||!1;if(!this.dynamic)return o("Mesh not defined as dynamic, cannot update."),!1;b&&this.normalMapRef&&this.recalcNormals();g={points:g,uvs:a,normals:b,colors:c};this.updateVBO(this.dynamicData.VBO,g);this.rebufferVBO(this.dynamicData.VBO,this.dynamicData.buffer,g)},bindBuffer:function(c){if(null===this.originBuffer)this.originBuffer=c;this.compiled=c;this.segment_state=
[];for(var g=0,a=c.segments.length;g<a;g++)this.segment_state[c.segments[g]]=!0;this.bb=c.bounds},compile:function(c){var c=this.compileVBO(this.compileMap(c)),g=this.bufferVBO(c);this.bindBuffer(g);if(this.dynamic){this.sourcePoints=[];for(var a=0,b=this.points.length;a<b;a++)this.sourcePoints[a]=this.points[a].slice(0);this.dynamicData={VBO:c,buffer:g}}return this},addMorphTarget:function(c){if(null===this.morphTargets)this.morphTargets=[];this.morphTargets.push(c)},setMorphSource:function(c){if(this.morphSourceIndex!==
c)this.morphSourceIndex=c,this.bindBuffer(this.morphTargets[c])},setMorphTarget:function(c){if(this.morphTargetIndex!==c)this.morphTargetIndex=c,this.morphTarget=this.morphTargets[c]},setMorphWeight:function(c){this.morphWeight=c},morphTargetCount:function(){return null!==this.morphTargets?this.morphTargets.length:0}};return{Mesh:t,Face:z}});
CubicVR.RegisterModule("Motion",function(w){function z(){this.time=this.value=0;this.shape=o.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function t(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=CubicVR.parseEnum(o.envelope.behavior,a.in_behavior||a.inBehavior||a.behavior)||o.envelope.behavior.CONSTANT,this.out_behavior=CubicVR.parseEnum(o.envelope.behavior,a.out_behavior||a.outBehavior||a.behavior)||o.envelope.behavior.CONSTANT):
this.out_behavior=this.in_behavior=o.envelope.behavior.CONSTANT}function r(a,b){this.controllers=[];this.yzflip=!1;if("object"===typeof a){var h=CubicVR.get(a);this.env_init=CubicVR.get(h.envelope);this.key_init=CubicVR.get(h.key);for(var m in h)if(h.hasOwnProperty(m)&&!("envelope"===m||"key"===m)){var e=h[m],c=CubicVR.get(e.envelope),s;for(s in e)if(e.hasOwnProperty(s)&&!("envelope"===s||"key"===s)){var g=e[s];if("object"===typeof g)for(var v in g)this.setKey(m,v,s,g[v]),c&&this.setBehavior(m,v,
c)}}}else this.env_init=a,this.key_init=b}var n=w.undef,o=CubicVR.enums;o.motion={POS:0,ROT:1,SCL:2,POSITION:0,ROTATION:1,SCALE:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};o.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var c=function(a,b,h){var m=0,m=h-b;if(0===m)return[b,0];b=a-m*Math.floor((a-b)/m);m=-parseInt((b-a)/m+(b>a?0.5:-0.5),10);return[b,m]},g=function(a,b,h,m,e){var c,s;s=e*e;c=3*(b-
a);b=3*(h-b)-c;return(m-a-c-b)*s*e+b*s+c*e+a},a=function(b,f,h,m,e,c,s){var A,v;v=c+0.5*(s-c);A=g(b,f,h,m,v);return 1.0E-4<Math.abs(e-A)?(A>e?s=v:c=v,a(b,f,h,m,e,c,s)):v},b=function(a,b){var h,m,e,c;a.shape===o.envelope.shape.TCB?(h=(1-a.tension)*(1+a.continuity)*(1+a.bias),m=(1-a.tension)*(1-a.continuity)*(1-a.bias),e=b.value-a.value,a.prev?(c=(b.time-a.time)/(b.time-a.prev.time),h=c*(h*(a.value-a.prev.value)+m*e)):h=m*e):a.shape===o.envelope.shape.LINE?(e=b.value-a.value,a.prev?(c=(b.time-a.time)/
(b.time-a.prev.time),h=c*(a.value-a.prev.value+e)):h=e):a.shape===o.envelope.shape.BEZI||a.shape===o.envelope.shape.HERM?(h=a.param[1],a.prev&&(h*=(b.time-a.time)/(b.time-a.prev.time))):a.shape===o.envelope.shape.BEZ2?(h=a.param[3]*(b.time-a.time),h=1.0E-5<Math.abs(a.param[2])?h/a.param[2]:1E5*h):h=0;return h},e=function(a,b){var h,m,e,c;b.shape===o.envelope.shape.LINE?(e=b.value-a.value,b.next?(c=(b.time-a.time)/(b.next.time-a.time),h=c*(b.next.value-b.value+e)):h=e):b.shape===o.envelope.shape.TCB?
(h=(1-b.tension)*(1-b.continuity)*(1+b.bias),m=(1-b.tension)*(1+b.continuity)*(1-b.bias),e=b.value-a.value,b.next?(c=(b.time-a.time)/(b.next.time-a.time),h=c*(m*(b.next.value-b.value)+h*e)):h*=e):b.shape===o.envelope.shape.HERM||b.shape===o.envelope.shape.BEZI?(h=b.param[0],b.next&&(h*=(b.time-a.time)/(b.next.time-a.time))):b.shape===o.envelope.shape.BEZ2?(h=b.param[1]*(b.time-a.time),h=1.0E-5<Math.abs(b.param[0])?h/b.param[0]:1E5*h):h=0;return h};t.prototype={setBehavior:function(a,b){this.in_behavior=
CubicVR.parseEnum(o.envelope.behavior,a);this.out_behavior=CubicVR.parseEnum(o.envelope.behavior,b)},empty:function(){return 0===this.nKeys},addKey:function(a,b,h){var m="object"==typeof a?a:h;b||(b=0);a||(a=0);m?(m=a,a=m.time,h=this.insertKey(a),h.value=m.value?m.value:b,h.time=m.time?m.time:a,h.shape=CubicVR.parseEnum(o.envelope.shape,m.shape)||o.envelope.shape.TCB,h.tension=m.tension?m.tension:0,h.continuity=m.continuity?m.continuity:0,h.bias=m.bias?m.bias:0,h.param=m.param?m.param:[0,0,0,0]):
(h=this.insertKey(a),h.value=b);return h},insertKey:function(a){var b=new z;b.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=this.keys=b,this.nKeys++,b;for(var h=this.keys;h;){if(this.firstKey.time>a)this.firstKey=b;else if(this.lastKey.time<a)this.lastKey=b;if(h.time>b.time){b.prev=h.prev;if(b.prev)b.prev.next=b;b.next=h;b.next.prev=b;this.nKeys++;return b}if(!h.next)return b.prev=h,h.next=b,this.nKeys++,b;h=h.next}return null},evaluate:function(d){var f,h,m,q,y,s=0;if(0===this.nKeys)return 0;
if(1===this.nKeys)return this.keys.value;h=this.firstKey;f=this.lastKey;if(d<h.time){q=this.in_behavior;if(q===o.envelope.behavior.RESET)return 0;if(q===o.envelope.behavior.CONSTANT)return h.value;if(q===o.envelope.behavior.REPEAT)q=c(d,h.time,f.time),d=q[0];else if(q===o.envelope.behavior.OCILLATE)q=c(d,h.time,f.time),d=q[0],q=q[1],q%2&&(d=f.time-h.time-d);else if(q===o.envelope.behavior.OFFSET)q=c(d,h.time,f.time),d=q[0],q=q[1],s=q*(f.value-h.value);else if(q===o.envelope.behavior.LINEAR)return y=
b(h,h.next)/(h.next.time-h.time),y*(d-h.time)+h.value}else if(d>f.time){q=this.out_behavior;if(q===o.envelope.behavior.RESET)return 0;if(q===o.envelope.behavior.CONSTANT)return f.value;if(q===o.envelope.behavior.REPEAT)q=c(d,h.time,f.time),d=q[0];else if(q===o.envelope.behavior.OCILLATE)q=c(d,h.time,f.time),d=q[0],q=q[1],q%2&&(d=f.time-h.time-d);else if(q===o.envelope.behavior.OFFSET)q=c(d,h.time,f.time),d=q[0],q=q[1],s=q*(f.value-h.value);else if(q===o.envelope.behavior.LINEAR)return q=e(f.prev,
f)/(f.time-f.prev.time),q*(d-f.time)+f.value}if(this.lastKey0)if(d>this.lastKey0.time)f=this.lastKey0;else if(d<this.lastKey0.time)for(f=this.lastKey;d<f.time&&f.prev;)f=f.prev;else f=this.keys;else f=this.keys;for(;d>f.next.time;)f=f.next;h=f.next;this.lastKey0=f;if(d===f.time)return f.value+s;if(d===h.time)return h.value+s;m=(d-f.time)/(h.time-f.time);q=h.shape;if(q===o.envelope.shape.TCB||q===o.envelope.shape.BEZI||q===o.envelope.shape.HERM){y=b(f,h);q=e(f,h);var A,v;v=m*m;A=m*v;d=3*v-A-A;A-=v;
d=[1-d,d,A-v+m,A];return d[0]*f.value+d[1]*h.value+d[2]*y+d[3]*q+s}q===o.envelope.shape.BEZ2?(d=a(f.time,f.shape===o.envelope.shape.BEZ2?f.time+f.param[2]:f.time+(h.time-f.time)/3,h.time+h.param[0],h.time,d,0,1),s=g(f.value,f.shape===o.envelope.shape.BEZ2?f.value+f.param[3]:f.value+f.param[1]/3,h.param[1]+h.value,h.value,d)+s):s=q===o.envelope.shape.LINE?f.value+m*(h.value-f.value)+s:q===o.envelope.shape.STEP?f.value+s:s;return s}};r.prototype={envelope:function(a,b){b=CubicVR.parseEnum(o.motion,
b)||0;a=CubicVR.parseEnum(o.motion,a)||0;this.controllers[a]===n&&(this.controllers[a]=[]);this.controllers[a][b]===n&&(this.controllers[a][b]=new t(this.env_init));return this.controllers[a][b]},evaluate:function(a){var b=[],h;for(h in this.controllers)if(this.controllers.hasOwnProperty(h)){b[h]=[];for(var m in this.controllers[h])this.controllers[h].hasOwnProperty(m)&&(b[h][m]=this.controllers[h][m].evaluate(a))}return b},apply:function(a,b){for(var h in this.controllers)if(this.controllers.hasOwnProperty(h)){var m=
parseInt(h,10);if(this.yzflip&&m===o.motion.ROT){if(!this.q)this.q=new CubicVR.Quaternion;var e=this.q,c=this.controllers[h][0].evaluate(a),s=this.controllers[h][1].evaluate(a),g=this.controllers[h][2].evaluate(a);e.fromEuler(c,g,-s);e=e.toEuler();b.control(m,0,e[0]);b.control(m,1,e[1]);b.control(m,2,e[2])}else for(var v in this.controllers[h])this.controllers[h].hasOwnProperty(v)&&b.control(m,parseInt(v,10),this.controllers[h][v].evaluate(a))}},setKey:function(a,b,h,m,e){b=CubicVR.parseEnum(o.motion,
b)||0;a=CubicVR.parseEnum(o.motion,a)||0;return this.envelope(a,b).addKey(h,m,e?e:this.key_init)},setArray:function(a,b,h,m){var e=[],a=CubicVR.parseEnum(o.motion,a)||0,c;for(c in h)if(h.hasOwnProperty(c)){var s=this.envelope(a,CubicVR.parseEnum(o.motion,c));e[c]=s.addKey(b,h[c],m?m:this.key_init)}return e},setBehavior:function(a,b,h,m){var e=this.envelope(a,b);"object"===typeof h&&(m=h,h=m.in_behavior||m.inBehavior||m.behavior,m=m.out_behavior||m.outBehavior||m.behavior);CubicVR.parseEnum(o.motion,
b);CubicVR.parseEnum(o.motion,a);e.setBehavior(h,m)},setBehaviorArray:function(a,b,h){var a=CubicVR.parseEnum(o.motion,a)||0,m=this.controllers[a],e;for(e in m)m.hasOwnProperty(e)&&this.envelope(a,CubicVR.parseEnum(o.motion,e)||0).setBehavior(b,h)}};return{Motion:r,Envelope:t,EnvelopeKey:z}});
CubicVR.RegisterModule("Octree",function(w){function z(a,e,d,f,h){var m=this._children=[];this._dirty=!1;m[0]=null;m[1]=null;m[2]=null;m[3]=null;m[4]=null;m[5]=null;m[6]=null;m[7]=null;this._child_index=h||-1;this._root=d||null;this._max_depth=e||0;a=this._size=a||0;f=this._position=f||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[f[0],f[1],f[2],Math.sqrt(3*(this._size/2*this._size/2))];e=this._bbox=[[0,0,0],[0,0,0]];d=CubicVR.aabb;d.reset(e,f);a/=2;d.engulf(e,[f[0]+
a,f[1]+a,f[2]+a]);d.engulf(e,[f[0]-a,f[1]-a,f[2]-a]);this._debug_visible=!1}function t(){this.position=[0,0,0];this.visible=!1;this._object=null}function r(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;6>a;++a)this._planes[a]=[0,0,0,0]}var n=w.undef,o=CubicVR.plane,c=CubicVR.sphere,g=CubicVR.enums;g.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};g.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};var a=function(a,e,d){d=a.slice((d||
e)+1||a.length);a.length=0>e?a.length+e:e;return a.push.apply(a,d)};z.prototype.destroy=function(){var a,e,d;for(a=0,e=this._static_lights.length;a<e;++a)d=this._static_lights[a],d.octree_leaves=null,d.octree_common_root=null,d.octree_aabb=null;for(a=0,e=this._lights.length;a<e;++a)d=this._lights[a],d.octree_leaves=null,d.octree_common_root=null,d.octree_aabb=null;this._lights=this._static_lights=null;for(a=0,e=this._children.length;a<e;++a)null!==this._children[a]&&this._children[a].destroy();for(a=
0,e=this._nodes.length;a<e;++a)d=this._nodes[a],d.octree_leaves=null,d.octree_common_root=null,d.octree_aabb=null,d.dynamic_lights=[],d.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};z.prototype.toString=function(){return"[Octree: @"+this._position+
", depth: "+this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};z.prototype.remove=function(b){var e=!1,d=this._nodes.length,f;for(f=d-1,d=this._nodes.length;0<=f;--f)if(b===this._nodes[f]){a(this._nodes,f);this.dirty_lineage();e=!0;break}if(!e)for(f=d-1;0<=f;--f)if(b===this._lights[f]){a(this._lights,f);this.dirty_lineage();break}};z.prototype.dirty_lineage=function(){this._dirty=!0;null!==
this._root&&this._root.dirty_lineage()};z.prototype.cleanup=function(){for(var a=this._children.length,e=0,d=0;d<a;++d){var f=this._children[d];if(null!==f){var h=!0;!0===f._dirty&&(h=f.cleanup());h?++e:this._children[d]=null}}return 0===this._nodes.length&&0===this._static_lights.length&&0===this._lights.length&&(0===e||0===a)?!1:!0};z.prototype.insert_light=function(a){this.insert(a,!0)};z.prototype.propagate_static_light=function(a){var e,d;for(e=0,d=this._nodes.length;e<d;++e)-1===this._nodes[e].static_lights.indexOf(a)&&
this._nodes[e].static_lights.push(a);for(e=0;8>e;++e)null!==this._children[e]&&this._children[e].propagate_static_light(a)};z.prototype.collect_static_lights=function(a){var e,d;for(e=0,d=this._static_lights.length;e<d;++e)-1===a.static_lights.indexOf(this._static_lights[e])&&a.static_lights.push(this._static_lights[e]);for(e=0;8>e;++e)null!==this._children[e]&&this._children[e].collect_static_lights(a)};z.prototype.insert=function(a,e){function d(a,b,f,d){var h,m;if(f)if(b.method===g.light.method.STATIC){-1===
a._static_lights.indexOf(b)&&a._static_lights.push(b);for(f=0,h=a._nodes.length;f<h;++f)-1===a._nodes[f].static_lights.indexOf(b)&&a._nodes[f].static_lights.push(b);for(m=a._root;null!==m;){for(f=0,l=m._nodes.length;f<l;++f)h=m._nodes[f],-1===h.static_lights.indexOf(b)&&h.static_lights.push(b);m=m._root}}else-1===a._lights.indexOf(b)&&a._lights.push(b);else{a._nodes.push(b);for(f=0,h=a._static_lights.length;f<h;++f)-1===b.static_lights.indexOf(a._static_lights[f])&&b.static_lights.push(a._static_lights[f]);
for(m=a._root;null!==m;){for(f=0,h=m._static_lights.length;f<h;++f){var e=m._static_lights[f];-1===b.static_lights.indexOf(e)&&b.static_lights.push(e)}m=m._root}}b.octree_leaves.push(a);b.octree_common_root=d;d=CubicVR.aabb;d.engulf(b.octree_aabb,a._bbox[0]);d.engulf(b.octree_aabb,a._bbox[1])}e===n&&(e=!1);if(null===this._root)a.octree_leaves=[],a.octree_common_root=null;if(0===this._max_depth)d(this,a,e,this._root);else{var f=this._position,h,m,c,y,s,A,v;m=a.getAABB();v=[m[0][0],m[0][1],m[0][2]];
var o=[m[1][0],m[1][1],m[1][2]];h=v[0]<f[0]&&v[1]<f[1]&&v[2]<f[2];m=o[0]>f[0]&&v[1]<f[1]&&v[2]<f[2];s=v[0]<f[0]&&o[1]>f[1]&&v[2]<f[2];A=o[0]>f[0]&&o[1]>f[1]&&v[2]<f[2];c=v[0]<f[0]&&v[1]<f[1]&&o[2]>f[2];y=o[0]>f[0]&&v[1]<f[1]&&o[2]>f[2];v=v[0]<f[0]&&o[1]>f[1]&&o[2]>f[2];f=o[0]>f[0]&&o[1]>f[1]&&o[2]>f[2];if(h&&m&&s&&A&&c&&y&&v&&f)d(this,a,e,this),e?a.method==g.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var o=0,r=this._static_lights.length;o<r;++o){if(a.static_lights===
n)a.static_lights=[];-1===a.static_lights.indexOf(this._static_lights[o])&&a.static_lights.push(this._static_lights[o])}var o=this._size/2,r=this._size/4,t=0,u=this._position[0],x=this._position[1],w=this._position[2];h&&(h=[u-r,x-r,w-r],null===this._children[g.octree.TOP_NW]&&(this._children[g.octree.TOP_NW]=new z(o,this._max_depth-1,this,h,g.octree.TOP_NW)),this._children[g.octree.TOP_NW].insert(a,e),++t);m&&(h=[u+r,x-r,w-r],null===this._children[g.octree.TOP_NE]&&(this._children[g.octree.TOP_NE]=
new z(o,this._max_depth-1,this,h,g.octree.TOP_NE)),this._children[g.octree.TOP_NE].insert(a,e),++t);s&&(h=[u-r,x+r,w-r],null===this._children[g.octree.BOTTOM_NW]&&(this._children[g.octree.BOTTOM_NW]=new z(o,this._max_depth-1,this,h,g.octree.BOTTOM_NW)),this._children[g.octree.BOTTOM_NW].insert(a,e),++t);A&&(h=[u+r,x+r,w-r],null===this._children[g.octree.BOTTOM_NE]&&(this._children[g.octree.BOTTOM_NE]=new z(o,this._max_depth-1,this,h,g.octree.BOTTOM_NE)),this._children[g.octree.BOTTOM_NE].insert(a,
e),++t);c&&(h=[u-r,x-r,w+r],null===this._children[g.octree.TOP_SW]&&(this._children[g.octree.TOP_SW]=new z(o,this._max_depth-1,this,h,g.octree.TOP_SW)),this._children[g.octree.TOP_SW].insert(a,e),++t);y&&(h=[u+r,x-r,w+r],null===this._children[g.octree.TOP_SE]&&(this._children[g.octree.TOP_SE]=new z(o,this._max_depth-1,this,h,g.octree.TOP_SE)),this._children[g.octree.TOP_SE].insert(a,e),++t);v&&(h=[u-r,x+r,w+r],null===this._children[g.octree.BOTTOM_SW]&&(this._children[g.octree.BOTTOM_SW]=new z(o,
this._max_depth-1,this,h,g.octree.BOTTOM_SW)),this._children[g.octree.BOTTOM_SW].insert(a,e),++t);f&&(h=[u+r,x+r,w+r],null===this._children[g.octree.BOTTOM_SE]&&(this._children[g.octree.BOTTOM_SE]=new z(o,this._max_depth-1,this,h,g.octree.BOTTOM_SE)),this._children[g.octree.BOTTOM_SE].insert(a,e),++t);if(1<t||null===a.octree_common_root)a.octree_common_root=this}}};z.prototype.draw_on_map=function(a,e,d){function f(a,b,f,d,c){var q=a<f?a:f,g=b<d?b:d,a=a<f?f-a:a-f,b=b<d?d-b:b-d;e.save();if(void 0!==
c)e.fillStyle=c,e.fillRect(h+q,m+g,a,b);e.strokeRect(h+q,m+g,a,b);e.restore()}var h=a.width/2,m=a.height/2,c,g,s,A,v,o,r;if(d===n||"map"===d)e.save(),!1!==this._debug_visible?(e.fillStyle="rgba(0,0,0,0)",e.strokeStyle="#FF0000"):(e.fillStyle="rgba(0,0,0,0)",e.strokeStyle="rgba(0,0,0,0)"),e.beginPath(),v=this._size/2,c=this._position[0],g=this._position[2],e.moveTo(h+c-v,h+g-v),e.lineTo(h+c-v,h+g+v),e.lineTo(h+c+v,h+g+v),e.lineTo(h+c+v,h+g-v),e.stroke(),e.fill(),e.restore();if(d===n||"objects"===d){e.save();
for(v=0,r=this._nodes.length;v<r;++v)o=this._nodes[v],e.fillStyle="#5500FF",e.strokeStyle=!0===o.visible&&!1===o.culled?"#FFFFFF":"#000000",e.beginPath(),c=o.aabb[0][0],g=o.aabb[0][2],s=o.aabb[1][0]-c,A=o.aabb[1][2]-g,e.rect(h+c,m+g,s,A),e.stroke();e.restore()}if(d===n||"lights"===d){for(v=0,r=this._lights.length;v<r;++v)A=this._lights[v],e.fillStyle=!1===A.culled&&!0===A.visible?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",e.strokeStyle="#FFFF00",e.beginPath(),o=A.distance,c=A.position[0],
g=A.position[2],e.arc(h+c,m+g,o,0,2*Math.PI,!0),e.closePath(),e.stroke(),e.fill(),e.beginPath(),c=A.aabb[0][0],g=A.aabb[0][2],s=A.aabb[1][0]-c,A=A.aabb[1][2]-g,e.rect(h+c,m+g,s,A),e.closePath(),e.stroke();for(v=0,r=this._static_lights.length;v<r;++v)A=this._static_lights[v],e.fillStyle=!1===A.culled&&!0===A.visible?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",e.strokeStyle="#FF66BB",e.beginPath(),o=A.distance,c=A.position[0],g=A.position[2],e.arc(h+c,m+g,o,0,2*Math.PI,!0),e.closePath(),
e.stroke(),e.fill(),e.beginPath(),c=A.aabb[0][0],g=A.aabb[0][2],s=A.aabb[1][0]-c,A=A.aabb[1][2]-g,e.rect(h+c,m+g,s,A),e.closePath(),e.stroke()}if("lights"!=d&&"objects"!=d&&"map"!=d){e.save();c=this._nodes;for(v=0,A=c.length;v<A;++v)if(o=c[v],o.name==d){e.strokeStyle="#FFFF00";e.lineWidth=3;e.beginPath();c=o.aabb[0][0];g=o.aabb[0][2];s=o.aabb[1][0]-c;A=o.aabb[1][2]-g;e.rect(h+c,m+g,s,A);e.closePath();e.stroke();c=o.octree_aabb;e.strokeStyle="#0000FF";f(c[0][0],c[0][2],c[1][0],c[1][2]);e.lineWidth=
1;if(null!==o.common_root)e.strokeStyle="#00FF00";break}e.lineWidth=1;e.strokeStyle="#FFFF00";f(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");e.fill();e.restore()}for(v=0,r=this._children.length;v<r;++v)null!==this._children[v]&&this._children[v].draw_on_map(a,e,d)};z.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=
this._position[1]-this._size/2&&a[2]>=this._position[2]-this._size/2};z.prototype.get_frustum_hits=function(a,e){var d={objects:[],lights:[]};if((e===n||!0===e)&&!this.contains_point(a.position)){if(!1===c.intersects(a.frustum.sphere,this._sphere))return d;var f=a.frustum.contains_sphere(this._sphere);if(-1===f)return this._debug_visible=!1,d;if(1===f)this._debug_visible=2,e=!1;else if(0===f){this._debug_visible=!0;f=a.frustum.contains_box(this._bbox);if(-1===f)return this._debug_visible=!1,d;if(1===
f)this._debug_visible=3,e=!1}}var h,m;for(f=0,h=this._nodes.length;f<h;++f)m=this._nodes[f],d.objects.push(m),m.dynamic_lights=[].concat(this._lights),m.was_culled=m.culled,m.culled=!1,m.drawn_this_frame=!1;this._debug_visible=0<this._lights.length?4:this._debug_visible;for(f=0,h=this._lights.length;f<h;++f)if(m=this._lights[f],!0===m.visible)d.lights.push(m),m.was_culled=m.culled,m.culled=!1;for(f=0,h=this._static_lights.length;f<h;++f)if(m=this._static_lights[f],!0===m.visible)m.culled=!1;for(f=
0;8>f;++f)if(null!==this._children[f]){h=this._children[f].get_frustum_hits(a,e);var q;for(m=0,q=h.objects.length;m<q;++m){d.objects.push(h.objects[m]);for(var g=h.objects[m].dynamic_lights,s=0,A=this._lights.length;s<A;++s)0>g.indexOf(this._lights[s])&&g.push(this._lights[s])}for(m=0,q=h.lights.length;m<q;++m)0>d.lights.indexOf(h.lights[m])&&d.lights.push(h.lights[m])}return d};z.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,e;for(a=0,e=this._nodes.length;a<e;++a)this._nodes[a].culled=
!0;for(a=0,e=this._lights.length;a<e;++a)this._lights[a].culled=!0;for(a=0,e=this._static_lights.length;a<e;++a)this._static_lights[a].culled=!0;for(a=0,e=this._children.length;a<e;++a)null!==this._children[a]&&this._children[a].reset_node_visibility()};t.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};t.prototype.attach=function(a){this._object=a};r.prototype.extract=function(a,e,d){var f=CubicVR.vec3;if(!(e===n||d===n)){var h=CubicVR.mat4.multiply(d,e),e=this._planes;e[g.frustum.plane.LEFT][0]=
h[3]+h[0];e[g.frustum.plane.LEFT][1]=h[7]+h[4];e[g.frustum.plane.LEFT][2]=h[11]+h[8];e[g.frustum.plane.LEFT][3]=h[15]+h[12];e[g.frustum.plane.RIGHT][0]=h[3]-h[0];e[g.frustum.plane.RIGHT][1]=h[7]-h[4];e[g.frustum.plane.RIGHT][2]=h[11]-h[8];e[g.frustum.plane.RIGHT][3]=h[15]-h[12];e[g.frustum.plane.TOP][0]=h[3]-h[1];e[g.frustum.plane.TOP][1]=h[7]-h[5];e[g.frustum.plane.TOP][2]=h[11]-h[9];e[g.frustum.plane.TOP][3]=h[15]-h[13];e[g.frustum.plane.BOTTOM][0]=h[3]+h[1];e[g.frustum.plane.BOTTOM][1]=h[7]+h[5];
e[g.frustum.plane.BOTTOM][2]=h[11]+h[9];e[g.frustum.plane.BOTTOM][3]=h[15]+h[13];e[g.frustum.plane.NEAR][0]=h[3]+h[2];e[g.frustum.plane.NEAR][1]=h[7]+h[6];e[g.frustum.plane.NEAR][2]=h[11]+h[10];e[g.frustum.plane.NEAR][3]=h[15]+h[14];e[g.frustum.plane.FAR][0]=h[3]-h[2];e[g.frustum.plane.FAR][1]=h[7]-h[6];e[g.frustum.plane.FAR][2]=h[11]-h[10];e[g.frustum.plane.FAR][3]=h[15]-h[14];for(var m=0;6>m;++m)o.normalize(e[m]);m=-e[g.frustum.plane.NEAR][3];e=e[g.frustum.plane.FAR][3]-m;d=e*(1/d[5]);d=f.subtract([0,
0,m+0.5*e],[d,d,m+e]);d=f.length(d);h=[h[3],h[9],h[10]];m=f.length(h);h=f.multiply(h,1/m);a=[a.position[0],a.position[1],a.position[2]];a=f.add(a,f.multiply(h,0.5*e));a=f.add(a,f.multiply(h,1));this.sphere=[a[0],a[1],a[2],d]}};r.prototype.contains_sphere=function(a){for(var e=CubicVR.vec3,d=this._planes,f=0;6>f;++f){var h=d[f],h=e.dot([h[0],h[1],h[2]],[a[0],a[1],a[2]])+h.d;this.last_in[f]=1;if(h<-a[3])return-1;if(Math.abs(h)<a[3])return 0}return 1};r.prototype.draw_on_map=function(a,e){var d=a.width/
2,f=a.height/2;e.save();for(var h=this._planes,m=[0,1,4,5],c=0,g=m.length;c<g;++c){var s=h[m[c]];e.strokeStyle="#FF00FF";if(c<this.last_in.length&&this.last_in[c])e.strokeStyle="#FFFF00";var A=-d,v=d,n=(-s[3]-s[0]*v)/s[2];e.moveTo(d+A,f+(-s[3]-s[0]*A)/s[2]);e.lineTo(d+v,f+n);e.stroke()}e.strokeStyle="#0000FF";e.beginPath();e.arc(d+this.sphere[0],f+this.sphere[2],this.sphere[3],0,2*Math.PI,!1);e.closePath();e.stroke();e.restore()};r.prototype.contains_box=function(a){var e=0,d=[];d[0]=a[0];d[1]=[a[0][0],
a[0][1],a[1][2]];d[2]=[a[0][0],a[1][1],a[0][2]];d[3]=[a[0][0],a[1][1],a[1][2]];d[4]=[a[1][0],a[0][1],a[0][2]];d[5]=[a[1][0],a[0][1],a[1][2]];d[6]=[a[1][0],a[1][1],a[0][2]];d[7]=a[1];for(var a=this._planes,f=0;6>f;++f){for(var h=8,m=1,c=0;8>c;++c)-1===o.classifyPoint(a[f],d[c])&&(m=0,--h);this.last_in[f]=m;if(0===h)return-1;e+=m}return 6===e?1:0};return{Frustum:r,Octree:z}});
CubicVR.RegisterModule("Particles",function(w){function z(n,o,c,g,a,b,e){if(n){this.last_particle=this.particles=null;this.pTex=c!==t?c:null;this.vWidth=g;this.vHeight=a;this.alpha=b!==t?b:!1;this.alphaCut=e!==t?e:0;this.pfunc=function(a,b){var h=b-a.start_time;if(0>h)return 0;if(h>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+h*a.velocity[0]+h*h*a.accel[0];a.pos[1]=a.startpos[1]+h*a.velocity[1]+h*h*a.accel[1];a.pos[2]=a.startpos[2]+h*a.velocity[2]+h*h*a.accel[2];null!==this.pgov&&this.pgov(a,
b);return 1};this.pgov=null;this.hasColor=o===t?!1:o;c=null!==this.pTex;this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",c?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",c?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",c?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n");this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",c?"uniform sampler2D pMap;":"","varying vec4 color;",c?"varying vec2 screenPos;":"",c?"uniform vec3 screenDim;":"",c?"varying float pSize;":"","void main(void) {\nvec4 c = color;",c?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",c?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",c?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n");this.maxPoints=n;this.numParticles=0;this.arPoints=new Float32Array(3*n);this.glPoints=null;if(o)this.arColor=new Float32Array(3*n),this.glColor=null;this.shader_particle=new CubicVR.Shader(this.vs,this.fs);this.shader_particle.use();this.shader_particle.addVertexArray("aVertexPosition");
this.hasColor&&this.shader_particle.addVertexArray("aColor");this.shader_particle.addMatrix("uMVMatrix");this.shader_particle.addMatrix("uPMatrix");null!==this.pTex&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[g,a,0]));this.genBuffer()}}var t=w.undef,r=w.GLCore;z.prototype={resizeView:function(n,o){this.vWidth=n;this.vHeight=o;null!==this.pTex&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[n,o,0]))},addParticle:function(n){null===this.last_particle?this.particles=n:this.last_particle.nextParticle=n;this.last_particle=n},genBuffer:function(){var n=r.gl;this.glPoints=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,this.glPoints);n.bufferData(n.ARRAY_BUFFER,this.arPoints,n.DYNAMIC_DRAW);if(this.hasColor)this.glColor=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.glColor),n.bufferData(n.ARRAY_BUFFER,this.arColor,n.DYNAMIC_DRAW)},updatePoints:function(){var n=r.gl;n.bindBuffer(n.ARRAY_BUFFER,
this.glPoints);n.bufferData(n.ARRAY_BUFFER,this.arPoints,n.DYNAMIC_DRAW)},updateColors:function(){var n=r.gl;this.hasColor&&(n.bindBuffer(n.ARRAY_BUFFER,this.glColor),n.bufferData(n.ARRAY_BUFFER,this.arColor,n.DYNAMIC_DRAW))},draw:function(n,o,c){var g=r.gl;this.shader_particle.use();null!==this.pTex&&this.pTex.use(g.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",n);this.shader_particle.setMatrix("uPMatrix",o);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null);g.bindBuffer(g.ARRAY_BUFFER,this.glPoints);
g.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,g.FLOAT,!1,0,0);g.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(g.bindBuffer(g.ARRAY_BUFFER,this.glColor),g.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,g.FLOAT,!1,0,0),g.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(c!==t){this.numParticles=0;if(null===this.particles){g.disable(g.BLEND);return}for(var n=this.particles,o=null,a=0;null!==n;){var b=3*this.numParticles,
e=this.pfunc(n,c);if(1===e){if(this.arPoints[b]=n.pos[0],this.arPoints[b+1]=n.pos[1],this.arPoints[b+2]=n.pos[2],null!==n.color&&this.arColor!==t&&(this.arColor[b]=n.color[0],this.arColor[b+1]=n.color[1],this.arColor[b+2]=n.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else if(-1===e){if(null!==o)o.nextParticle=n.nextParticle}else 0===e&&a++;o=n;n=n.nextParticle}if(!a)this.last_particle=this.particles=null;this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&
(g.enable(g.BLEND),g.enable(g.DEPTH_TEST),g.depthMask(0),g.blendFunc(g.ONE,g.ONE_MINUS_SRC_COLOR));g.drawArrays(g.POINTS,0,this.numParticles);this.alpha&&(g.disable(g.BLEND),g.depthMask(1),g.blendFunc(g.ONE,g.ONE));this.hasColor&&g.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:z,Particle:function(n,o,c,g,a){this.startpos=new Float32Array(n);this.pos=new Float32Array(n);this.velocity=new Float32Array(g!==t?g:[0,0,0]);this.accel=new Float32Array(a!==t?a:[0,0,
0]);this.start_time=o!==t?o:0;this.life_time=c!==t?c:0;this.nextParticle=this.color=null}}});
CubicVR.RegisterModule("PostProcess",function(w){function z(a){if(a.shader_vertex===n)return null;if(a.shader_fragment===n)return null;this.outputMode=a.outputMode===n?c.post.output.REPLACE:CubicVR.parseEnum(CubicVR.enums.post.output,a.outputMode);this.onresize=a.onresize===n?null:a.onresize;this.onupdate=a.onupdate===n?null:a.onupdate;this.init=a.init===n?null:a.init;this.enabled=a.enabled===n?!0:a.enabled;this.outputDivisor=a.outputDivisor===n?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,
a.shader_fragment);this.shader.use();this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");null!==this.init&&this.init(this.shader)}function t(a,e,d){var f=o.gl;this.width=a;this.height=e;this.accum=d===n?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,e,!0);this.bufferA=new CubicVR.RenderBuffer(a,e,!1);this.bufferB=new CubicVR.RenderBuffer(a,
e,!1);this.bufferC=new CubicVR.RenderBuffer(a,e,!1);this.accumOpacity=1;this.accumIntensity=0.3;if(this.accum)this.accumBuffer=new CubicVR.RenderBuffer(a,e,!1),this.accumBuffer.use(),f.clearColor(0,0,0,1),f.clear(f.COLOR_BUFFER_BIT),this.blur_shader=new z({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}});this.bufferA.use();f.clearColor(0,0,0,1);f.clear(f.COLOR_BUFFER_BIT);this.bufferB.use();f.clearColor(0,0,0,1);f.clear(f.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new z({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,e)}function r(a,e,d){this.createBuffer(a,e,d)}var n=w.undef,o=w.GLCore,c=CubicVR.enums;c.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var g=[],a=[];t.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,e){var d=o.gl,f={},h=a/a,m=e/e;f.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);f.vbo_uvs=new Float32Array([0,0,h,0,h,m,0,m,0,0,h,m]);f.gl_points=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,
f.gl_points);d.bufferData(d.ARRAY_BUFFER,f.vbo_points,d.STATIC_DRAW);f.gl_uvs=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,f.gl_uvs);d.bufferData(d.ARRAY_BUFFER,f.vbo_uvs,d.STATIC_DRAW);return f},destroyFSQuad:function(a){var e=o.gl;e.deleteBuffer(a.gl_points);e.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,e){var d=o.gl;a.use();d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.bindBuffer(d.ARRAY_BUFFER,e.gl_points);d.vertexAttribPointer(a.aVertex,3,d.FLOAT,!1,0,0);d.enableVertexAttribArray(a.aVertex);
d.bindBuffer(d.ARRAY_BUFFER,e.gl_uvs);d.vertexAttribPointer(a.aTex,2,d.FLOAT,!1,0,0);d.enableVertexAttribArray(a.aTex);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.drawArrays(d.TRIANGLES,0,6)},addShader:function(b){this.shaders[this.shaders.length]=b;b.shader.use();b.shader.setVector("texel",this.vTexel);if(b.outputDivisor&&1!=b.outputDivisor&&g[b.outputDivisor]===n){var e=this.width/b.outputDivisor|0,d=this.height/b.outputDivisor|0;g[b.outputDivisor]=new CubicVR.RenderBuffer(e,d,!1);a[b.outputDivisor]=
this.makeFSQuad(e,d)}},resize:function(b,e){var d=o.gl;this.width=b;this.height=e;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT));for(var f in g){var d=this.width/f|0,h=this.height/f|0;g[f].destroyBuffer();g[f].createBuffer(d,h,!1);this.destroyFSQuad(a[f]);a[f]=this.makeFSQuad(d,h)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;f=0;for(d=this.shaders.length;f<d;f++)if(this.shaders[f].shader.use(),this.shaders[f].shader.setVector("texel",this.vTexel),null!==this.shaders[f].onresize)this.shaders[f].onresize(this.shaders[f].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(a){var e=o.gl;this.captureBuffer.use();a&&(this.captureBuffer.depth?e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT):e.clear(e.COLOR_BUFFER_BIT))},end:function(){var a=o.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var b=o.gl;this.captureBuffer.texture.use(b.TEXTURE1);
this.outputBuffer.use();this.captureBuffer.texture.use(b.TEXTURE0);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var e=0,d=0,f=this.shaders.length;d<f;d++){var h=this.shaders[d];if(h.enabled){this.swap();this.inputBuffer.texture.use(b.TEXTURE0);var m=h.outputMode;if(m===c.post.output.REPLACE)1!==h.outputDivisor?g[h.outputDivisor].use():this.outputBuffer.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);else if(m===c.post.output.ADD||
m===c.post.output.BLEND)1!==h.outputDivisor?g[h.outputDivisor].use():this.bufferC.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);null!==h.onupdate&&(h.shader.use(),h.onupdate(h.shader));1!==h.outputDivisor?(b.viewport(0,0,g[h.outputDivisor].width,g[h.outputDivisor].height),this.renderFSQuad(h.shader,a[h.outputDivisor]),h.outputMode===c.post.output.REPLACE?(this.outputBuffer.use(),g[h.outputDivisor].texture.use(b.TEXTURE0),b.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,
this.fsQuad)):b.viewport(0,0,this.width,this.height)):this.renderFSQuad(h.shader,this.fsQuad);m===c.post.output.BLEND?(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(b.TEXTURE0),1!==h.outputDivisor?g[h.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND)):m===c.post.output.ADD&&(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),
b.blendFunc(b.ONE,b.ONE),1!==h.outputDivisor?g[h.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND));this.end();e++}}0===e?this.captureBuffer.texture.use(b.TEXTURE0):this.outputBuffer.texture.use(b.TEXTURE0);this.accum&&1!==this.accumOpacity?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),
this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),b.disable(b.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(b.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),b.disable(b.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};r.prototype={createBuffer:function(a,
e,d){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=parseInt(e,10);var a=this.sizeParam(a),e=this.sizeParam(e),f=o.gl;this.fbo=f.createFramebuffer();if(d)this.depth=f.createRenderbuffer();f.bindFramebuffer(f.FRAMEBUFFER,this.fbo);d&&(f.bindRenderbuffer(f.RENDERBUFFER,this.depth),-1!==navigator.appVersion.indexOf("Windows")?(f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_COMPONENT16,a,e),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.RENDERBUFFER,this.depth)):
(f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_STENCIL,a,e),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_STENCIL_ATTACHMENT,f.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;f.bindTexture(f.TEXTURE_2D,w.Textures[this.texture.tex_id]);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);f.texImage2D(f.TEXTURE_2D,
0,f.RGBA,a,e,0,f.RGBA,f.UNSIGNED_BYTE,null);f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,w.Textures[this.texture.tex_id],0);f.bindFramebuffer(f.FRAMEBUFFER,null)},destroyBuffer:function(){var a=o.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(w.Textures[this.texture.tex_id]);w.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=o.gl;a.bindFramebuffer(a.FRAMEBUFFER,
this.fbo)}};return{RenderBuffer:r,PostProcessShader:z,PostProcessChain:t,fsQuad:{make:t.prototype.makeFSQuad,destroy:t.prototype.destroyFSQuad,render:t.prototype.renderFSQuad}}});
CubicVR.RegisterModule("Polygon",function(w){function z(a){var b=[],m=a.length;if(3>m)return null;var e=[],c;c=a.length;for(var g=0,n=c-1,v=0;v<c;n=v++)g+=a[n][0]*a[v][1]-a[v][0]*a[n][1];if(0<0.5*g)for(c=0;c<m;c++)e[c]=c;else for(c=0;c<m;c++)e[c]=m-1-c;v=2*m;for(g=0,c=m-1;2<m;){if(0>=v--)return null;var o=c;m<=o&&(o=0);c=o+1;m<=c&&(c=0);n=c+1;m<=n&&(n=0);var r;a:{r=a;var t=o,u=c,x=n,w=m,z=e,D=void 0,K=void 0,I=void 0,F=void 0,G=void 0,L=void 0,O=void 0,N=void 0,Y=void 0,K=r[z[t]][0],I=r[z[t]][1],
F=r[z[u]][0],G=r[z[u]][1],L=r[z[x]][0],O=r[z[x]][1];if(d>(F-K)*(O-I)-(G-I)*(L-K))r=!1;else{for(D=0;D<w;D++)if(!(D==t||D==u||D==x)){var N=r[z[D]][0],Y=r[z[D]][1],ca=void 0,U=void 0,na=void 0,Q=void 0,M=void 0,La=void 0,gb=void 0,hb=void 0,Ma=void 0,pb=void 0,Na=void 0,ib=void 0,ca=na=M=void 0,ca=L-F,U=O-G,na=K-L,Q=I-O,M=F-K,La=G-I,gb=N-K,hb=Y-I,Ma=N-F,pb=Y-G,Na=N-L,ib=Y-O,ca=ca*pb-U*Ma,M=M*hb-La*gb,na=na*ib-Q*Na;if(0<=ca&&0<=na&&0<=M){r=!1;break a}}r=!0}}if(r){v=e[o];o=e[c];n=e[n];b.push(v);b.push(o);
b.push(n);g++;for(n=c,v=c+1;v<m;n++,v++)e[n]=e[v];m--;v=2*m}}return b}function t(a,b,d){d===e&&(d=0);var c;c=z(b);var g=CubicVR.util.repackArray(c,3,c.length/3),s=[],n=a.points.length;for(c=0,iMax=b.length;c<iMax;c++)s.push([b[c][0],b[c][1],d]);a.addPoint(s);for(c=0,iMax=g.length;c<iMax;c++)a.addFace([g[c][0]+n,g[c][1]+n,g[c][2]+n])}function r(a,b){var d=b[0]-a[0],e=b[1]-a[1];return Math.sqrt(d*d+e*e)}function n(a,b){var d,e,c=[],g=a.length,n=b.length,v=[];for(d=0;d<g;d++)for(e=0;e<n;e++){var o=r(a[d],
b[e]);c.push([o,d,e])}c.sort(function(a,b){return a[0]>b[0]});for(d=0;5>d;d++)for(e=0;e<c.length;e++)d!=e&&c[d][1]!=c[e][1]&&c[d][2]!=c[e][2]&&c[d][1]<c[e][1]&&c[d][2]<c[e][2]&&4>Math.abs(c[d][1]-c[e][1])&&4>Math.abs(c[d][2]-c[e][2])&&v.push([d,e]);v.sort(function(a,b){return c[a[0]][0]+c[a[1]][0]>c[b[0]][0]+c[b[1]][0]});if(10<v.length)v.length=10;e=[];for(d=0;d<v.length;d++)e.push([c[v[d][0]],c[v[d][1]]]);return e}function o(a,b){var d=n(a,b),e;if(!d.length)return null;e=d[0][0];var c=d[0][1],d=
c[1]-e[1],c=c[2]-e[2],g=a.slice(e[1]),g=g.concat(a.slice(0,e[1])),A=b.slice(e[2]),A=A.concat(b.slice(0,e[2])),v=[];for(e=d;e<g.length;e++)v.push(g[e]);v.push(g[0]);for(e=c;e<A.length;e++)v.push(A[e]);v.push(A[0]);var o=[];for(e=0;e<=d;e++)o.push(g[e]);for(e=0;e<=c;e++)o.push(A[e]);return[v,o]}function c(a){for(var b=[0,0],d=0;d<a.length;d++)b[0]+=a[d][0],b[1]+=a[d][1];b[0]/=a.length;b[1]/=a.length;return b}function g(a,b,d){for(var e=[],c=0;c<a.length;c++){var g=[a[c][0]-b[0],a[c][1]-b[1]],n=Math.sqrt(g[0]*
g[0]+g[1]*g[1])+d,g=Math.atan2(g[1],g[0]);e[c]=[b[0]+Math.cos(g)*n,b[1]+Math.sin(g)*n]}return e}function a(a,b,d,e,c){var g,n=a.points.length;if(b.length!=d.length)return null;var v=b.length;for(g=0;g<v;g++)a.addPoint([b[g][0],b[g][1],e]);for(g=0;g<v;g++)a.addPoint([d[g][0],d[g][1],c]);for(g=0;g<v-1;g++)a.addFace([n+g,n+g+1,n+(g+v+1),n+(g+v)]);g=v-1;a.addFace([n+g,n,n+v,n+(g+v)])}function b(a){this.points=a;this.cuts=[];this.result=[]}var e=w.undef,d=1.0E-10;b.prototype={cut:function(a){this.cuts.push(a)},
toMesh:function(a){if(0!==this.points.length){var b;a||(a=new CubicVR.Mesh);this.result=[this.points];for(b=0;b<this.cuts.length;b++){var d=this.cuts[b].points.slice(0),d=d.reverse(),d=o(this.result[0],d);this.result[0]=d[0];this.result.push(d[1])}for(b=0;b<this.result.length;b++)t(a,this.result[b]);a.removeDoubles();return a}},toExtrudedMesh:function(b,d,m){if(0!==this.points.length){var c,g;d===e&&(d=0);m===e&&(m=0);var s=d!=m;b||(b=new CubicVR.Mesh);this.result=[this.points];for(g=0;g<this.cuts.length;g++)c=
this.cuts[g].points.slice(0),c=c.reverse(),c=o(this.result[0],c),this.result[0]=c[0],this.result.push(c[1]);c=new CubicVR.Mesh;for(g=0;g<this.result.length;g++)t(c,this.result[g],m);b.booleanAdd(c);c.flipFaces();if(s)for(g=0;g<c.points.length;g++)c.points[g][2]=d;b.booleanAdd(c);if(s){a(b,this.points,this.points,d,m);for(g=0;g<this.cuts.length;g++)c=this.cuts[g].points.slice(0),c=c.reverse(),a(b,c,c,d,m)}b.removeDoubles();return b}},toExtrudedBeveledMesh:function(b,d,e,q,n,s,A){var v=[],r=[],w,E,
u,x;if(0!==this.points.length){"object"===typeof d&&(A=d,d=A.front||0,e=A.back||0,q=A.frontDepth||0,n=A.frontShift||0,s=A.backDepth||0,A=A.backShift||0);var B=d!==e,z=0!==s,D=0!==q;b||(b=new CubicVR.Mesh);D?(E=c(this.points),E=g(this.points,E,-n),this.result=[E.slice(0)]):this.result=[this.points.slice(0)];for(x=0;x<this.cuts.length;x++)u=c(this.cuts[x].points),u=g(this.cuts[x].points,u,n),u=u.reverse(),v.push(u),u=o(this.result[0],u),this.result[0]=u[0],this.result.push(u[1]);n=new CubicVR.Mesh;
for(x=0;x<this.result.length;x++)t(n,this.result[x],d-q);n.flipFaces();b.booleanAdd(n);if(z||D){w=c(this.points);w=g(this.points,w,-A);this.result=[w.slice(0)];for(x=0;x<this.cuts.length;x++)u=c(this.cuts[x].points),u=g(this.cuts[x].points,u,A),u=u.reverse(),r.push(u),u=o(this.result[0],u),this.result[0]=u[0],this.result.push(u[1]);n=new CubicVR.Mesh;for(x=0;x<this.result.length;x++)t(n,this.result[x],e+s)}else{for(x=0;x<n.points.length;x++)n.points[x][2]=e;n.flipFaces()}b.booleanAdd(n);D&&a(b,E,
this.points,d-q,d);B&&a(b,this.points,this.points,d,e);z&&a(b,this.points,w,e,e+s);for(x=0;x<v.length;x++)u=this.cuts[x].points.slice(0).reverse(),D&&a(b,v[x],u,d-q,d),B&&a(b,u,u,d,e),z&&a(b,u,r[x],e,e+s);b.removeDoubles();return b}}};return{polygon:{triangulate2D:z,toMesh:t,findNearPair:function(a,b){for(var d=[0,0],e=r(a[0],b[0]),c=a.length,g=b.length,n=0;n<c;n++)for(var v=0;v<g;v++){var o=r(a[n],b[v]);o<e&&(d[0]=n,d[1]=v,e=o)}return d},subtract:o,addOffset:function(a,b){for(var d=[],e=0,c=a.length;e<
c;e++){var g=a[e];d.push([g[0]+b[0],g[1]+b[1]])}return d}},Polygon:b}});
CubicVR.RegisterModule("Primitives",function(w){function z(a,b,e,h,c,g){var n=CubicVR.mat4,o=CubicVR.vec3,r=[],u,x=[0,1,0],t=[1,0,0],w=[0,0,0],z=a.points.length,K,I,F;for(K=u=0;K<f&&!(u===e);K+=f/e){t=[Math.cos(K),0,Math.sin(K)];for(I=0,F=b.length;I<F;I++)w=o.add(o.multiply(t,b[I][0]),o.multiply(x,b[I][1])),r[u]===d&&(r[u]=[]),r[u].push(w);u++}F=null;c!==d&&(F=c.getResult!==d?c.getResult():c);for(I=0;I<e;I++)for(c=0,u=b.length;c<u;c++)F?a.addPoint(n.vec3_multiply(r[I][c],F)):a.addPoint(r[I][c]);"string"===
typeof h&&(h=new CubicVR.Material(h));a.setFaceMaterial(h);for(c=0;c<e;c++)for(I=0,F=b.length-1;I<F;I++)n=I+b.length*c,r=I+b.length*((c+1)%e),o.equal(a.points[z+n],a.points[z+r])?a.addFace([z+n+1,z+r+1,z+r]):o.equal(a.points[z+n+1],a.points[z+r+1])?a.addFace([z+n,z+n+1,z+r]):a.addFace([z+n,z+n+1,z+r+1,z+r]);g!==d&&(b=null,g.apply!==d?b=g:g&&(b=new CubicVR.UVMapper(g)),null!==b&&(a.calcFaceNormals(),b.apply(a,h)))}function t(a,b,f,e,h){var c=CubicVR.mat4,b=0.5*b,g=a.points.length;"string"===typeof f&&
(f=new CubicVR.Material(f));a.setFaceMaterial(f);e!==d?(e=e.getResult!==d?e.getResult():e,a.addPoint([c.vec3_multiply([b,-b,0],e),c.vec3_multiply([b,b,0],e),c.vec3_multiply([-b,b,0],e),c.vec3_multiply([-b,-b,0],e)])):a.addPoint([[b,-b,0],[b,b,0],[-b,b,0],[-b,-b,0]]);a.addFace([[g+0,g+1,g+2,g+3],[g+3,g+2,g+1,g+0]]);h!==d&&(c=null,h.apply!==d?c=h:h&&(c=new CubicVR.UVMapper(h)),null!==c&&(a.calcFaceNormals(),c.apply(a,f)))}function r(a,b,f,e,h){var c=CubicVR.mat4,g,n;"object"===typeof b?(g=b[0]/2,n=
b[1]/2,b=b[2]/2):g=n=b/=2;var o=a.points.length;"string"===typeof f&&(f=new CubicVR.Material(f));a.setFaceMaterial(f);e!==d?(e=e.getResult!==d?e.getResult():e,a.addPoint([c.vec3_multiply([g,-n,b],e),c.vec3_multiply([g,n,b],e),c.vec3_multiply([-g,n,b],e),c.vec3_multiply([-g,-n,b],e),c.vec3_multiply([g,-n,-b],e),c.vec3_multiply([g,n,-b],e),c.vec3_multiply([-g,n,-b],e),c.vec3_multiply([-g,-n,-b],e)])):a.addPoint([[g,-n,b],[g,n,b],[-g,n,b],[-g,-n,b],[g,-n,-b],[g,n,-b],[-g,n,-b],[-g,-n,-b]]);a.addFace([[o+
0,o+1,o+2,o+3],[o+7,o+6,o+5,o+4],[o+4,o+5,o+1,o+0],[o+5,o+6,o+2,o+1],[o+6,o+7,o+3,o+2],[o+7,o+4,o+0,o+3]]);h!==d&&(c=null,h.apply!==d?c=h:h&&(c=new CubicVR.UVMapper(h)),null!==c&&(a.calcFaceNormals(),c.apply(a,f)))}function n(a,b,d,e,h,c,g,n){for(var o=[],d=d-b,b=b+d/2,r=f/h,x=0,t=0;t<=h;t++)o.push([b+Math.cos(x)*d,Math.sin(x)*d,0]),x+=r;CubicVR.genLatheObject(a,o,e,c,g,n)}function o(a,b,f,d,e,h,c){CubicVR.genLatheObject(a,[[0,-f/2,0],[b/2,-f/2,0],[0,f/2,0]],d,e,h,c)}function c(a,b,f,d,e,h,c){CubicVR.genLatheObject(a,
[[0,-f/2,0],[b,-f/2,0],[b,f/2,0],[0,f/2,0]],d,e,h,c)}function g(a,b,f,d,e,c,g){for(var n=[],d=(d/=2)|0,f=f|0,o=Math.PI/d,r=-h,x=0;x<=d;x++)n.push([Math.cos(r)*b,Math.sin(r)*b,0]),r+=o;CubicVR.genLatheObject(a,n,f,e,c,g)}function a(a){"string"===typeof a&&(a=CubicVR.get(a,CubicVR.Material));return a===d?new CubicVR.Material:a.use?a:"object"===typeof a?new CubicVR.Material(a):new CubicVR.Material}function b(a){if(a===d)return d;if("array"===typeof a)return a;if("object"===typeof a)return a.getResult?
a.getResult():a.position||a.rotation||a.scale?CubicVR.mat4.transform(a.position,a.rotation,a.scale):d}function e(a){"string"===typeof a&&(a=CubicVR.get(a));return a===d?d:a.apply?a:"object"===typeof a?new CubicVR.UVMapper(a):d}var d=w.undef,f=2*Math.PI,h=Math.PI/2;return{genPlaneObject:t,genBoxObject:r,genLatheObject:z,genTorusObject:n,genConeObject:o,genCylinderObject:c,genSphereObject:g,primitives:{lathe:function(f){var h,c,g,n;if(f.points==d)return null;h=f.mesh!==d?f.mesh:new CubicVR.Mesh(f.name!==
d?f.name:d);c=a(f.material);g=b(f.transform);n=e(f.uvmapper||f.uv);z(h,f.points,f.divisions!==d?f.divisions:24,c,g,n);return h},box:function(f){var h,c,g,n;h=f.mesh!==d?f.mesh:new CubicVR.Mesh(f.name!==d?f.name:d);c=a(f.material);g=b(f.transform);n=e(f.uvmapper||f.uv);r(h,f.size!==d?f.size:1,c,g,n);return h},plane:function(f){var h,c,g,n;h=f.mesh!==d?f.mesh:new CubicVR.Mesh(f.name!==d?f.name:d);c=a(f.material);g=b(f.transform);n=e(f.uvmapper||f.uv);t(h,f.size!==d?f.size:1,c,g,n);return h},sphere:function(f){var h,
c,s,n;h=f.mesh!==d?f.mesh:new CubicVR.Mesh(f.name!==d?f.name:d);c=a(f.material);s=b(f.transform);n=e(f.uvmapper||f.uv);g(h,f.radius!==d?f.radius:1,f.lon!==d?f.lon:24,f.lat!==d?f.lat:24,c,s,n);return h},torus:function(f){var h,c,g,o;h=f.mesh!==d?f.mesh:new CubicVR.Mesh(f.name!==d?f.name:d);c=a(f.material);g=b(f.transform);o=e(f.uvmapper||f.uv);n(h,f.innerRadius!==d?f.innerRadius:0.75,f.outerRadius!==d?f.outerRadius:1,f.lon!==d?f.lon:24,f.lat!==d?f.lat:24,c,g,o);return h},cone:function(f){var h,c,g,
n;h=f.mesh!==d?f.mesh:new CubicVR.Mesh(f.name!==d?f.name:d);c=a(f.material);g=b(f.transform);n=e(f.uvmapper||f.uv);o(h,f.base!==d?f.base:1,f.height!==d?f.height:1,f.lon!==d?f.lon:24,c,g,n);return h},cylinder:function(f){var h,g,s,n;h=f.mesh!==d?f.mesh:new CubicVR.Mesh(f.name!==d?f.name:d);g=a(f.material);s=b(f.transform);n=e(f.uvmapper||f.uv);c(h,f.radius!==d?f.radius:1,f.height!==d?f.height:1,f.lon!==d?f.lon:24,g,s,n);return h}}}});
CubicVR.RegisterModule("Renderer",function(w){var z=w.undef;return{renderObject:function(t,r,n,o,c,g,a){var b=!1,c=c||!1,g=g||!1;if(null!==t.compiled){var e=0,d=CubicVR.GLCore.gl,f,h=o===z?0:o.length,m,q=0,y,s=null,A=t.instanceMaterials||t.materials,v=(a=(t.wireframe||a)&&t.compiled.line_elements_ref)?t.compiled.line_elements_ref:t.compiled.elements_ref,H=!1,J,E,u;d.depthFunc(d.LEQUAL);n===z&&(n=cubicvr_identity);for(var x=0,B=v.length;x<B;x++){var s=a&&t.wireframeMaterial?t.wireframeMaterial:A[x],
C=0,q=!1;if(1>s.opacity&&c)b=!0;else if(!(g&&1<=s.opacity)){1!==s.opacity?(d.enable(d.BLEND),d.depthMask(0),d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA)):(d.depthMask(1),d.disable(d.BLEND),d.blendFunc(d.ONE,d.ONE));for(var D=0,K=v[x].length;D<K;D++)if(y=v[x][D][0],q=!1,f=v[x][D][1],C+=f,!t.segment_state[y])if(C>f){e+=2*f;C-=f;if(h){E=!1;for(J=0;J<h;){f=h-J;if(f>w.MAX_LIGHTS)f=w.MAX_LIGHTS;0<J&&!E&&(d.enable(d.BLEND),d.blendFunc(d.ONE,d.ONE),d.depthFunc(d.EQUAL),E=!0);m=o[J];u=m.light_type;for(q=
0;q<f;q++)if(o[q+J].light_type!=u){f=q;break}s.use(m.light_type,f);m=s.shader[m.light_type][f];d.uniformMatrix4fv(m.matrixModelView,!1,r.mvMatrix);d.uniformMatrix4fv(m.matrixProjection,!1,r.pMatrix);d.uniformMatrix4fv(m.matrixObject,!1,n);d.uniformMatrix3fv(m.matrixNormal,!1,r.nMatrix);H||(s.bindObject(t,m),H=-1!=m.vertexTexCoord,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,t.compiled.gl_line_elements));for(q=0;q<f;q++)o[q+J].setupShader(m,q);a?d.drawElements(d.LINES,C,d.UNSIGNED_SHORT,e):d.drawElements(d.TRIANGLES,
C,d.UNSIGNED_SHORT,e);J+=f}E&&(d.disable(d.BLEND),d.depthFunc(d.LEQUAL))}else s.use(0,0),d.uniformMatrix4fv(s.shader[0][0].matrixModelView,!1,r.mvMatrix),d.uniformMatrix4fv(s.shader[0][0].matrixProjection,!1,r.pMatrix),d.uniformMatrix4fv(s.shader[0][0].matrixObject,!1,n),d.uniformMatrix3fv(s.shader[0][0].matrixNormal,!1,r.nMatrix),H||(s.bindObject(t,s.shader[0][0]),H=-1!=s.shader[0][0].vertexTexCoord,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,t.compiled.gl_line_elements)),a?d.drawElements(d.LINES,C,d.UNSIGNED_SHORT,
e):d.drawElements(d.TRIANGLES,C,d.UNSIGNED_SHORT,e);e+=2*C;C=0;q=!0}else e+=2*C,C=0;if(!q&&t.segment_state[y]){if(h){E=!1;for(J=0;J<h;){f=h-J;if(f>w.MAX_LIGHTS)f=w.MAX_LIGHTS;0<J&&!E&&(d.enable(d.BLEND),d.blendFunc(d.ONE,d.ONE),d.depthFunc(d.EQUAL),E=!0);m=o[J];u=m.light_type;for(q=0;q<f;q++)if(o[q+J].light_type!=u){f=q;break}s.use(m.light_type,f);m=s.shader[m.light_type][f];d.uniformMatrix4fv(m.matrixModelView,!1,r.mvMatrix);d.uniformMatrix4fv(m.matrixProjection,!1,r.pMatrix);d.uniformMatrix4fv(m.matrixObject,
!1,n);d.uniformMatrix3fv(m.matrixNormal,!1,r.nMatrix);H||(s.bindObject(t,m),H=-1!=m.vertexTexCoord,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,t.compiled.gl_line_elements));for(q=0;q<f;q++)o[q+J].setupShader(m,q);a?d.drawElements(d.LINES,C,d.UNSIGNED_SHORT,e):d.drawElements(d.TRIANGLES,C,d.UNSIGNED_SHORT,e);J+=f}E&&(d.disable(d.BLEND),d.depthFunc(d.LEQUAL))}else s.use(0,0),d.uniformMatrix4fv(s.shader[0][0].matrixModelView,!1,r.mvMatrix),d.uniformMatrix4fv(s.shader[0][0].matrixProjection,!1,r.pMatrix),
d.uniformMatrix4fv(s.shader[0][0].matrixObject,!1,n),d.uniformMatrix3fv(s.shader[0][0].matrixNormal,!1,r.nMatrix),H||(s.bindObject(t,s.shader[0][0]),H=-1!=s.shader[0][0].vertexTexCoord,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,t.compiled.gl_line_elements)),a?d.drawElements(d.LINES,C,d.UNSIGNED_SHORT,e):d.drawElements(d.TRIANGLES,C,d.UNSIGNED_SHORT,e);e+=2*C}}}s&&m?s.clearObject(t,m):s.clearObject(t,null);d.depthMask(1);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);return b}}}});
CubicVR.RegisterModule("EventHandler",function(w){function z(g){g=CubicVR.parseEnum(o.event,g);if(g===n)return c("For custom events use CubicVR.registerEvent('event_name'); and use the resulting CubicVR.enums.event.EVENT_NAME for type checks and 'event_name' for construction."),!1;return!isNaN(parseInt(g,10))&&(g>=o.event.EVENT_MAX||0>g)?(c("Unknown event ID passed: "+g),!1):g}function t(c){c=c||{};this.name=c.name;c.id=z(c.id)||o.event.TICK;this.id=c.id;this.interval=c.interval||0;this.enabled=c.enabled||
!0;this.action=c.action||null;this.properties=c.properties||{};this.event_properties=c.event_properties||{};this.buffered=c.buffered||!1;this.weight=c.weight===n?-1:c.weight;this.subject=null;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function r(){this.events=[];this.eventProperties=[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=[];this.eventParameters=[]}var n=w.undef,
o=CubicVR.enums,c=w.log;o.event={TICK:0,MOVE:1,MATRIX_UPDATE:2,OCTREE_ADJUST:3,COLLIDE:4,CONTACT:5,CONTACT_ADD:6,CONTACT_REMOVE:7,CONTACT_GHOST:8,RIGID_REST:9,RIGID_AWAKE:10,ENUM_MAX:11};t.prototype={getName:function(){return this.name},setName:function(c){this.name=c},getSubject:function(){return this.subject},setSubject:function(c){this.subject=c},getId:function(){return this.id},setId:function(c){this.id=c},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},enable:function(){this.setEnabled(!0)},
setEnabled:function(c){if(c&&!this.enabled)this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1;this.enabled=c},isBuffered:function(){return this.buffered},setBuffered:function(c){this.buffered=c},setInterval:function(c){this.interval=c},getInterval:function(){return this.interval},setAction:function(c){this.action=c},getAction:function(){return this.action},getProperties:function(){return this.properties},setProperties:function(c){this.properties=
c},getProperty:function(c){return this.properties[c]},setProperty:function(c,a){this.properties[c]=a},setEventProperties:function(c){this.event_properties=c},getEventProperties:function(){return this.event_properties},getEventProperty:function(c){return this.event_properties[c]},setEventProperty:function(c,a){this.properties[c]=a},getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},getSeconds:function(){return this.getTimeUpdated()},
getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(c){this.t_rest=c},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(c){this.setRestInterval(c||0)},awake:function(){this.t_rest=0},update:function(c,a){if(!this.enabled)return!1;var b=0,e=!0;if(0===this.n_updates)this.t_updatecall=this.t_update=c,b=1/60;else if(c!==this.t_update){if(!this.t_rest)this.t_last=
c-this.t_update,this.t_update=c;b=c-this.t_updatecall;this.t_updatecall=c}else e=!1;if(0<this.t_rest){if(e&&(this.t_resting+=b,this.t_rest-=b,0>this.t_rest))this.t_rest=0}else{if(e){this.t_active+=this.t_last;if(!this.t_rest&&this.interval)this.t_rest=this.interval;this.n_updates++}this.callEvent(a);return!0}e&&this.n_updates++;return!1},callEvent:function(c){return!this.action?!1:this.action(this,c)}};r.prototype={addEvent:function(c){c.callEvent||(c=new t(c));var a=c.getId();this.eventProperties[a]||
(this.eventProperties[a]={});this.listeners[a]=this.listeners[a]||0;this.listeners[a]++;this.events.push(c);-1===this.listenerNames.indexOf(a)&&this.listenerNames.push(a);return c},removeEvent:function(c){if(this.lockState){if(!this.lockRemovals)this.lockRemovals=[];-1==this.lockRemovals.indexOf(c)&&this.lockRemovals.push(c)}else{var a=this.events.indexOf(c);-1!==a&&(c=c.getId(),this.events.splice(a,1),this.listeners[c]--,this.listeners[c]||(this.eventHandled[c]=!0,this.eventParameters[c]={},this.eventProperties[c]=
[],this.eventPropertyCount[c]=0,a=this.listenerNames.indexOf(c),0<=a&&this.listenerNames.splice(a,1)))}},getProperties:function(c){this.eventParameters[c]=this.eventParameters[c]||{};return this.eventParameters[c]},setProperties:function(c,a){this.eventParameters[c]=a},getProperty:function(c,a){return this.getProperties(c)[a]},setProperty:function(c,a,b){this.getProperties(c)[a]=b},hasEvent:function(c){return!!this.listeners[c]},triggerEvent:function(c,a){if(!this.listeners[c])return null;this.eventProperties[c]==
n&&(this.eventProperties[c]=[]);var b=this.eventProperties[c];this.eventPropertyCount[c]===n&&(this.eventPropertyCount[c]=0);var e=this.eventPropertyCount[c];20<e&&console.log("Warning, event "+c+" count > 20: "+e);b[e]=a&&b?a:b[e]||{};this.eventPropertyCount[c]++;this.eventHandled[c]=!1;return b[e]},update:function(c){var a,b,e,d,f,h;if(this.hasEvent(o.event.TICK)&&0===this.eventPropertyCount[o.event.TICK]&&(a=this.triggerEvent(o.event.TICK)))a.time=c,a.handler=this;this.lockState=!0;for(a=0,b=this.events.length;a<
b;a++){f=this.events[a];h=f.getId();d=this.eventPropertyCount[h];var m=!1;e=!1;if(d){var q=this.eventProperties[h];if(f.isEnabled()){if(f.isBuffered()){if(q.length=d,f.setEventProperties(q),m=m||f.update(c,this),f.isChainBroken()){f.breakChain(!1);break}}else for(e=0;e<d;e++)if(f.setEventProperties(q[a]),m=m||f.update(c,this),f.isChainBroken()){f.breakChain(!1);break}e=!0}}if(m||!e)this.eventHandled[h]=!0}for(a=0,b=this.listenerNames.length;a<b;a++)h=this.listenerNames[a],this.eventHandled[h]&&(this.eventPropertyCount[h]=
0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){for(a=0,b=this.lockRemovals.length;a<b;a++)this.removeEvent(this.lockRemovals[a]);this.lockRemovals.length=0}}};return{Event:t,EventHandler:r,registerEvent:function(g){g=g.toUpperCase();o.event[g]!==n?c("Error, event '"+g+"' is already registered."):(o.event[g]=o.event.ENUM_MAX,o.event.ENUM_MAX++)},validateEvent:z}});
CubicVR.RegisterModule("Scene",function(w){function z(a,b){return a.light_type-b.light_type}function t(f,d){var c=null,e;f!==o&&null!==f?f.compile?c={}:(c=CubicVR.get(f)||{},f=null):c={};this.morphWeight=c.morphWeight||0;this.morphSource=c.morphSource||-1;this.morphTarget=c.morphTarget||-1;this.position=c.position===o?[0,0,0]:c.position;this.rotation=c.rotation===o?[0,0,0]:c.rotation;this.scale=c.scale===o?[1,1,1]:c.scale;this.shadowCast=c.shadowCast===o?!0:c.shadowCast;this.wireframe=c.wireframe||
!1;this.motion=c.motion===o?null:CubicVR.get(c.motion,CubicVR.Motion)||null;this.obj=!c.mesh?f?CubicVR.get(f,CubicVR.Mesh):null:CubicVR.get(c.mesh,CubicVR.Mesh);this.name=c.name===o?d!==o?d:null:c.name;this.properties=CubicVR.get(c.properties)||{};this.parent=this.children=null;var g=c.children||c.child||c.sceneObject||c.sceneObjects;if(g){if(g&&!g.length||"string"===typeof g)g=[g];if(g.length)for(c=0,e=g.length;c<e;c++)this.bindChild(CubicVR.get(g[c],CubicVR.SceneObject))}this.drawn_this_frame=!1;
this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];this.lMatrix=b.identity();this.tMatrix=b.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null}function r(a,b,c,e,g,s){this.frames=0;this.sceneObjects=
[];this.sceneObjectsByName=[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.shadows_updated=this.collect_stats=!1;if("object"===typeof a||"string"===typeof a){a=CubicVR.get(a);this.octree=a.octree;this.skybox=a.skybox||null;this.name=a.name||"scene"+d;this.wireframe=a.wireframe||!1;this.destroy=a.destroy||function(){};this.update=a.update||function(){};this.enable=a.enable||function(){};
this.disable=a.disable||function(){};b=a.setup&&a.setup(this)||{};this.update=b.update||this.update;this.enable=b.enable||this.enable;this.disable=b.disable||this.disable;this.destroy=b.destroy||this.destroy;if((e=a.sceneObjects||a.sceneObject||a.objects)&&!e.length||"string"===typeof e)e=[e];if(e&&e.length)for(b=0,c=e.length;b<c;b++)this.bindSceneObject(CubicVR.get(e[b],CubicVR.SceneObject));if((e=a.lights||a.light)&&!e.length||"string"===typeof e)e=[e];if(e&&e.length)for(b=0,c=e.length;b<c;b++)this.bindLight(CubicVR.get(e[b],
CubicVR.Light));if((e=a.cameras||a.camera)&&!e.length||"string"===typeof e)e=[e];if(e&&e.length){for(b=0,c=e.length;b<c;b++)this.bindCamera(CubicVR.get(e[b],CubicVR.Camera));this.camera=this.cameras[0]}if(!e)this.camera=new CubicVR.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip)}else this.skybox=null,this.octree=s,this.name="scene"+d,this.camera=new CubicVR.Camera(a,b,c,e,g),this.wireframe=!1;this.paused=!1;++d}function n(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr=
{};this.meshBinPtr={}}var o=w.undef,c=CubicVR.enums,g=w.GLCore,a=CubicVR.aabb,b=CubicVR.mat4,e=0;t.prototype={isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},addEvent:function(a){if(!this.eventHandler)this.eventHandler=new CubicVR.EventHandler;a=this.eventHandler.addEvent(a);a.setSubject(this);return a},removeEvent:function(a){this.eventHandler&&this.eventHandler.removeEvent(a)},hasEvents:function(){return!!this.eventHandler},getEventHandler:function(){return this.eventHandler},
setMesh:function(a){this.obj=a},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},getProperty:function(a){return this.properties[a]},setProperty:function(a,b){this.properties[a]=b},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var a=0,b=this.obj.materials.length;a<b;a++)this.instanceMaterials[a]=this.obj.materials[a].clone();
return this.instanceMaterials},getInstanceMaterial:function(a){for(var b=this.getInstanceMaterials(),d=0,c=b.length;d<c;d++)if(b[d].name==a)return b[d];return null},setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return null!==this.obj.morphTargets?this.obj.morphTargets.length:
0},setMatrixLock:function(a){this.matrixLock=a},getMatrixLock:function(){return this.matrixLock},setMatrix:function(a){if(a){if(this.tMatrix=a.slice(0),this.matrixLock=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(c.event.MATRIX_UPDATE)))a.triggerEvent(c.event.MATRIX_UPDATE).matrix=this.tMatrix}else this.matrixLock=!1},doTransform:function(a){var d=CubicVR.vec3;if(!this.matrixLock&&(!d.equal(this.lposition,this.position)||!d.equal(this.lrotation,this.rotation)||!d.equal(this.lscale,this.scale)||
a!==o))if(a!==o?this.tMatrix=a.slice(0):b.identity(this.tMatrix),b.identity(this.lMatrix),b.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),b.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]||b.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),b.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=
this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(c.event.MOVE)))a=a.triggerEvent(c.event.MOVE),a.oldPosition=this.lposition,a.position=this.position,a.oldRotation=this.lrotation,a.rotation=this.rotation,a.oldScale=this.lscale,a.scale=this.scale},adjust_octree:function(){var b=
this.getAABB(),d=this.octree_aabb,c=b[0][0],e=b[0][1],g=b[0][2],s=b[1][0],n=b[1][1],v=b[1][2],r=d[0][0],t=d[0][1],w=d[0][2],u=d[1][0],x=d[1][1],d=d[1][2];if(0<this.octree_leaves.length&&(c<r||e<t||g<w||s>u||n>x||v>d)){for(c=0;c<this.octree_leaves.length;++c)this.octree_leaves[c].remove(this);this.octree_leaves=[];this.static_lights=[];c=this.octree_common_root;this.octree_common_root=null;if(null!==c){for(;;)if(!c.contains_point(b[0])||!c.contains_point(b[1]))if(c._root!==o&&null!==c._root)c=c._root;
else break;else break;a.reset(this.octree_aabb,this.position);c.insert(this)}}},bindChild:function(a){if(null===this.children)this.children=[];a.parent=this;this.children.push(a)},control:function(a,b,d){a===c.motion.POS?this.position[b]=d:a===c.motion.SCL?this.scale[b]=d:a===c.motion.ROT&&(this.rotation[b]=d)},getAABB:function(){var a=CubicVR.mat4,b=CubicVR.vec3;if(this.dirty){var d=Array(8);this.doTransform();var c,e;if(this.obj){if(!this.obj.bb)return this.aabb=[b.add([-1,-1,-1],this.position),
b.add([1,1,1],this.position)];c=this.obj.bb[0];e=this.obj.bb[1]}if(!this.obj||c===o||e===o)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];var g=c;c=b.subtract(e,c);d[0]=[g[0],g[1],g[2]];d[1]=[g[0],g[1],g[2]+c[2]];d[2]=[g[0]+c[0],g[1],g[2]];d[3]=[g[0]+c[0],g[1],g[2]+c[2]];d[4]=[g[0],g[1]+c[1],g[2]];d[5]=[g[0],g[1]+c[1],g[2]+c[2]];d[6]=[g[0]+c[0],g[1]+c[1],g[2]];d[7]=[g[0]+c[0],g[1]+c[1],g[2]+c[2]];g=a.vec3_multiply(d[0],this.tMatrix);c=[g[0],g[1],g[2]];e=[g[0],g[1],
g[2]];for(b=1;8>b;++b)g=a.vec3_multiply(d[b],this.tMatrix),c[0]>g[0]&&(c[0]=g[0]),c[1]>g[1]&&(c[1]=g[1]),c[2]>g[2]&&(c[2]=g[2]),e[0]<g[0]&&(e[0]=g[0]),e[1]<g[1]&&(e[1]=g[1]),e[2]<g[2]&&(e[2]=g[2]);this.aabb[0]=c;this.aabb[1]=e;this.dirty=!1}return this.aabb}};var d=0;r.prototype={isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},attachOctree:function(b){this.octree=b;b.init&&b.init(this);b=this.lights;this.lights=[];for(var d=0,c=b.length;d<c;d++)this.bindLight(b[d]);
b=this.sceneObjects;if(this.octree!==o){d=0;for(c=b.length;d<c;++d){var g=b[d];if(null!==g.obj){if(0>g.id)g.id=e,++e;this.sceneObjectsById[g.id]=g;a.reset(g.octree_aabb,g.position);this.octree.insert(g);(void 0===g.octree_common_root||null===g.octree_common_root)&&log("!!",g.name,"octree_common_root is null")}}}},setSkyBox:function(a){this.skybox=a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(b,d,c){if(-1==this.sceneObjects.indexOf(b)){this.sceneObjects.push(b);
d!==o&&d&&this.pickables.push(b);null!==b.name&&(this.sceneObjectsByName[b.name]=b);if(this.octree!==o&&(c===o||"true"===c)){if(0>b.id)b.id=e,++e;this.sceneObjectsById[b.id]=b;a.reset(b.octree_aabb,b.position);this.octree.insert(b)}if(b.children)for(var g=0,n=b.children.length;g<n;g++)this.bindSceneObject(b.children[g],d,c);return b}},removeLight:function(a){a=this.lights.indexOf(a);0<=a&&this.lights.splice(a,1)},removeSceneObject:function(a){var b;if(this.lockState){if(!this.lockRemovals)this.lockRemovals=
[];-1==this.lockRemovals.indexOf(a)&&this.lockRemovals.push(a)}else if(b=this.sceneObjects.indexOf(a),0<=b&&this.sceneObjects.splice(b,1),b=this.pickables.indexOf(a),0<=b&&this.pickables.splice(b,1),null!==a.name&&this.sceneObjectsByName[a.name]!==o&&delete this.sceneObjectsByName[a.name],a.children){b=0;for(var d=a.children.length;b<d;b++)this.removeSceneObject(a.children[b])}},bindLight:function(a,b){this.lights.push(a);if(this.octree!==o&&(b===o||"true"===b))a.method===c.light.method.GLOBAL?this.global_lights.push(a):
(a.method===c.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(z)},bindCamera:function(a){-1===this.cameras.indexOf(a)&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){"object"!==typeof a&&(a=this.getCamera(camName));-1===this.cameras.indexOf(a)&&(this.cameras.push(a),this.camerasByName[a.name]=a);return a},bind:function(a){a instanceof CubicVR.Light?this.bindLight(a):a instanceof CubicVR.SceneObject?
this.bindSceneObject(a):a instanceof CubicVR.Camera?this.bindCamera(a):a instanceof CubicVR.RigidBody&&this.bindSceneObject(a.getSceneObject())},remove:function(a){a instanceof CubicVR.Light?this.removeLight(a):a instanceof CubicVR.SceneObject?this.removeSceneObject(a):a instanceof CubicVR.Camera?this.removeCamera(a):a instanceof CubicVR.RigidBody&&this.removeSceneObject(a.getSceneObject())},setCamera:function(a){if(a)"object"!==typeof a&&(a=this.getCamera(a)),this.camera=a},getCamera:function(a){return a===
o?this.camera:this.camerasByName[a]},evaluate:function(a){var b,d;for(b=0,d=this.sceneObjects.length;b<d;b++)this.sceneObjects[b].motion&&this.sceneObjects[b].motion.apply(a,this.sceneObjects[b]);if(null!==this.camera.motion){if(null!==this.camera.targetSceneObject)this.camera.target=this.camera.targetSceneObject.position;this.camera.motion.apply(a,this.camera)}for(b=0,d=this.lights.length;b<d;b++){var c=this.lights[b];null!==c.motion&&c.motion.apply(a,c)}},prepareTransforms:function(a){var b,d;if(a){if(a.doTransform(),
a.children)for(b=0,d=a.children.length;b<d;b++)a.children[b].doTransform(a.tMatrix),this.prepareTransforms(a.children[b])}else if(0!==this.sceneObjects.length)for(b=0,d=this.sceneObjects.length;b<d;++b)this.prepareTransforms(this.sceneObjects[b])},updateShadows:function(a){var b=g.gl;if(this.shadows_updated)return!1;a||this.doTransform();this.shadows_updated=!0;if(w.features.lightShadows){for(var a=b.getParameter(b.FRAMEBUFFER_BINDING),d=!1,e=b.getParameter(b.VIEWPORT),n=0,s=this.lights.length;n<
s;n++){var o=this.lights[n];if(o.light_type==c.light.type.SPOT_SHADOW||o.light_type==c.light.type.SPOT_SHADOW_PROJECTOR||o.light_type==c.light.type.AREA){var d=!0,v=[new CubicVR.Light(c.light.type.DEPTH_PACK)];if(o.light_type===c.light.type.AREA)o.areaCam=this.camera,o.updateAreaLight();g.shadow_near=o.dummyCam.nearclip;g.shadow_far=o.dummyCam.farclip;o.shadowBegin();for(var r=0,t=this.sceneObjects.length;r<t;r++){var z=this.sceneObjects[r];z.parent||!1===z.visible||!1===z.shadowCast||this.renderSceneObject(z,
o.dummyCam,v,!1,!0)}o.shadowEnd();a&&b.bindFramebuffer(b.FRAMEBUFFER,a)}}d&&b.viewport(e[0],e[1],e[2],e[3])}},updateCamera:function(){!1===this.camera.manual&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],0,1,0):this.camera.calcProjection());g.depth_alpha_near=this.camera.nearclip;g.depth_alpha_far=this.camera.farclip},resize:function(a,b){this.camera&&this.camera.setDimensions(a,
b)},doTransform:function(){for(var a=this.octree!==o,b=0,d=this.sceneObjects.length;b<d;b++){var c=this.sceneObjects[b];if(null===c.parent&&(this.prepareTransforms(c),a&&(lights=[],c.dirty&&null!==c.obj&&c.adjust_octree(),!(!1===c.visible||a&&(c.ignore_octree||!0===c.drawn_this_frame||!0===c.culled)))))lights=c.dynamic_lights,lights=lights.concat(c.static_lights),lights=lights.concat(this.global_lights),this.collect_stats&&(lights_rendered=Math.max(lights.length,lights_rendered),lights_rendered===
lights.length&&(lights_list=lights),++objects_rendered),lights=0===lights.length?[g.emptyLight]:lights.sort(z),c.drawn_this_frame=!0}},renderSceneObject:function(a,b,d,c,e,g,n){var v=!1,c=c!==o&&c,e=e||!1,g=g||!1;if(a.visible&&a.obj){0>a.scale[0]&&(v=!v);0>a.scale[1]&&(v=!v);0>a.scale[2]&&(v=!v);v&&gl.cullFace(gl.FRONT);var r=a.obj;if(null!==r.morphTargets&&(-1!==a.morphSource&&r.setMorphSource(a.morphSource),-1!==a.morphTarget&&r.setMorphTarget(a.morphTarget),null!==a.morphWeight))r.morphWeight=
a.morphWeight;a.instanceMaterials&&r.bindInstanceMaterials(a.instanceMaterials);CubicVR.renderObject(r,b,a.tMatrix,d,e,g,this.isWireframe()||a.isWireframe())&&n&&n.push(a);a.instanceMaterials&&r.bindInstanceMaterials(null);v&&gl.cullFace(gl.BACK)}a=a.children;if(c&&a){c=0;for(v=a.length;c<v;c++)this.renderSceneObject(a[c],b,d,!0,e,g,n)}},runEvents:function(a){var b,d;this.lockState=!0;a.getSeconds&&(a=a.getSeconds());for(b=0,d=this.sceneObjects.length;b<d;b++){var c=this.sceneObjects[b];c.hasEvents()&&
c.getEventHandler().update(a)}this.lockState=!1;if(this.lockRemovals)for(b=0,d=this.lockRemovals.length;b<d;b++)this.removeSceneObject(this.lockRemovals[b]);this.lockRemovals=null},render:function(a){++this.frames;a=a||{};a.postProcess&&a.postProcess.begin(!a.postBuffer);var d=g.gl,c;c=0;if(this.octree!==o)this.octree.reset_node_visibility(),this.octree.cleanup(),c=this.octree.get_frustum_hits(this.camera),c=c.lights.length;this.doTransform();this.updateCamera();this.updateShadows(!0);this.shadows_updated=
!1;var e,n;for(e=0,n=this.lights.length;e<n;e++)this.lights[e].prepare(this.camera);var s=[],r=[],v=this.lights;for(e=0,n=this.sceneObjects.length;e<n;e++){var t=this.sceneObjects[e];!1===t.visible||null!==t.parent||this.renderSceneObject(t,this.camera,v,!0,!0,!1,r)}for(e=0,n=r.length;e<n;e++)this.renderSceneObject(r[e],this.camera,v,!1,!1,!0);if(this.collect_stats)this.stats["objects.num_rendered"]=0,this.stats["lights.num_rendered"]=c,this.stats["lights.rendered"]=s,this.stats["lights.num_global"]=
this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length;if(null!==this.skybox&&!0===this.skybox.ready)d.cullFace(d.FRONT),c=2*this.camera.farclip/Math.sqrt(3),this.skybox.scene_object.position=this.camera.parent?b.vec3_multiply(this.camera.position,this.camera.parent.tMatrix):[this.camera.position[0],this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=[c,c,c],this.skybox.scene_object.doTransform(),CubicVR.renderObject(this.skybox.scene_object.obj,
this.camera,this.skybox.scene_object.tMatrix,[]),d.cullFace(d.BACK);a.postProcess&&(a.postProcess.end(),a.postBuffer||a.postProcess.render())},bbRayTest:function(a,b,d){var c=CubicVR.vec3,e=[],b=2===b.length?this.camera.unProject(b[0],b[1]):c.add(a,b),g;for(g in this.pickables)if(this.pickables.hasOwnProperty(g)){var n=this.pickables[g];if(!0===n.visible){var o,r;r=n.getAABB();o=r[0];r=r[1];0.2>r[0]-o[0]&&(o[0]-=0.1,r[0]+=0.1);0.2>r[1]-o[1]&&(o[1]-=0.1,r[1]+=0.1);0.2>r[2]-o[2]&&(o[2]-=0.1,r[2]+=0.1);
var t=c.multiply(c.add(o,r),0.5),w=c.getClosestTo(a,b,t),t=c.length(c.subtract(w,t));(w[0]>=o[0]&&w[0]<=r[0]?1:0)+(w[1]>=o[1]&&w[1]<=r[1]?1:0)+(w[2]>=o[2]&&w[2]<=r[2]?1:0)>=d&&e.push({dist:t,obj:n})}}e.length&&e.sort(function(a,b){return a.dist==b.dist?0:a.dist<b.dist?-1:1});return e}};n.prototype={addMesh:function(a,b,d){this.meshBin[a]===o&&(this.meshBin[a]=[],this.meshBinPtr[a]===o&&(this.meshBinPtr[a]=0));this.meshMap[b]===o&&(this.meshMap[b]=d,this.meshBin[a].push(d))},addImage:function(a,b,
d){this.imageBin[a]===o&&(this.imageBin[a]=[],this.imageBinPtr[a]===o&&(this.imageBinPtr[a]=0));this.imageMap[b]===o&&(this.imageMap[b]=d,this.imageBin[a].push(d))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=0},getNextMesh:function(a){var b=this.meshBinPtr[a];return b<this.meshBin[a].length?(this.meshBinPtr[a]++,this.meshBin[a][b]):null},loadNextMesh:function(a){a=
this.getNextMesh(a);return null!==a?(null===a.compiled&&(a.triangulateQuads(),a.compile(),a.clean()),!0):!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);if(null!==a)a.src=a.deferredSrc},getNextImage:function(a){var b=this.imageBinPtr[a];return b<this.imageBin[a].length?(this.imageBinPtr[a]++,this.imageBin[a][b]):null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===this.imageBin[a].length}};return{Scene:r,
SceneObject:t,SkyBox:function(a){var b=a.texture,a=a.mapping,d=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){b.onready=null;var a=1/w.Images[d.texture.tex_id].width;if(null===d.mapping)d.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]];var a=new CubicVR.Material({name:"skybox",textures:{color:b}}),c=new CubicVR.Mesh;c.sky_mapping=d.mapping;CubicVR.primitives.box({mesh:c,size:1,material:a,uvmapper:{projectionMode:CubicVR.enums.uv.projection.SKY,
scale:[1,1,1]}});c.prepare();d.scene_object=new CubicVR.SceneObject(c);d.ready=!0};if(b){if("string"===typeof b)b=new CubicVR.Texture(b,null,null,null,this.onready);else if(!b.loaded)b.onready=this.onready;this.texture=b;if(a)this.mapping=a,this.onready()}},DeferredBin:n}});
CubicVR.RegisterModule("ScenePhysics",function(w){function z(a,b){b.setX(a[0]);b.setY(a[1]);b.setZ(a[2])}function t(a,b){b.setX(a.x);b.setY(a.y);b.setZ(a.z);b.setW(a.w)}function r(a,b){b.x=a.x();b.y=a.y();b.z=a.z();b.w=a.w()}function n(a){return new Ammo.btVector3(a[0],a[1],a[2])}function o(a){var b=new Ammo.btQuaternion;b.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return b}function c(a){return[a.x(),a.y(),a.z()]}function g(a){this.setManifold(a)}var a=w.undef,b=CubicVR.enums;
b.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5},collision_states:{ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5}};var e,d,f,h,m,w=function(a,b,d){var c;
if(!a.position&&a.sceneObject)c=a,a=a.sceneObject,b=c.properties,d=c.collision;c=CubicVR.get(c)||{};this.properties=new CubicVR.RigidProperties(b?CubicVR.get(b):{collision:d});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=c.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=c.angularVelocity||[0,0,0];this.init_impulse=this.impulse=c.impulse||[0,0,0];this.init_impulsePosition=
this.impulsePosition=c.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();this.transform.setOrigin(n(this.init_position));this.transform.setRotation(o(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};w.prototype={getProperties:function(){return this.properties},
getSceneObject:function(){return this.sceneObject},getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},
setMass:function(a){this.properties.mass=a},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var a=this.getCollisionShape();this.getType()===b.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(a),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),
this.motionState,a,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&this.body.setRestitution(this.getRestitution()),z(this.linearVelocity,h),this.body.setLinearVelocity(h),z(this.angularVelocity,h),this.body.setAngularVelocity(h),CubicVR.vec3.equal([0,0,0],this.impulse)||(z(this.impulse,h),z(this.impulsePosition,m),this.body.applyImpulse(h,m)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&
this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(a){if(this.body&&(this.body.isActive()||a))return this.body.getMotionState().getWorldTransform(e),a=e.getOrigin(),a.x!=a.x?console.log("origin is NaN"):(this.sceneObject.position[0]=a.x(),this.sceneObject.position[1]=a.y(),this.sceneObject.position[2]=a.z()),a=e.getRotation(),d.x=a.x(),d.y=a.y(),d.z=a.z(),d.w=a.w(),d.x!=d.x?console.log("rotation is NaN"):(a=d.toEuler(),
this.sceneObject.rotation[0]=a[0],this.sceneObject.rotation[1]=a[1],this.sceneObject.rotation[2]=a[2]),!0},reset:function(){if(this.body){var a=this.body.getWorldTransform().getOrigin();z(this.init_position,a);var a=this.body.getWorldTransform().getRotation(),b=this.init_rotation;d.fromEuler(b[0],b[1],b[2]);a.setX(this.init_rotation[0]);a.setY(this.init_rotation[1]);a.setZ(this.init_rotation[2]);a.setW(this.init_rotation[3]);this.resetMotion();this.activate()}},resetMotion:function(){z(this.init_linearVelocity,
h);this.body.setLinearVelocity(h);z(this.init_angularVelocity,h);this.body.setAngularVelocity(h);CubicVR.vec3.equal([0,0,0],this.init_impulse)||(z(this.init_impulse,h),z(this.init_impulsePosition,m),this.body.applyImpulse(h,m))},getCollisionShape:function(){if(!this.shape){var a;a=this.getCollisionMap();if(a.getResult())a=a.getResult();else{var d=a.getShapes(),c,f,h,g,m,q,r,t=[],y=null;for(f=0,h=d.length;f<h;f++){c=d[f];y=null;if(c.type===b.collision.shape.BOX)y=new Ammo.btBoxShape(new Ammo.btVector3(c.size[0]/
2,c.size[1]/2,c.size[2]/2));else if(c.type===b.collision.shape.SPHERE)y=new Ammo.btSphereShape(c.radius);else if(c.type===b.collision.shape.CAPSULE)y=new Ammo.btCapsuleShape(c.radius,c.height);else if(c.type===b.collision.shape.CYLINDER)y=new Ammo.btCylinderShape(new Ammo.btVector3(c.size[0]/2,c.size[1]/2,c.size[2]/2));else if(c.type===b.collision.shape.CONE)y=new Ammo.btConeShape(c.radius,c.height);else if(c.type===b.collision.shape.MESH){r=c.mesh;y=new Ammo.btTriangleMesh;q=c.size;var w=new Ammo.btVector3(0,
0,0),I=new Ammo.btVector3(0,0,0),F=new Ammo.btVector3(0,0,0);for(g=0,m=r.faces.length;g<m;g++){var G=r.faces[g];3===G.points.length&&(w.setValue(r.points[G.points[0]][0]*q[0],r.points[G.points[0]][1]*q[1],r.points[G.points[0]][2]*q[2]),I.setValue(r.points[G.points[1]][0]*q[0],r.points[G.points[1]][1]*q[1],r.points[G.points[1]][2]*q[2]),F.setValue(r.points[G.points[2]][0]*q[0],r.points[G.points[2]][1]*q[1],r.points[G.points[2]][2]*q[2]),y.addTriangle(w,I,F))}0===this.getMass()||this.getType()==b.physics.body.STATIC||
this.getType()==b.physics.body.GHOST?(this.setMass(0),y=new Ammo.btBvhTriangleMeshShape(y,!0)):y=new Ammo.btConvexTriangleMeshShape(y,!0)}else if(c.type===b.collision.shape.CONVEX_HULL){r=c.mesh;q=c.size;w=new Ammo.btVector3(0,0,0);y=new Ammo.btConvexHullShape;for(g=0,m=r.points.length;g<m;g++)z([r.points[g][0]*q[0],r.points[g][1]*q[1],r.points[g][2]*q[2]],w),y.addPoint(w)}else if(c.type===b.collision.shape.HEIGHTFIELD){I=w=r=q=0;if(c.landscape&&c.landscape instanceof CubicVR.Landscape)q=c.landscape.divisions_w,
w=c.landscape.divisions_h,r=c.landscape.size_w,I=c.landscape.size_h,y=c.landscape.getMesh().points;else continue;F=Ammo.allocate(y.length,"double",Ammo.ALLOC_NORMAL);for(g=0,m=q*w;g<m;g++)Ammo.HEAP[F+g]=y[g][1];y=new Ammo.btHeightfieldTerrainShape(q,w,F,1,-100,100,1,0,!0);y.setUseDiamondSubdivision(!0);g=new Ammo.btVector3(r/q,1,I/w);y.setLocalScaling(g)}y&&(0!==c.margin&&y.setMargin(c.margin),t.push({cShape:c,btShape:y}))}d=null;if(1===t.length)d=t[0].btShape;else if(1<t.length){e=new Ammo.btTransform;
d=new Ammo.btCompoundShape(!1);for(f=0,h=t.length;f<h;f++)e.setIdentity(),e.setOrigin(n(t[f].cShape.position)),e.setRotation(o(t[f].cShape.rotation)),d.addChildShape(e,t[f].btShape)}a.setResult(d);a=d}this.shape=a}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(z(a,h),this.body.setAngularVelocity(h))},setGravity:function(a){this.gravity=a;this.body&&(z(a,h),this.body.setGravity(h))},getGravity:function(){return this.gravity&&!this.body?this.gravity:c(this.body.getGravity())},
setLinearVelocity:function(a){this.linearVelocity=a;this.body&&(z(a,h),this.body.setLinearVelocity(h))},applyImpulse:function(a,b){this.impulse=a||[0,0,0];this.impulsePosition=b||[0,0,0];this.body&&!CubicVR.vec3.equal([0,0,0],a)&&(z(this.impulse,h),z(this.impulsePosition,m),this.body.applyImpulse(h,m))},applyForce:function(a,b){this.body&&!CubicVR.vec3.equal([0,0,0],a)&&(z(a,h),z(b,m),this.body.applyImpulse(h,m))},getAngularVelocity:function(){return c(this.body.getAngularVelocity())},getLinearVelocity:function(){return c(this.body.getLinearVelocity())},
activate:function(a){this.noDeactivate=a||!1;this.body&&(this.noDeactivate&&this.body.setActivationState(b.physics.collision_states.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(b){this.body&&b!==a&&(b.length||(b=[b,b,b]),z(b,h),this.body.setAngularFactor(h))},isActive:function(){return this.body?this.body.isActive():!1},isStatic:function(){return this.properties.type==b.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(a){this.collision_flags=
a=CubicVR.parseEnum(b.physics.collision_flags,a);this.body&&this.body.setCollisionFlags(a)},setPosition:function(a){this.position=a;if(this.body||this.ghost)z(a,h),this.body&&this.body.getCenterOfMassTransform().setOrigin(h),this.ghost&&this.ghost.getWorldTransform().setOrigin(h)},getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;this.body&&this.body.getCenterOfMassTransform().getRotation(f);this.ghost&&this.ghost.getWorldTransform().getRotation(f);var a=new CubicVR.Quaternion;
r(f,a);return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)t(a,f),this.body&&this.body.getCenterOfMassTransform().setRotation(f),this.ghost&&this.ghost.getWorldTransform().setRotation(f)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;var a=new CubicVR.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(f);this.ghost&&this.ghost.getWorldTransform().getRotation(f);r(f,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=
a;f.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(f);this.ghost&&this.body.getWorldTransform().setRotation(f)}};var q=function(d){d=d||{};this.ctype=CubicVR.parseEnum(b.physics.constraint,d.ctype)||b.physics.constraint.P2P;this.strength=d.strength||0.1;this.maxImpulse=d.maxImpulse||0;this.rigidBodyA=d.rigidBodyA||d.rigidBody||null;this.rigidBodyB=d.rigidBodyB||null;this.positionA=d.positionA||
[0,0,0];this.positionB=d.positionB||d.position||[0,0,0];this.damping=d.damping!=a?d.damping:1;this.btConstraint=null;this.localPivotA=n(this.positionA);this.localPivotB=n(this.positionB)};q.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;if(this.ctype===b.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),
this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===Ammo.NULL))this.btConstraint=null}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},
setMaxImpulse:function(a){this.maxImpulse=a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(z(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};g.prototype={getContact:function(){var a=this.manifold.getContactPoint(j);return a===Ammo.NULL?null:{impulse:a.getAppliedImpulse(),lifetime:a.getLifeTime(),
friction:a.get_m_combinedFriction(),positionA:c(a.getPositionWorldOnA()),positionB:c(a.getPositionWorldOnB())}},setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var y=function(){this.rigidObjects=[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;
this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!e||!d)h=new Ammo.btVector3,m=new Ammo.btVector3,e=new Ammo.btTransform,d=new CubicVR.Quaternion,f=new Ammo.btQuaternion};y.prototype={addConstraint:function(a){var b=
a.getConstraint();return b?(this.dynamicsWorld.addConstraint(b),a.rigidBodyA.activate(!0),!0):!1},removeConstraint:function(a){return(a=a.getConstraint())?(this.dynamicsWorld.removeConstraint(a),!0):!1},setGravity:function(a){z(a,h);this.dynamicsWorld.setGravity(h)},bindSceneObject:function(a,b){var d=new CubicVR.RigidBody(a,b);this.rigidObjects.push(d);d.getBody();d.activate();this.dynamicsWorld.addRigidBody(d.getBody());d.updateSceneObject(!0);return d},bind:function(a){a instanceof CubicVR.RigidBody&&
this.bindRigidBody(a)},remove:function(a){a instanceof CubicVR.RigidBody&&this.bindRigidBody(a)},bindRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(-1!==this.ghostObjects.indexOf(a))return;this.ghostObjects.push(a);var d=a.getBody();a.properties.blocker||d.setCollisionFlags(d.getCollisionFlags()+b.physics.collision_flags.NO_CONTACT_RESPONSE);this.dynamicsWorld.addCollisionObject(d)}else{if(-1!==this.rigidObjects.indexOf(a))return;this.rigidObjects.push(a);d=a.getBody();a.activate();
this.dynamicsWorld.addRigidBody(d);a.updateSceneObject(!0)}var c,e;if((c=a.getSceneObject())&&(e=c.getEventHandler()))e.hasEvent(b.event.CONTACT)&&this.contactObjects.push(a),e.hasEvent(b.event.COLLIDE)&&this.collisionObjects.push(a)},removeRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(-1===this.ghostObjects.indexOf(a))return;this.ghostObjects.splice(this.ghostObjects.indexOf(a),1);this.dynamicsWorld.removeCollisionObject(a.getBody())}else{if(-1===this.rigidObjects.indexOf(a))return;
this.rigidObjects.splice(this.rigidObjects.indexOf(a),1);this.dynamicsWorld.removeRigidBody(a.getBody())}var d,c;if((d=a.getSceneObject())&&(c=d.getEventHandler()))c.hasEvent(b.event.CONTACT)&&-1!==this.contactObjects.indexOf(a)&&this.contactObjects.splice(this.contactObjects.indexOf(a),1),c.hasEvent(b.event.COLLIDE)&&-1!==this.collisionObjects.indexOf(a)&&this.collisionObjects.splice(this.collisionObjects.indexOf(a),1)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,
b){this.dynamicsWorld.stepSimulation(a,b||2);for(var d=0,c=0,e=this.rigidObjects.length;c<e;c++)this.rigidObjects[c].updateSceneObject()&&d++;this.active_count=d},triggerEvents:function(){var a,d,c,e,f=this.dynamicsWorld;if(this.contactObjects.length){var h=f.getDispatcher().getNumManifolds();for(a=0;a<h;a++){var m=f.getDispatcher().getManifoldByIndexInternal(a),n=Ammo.wrapPointer(m.getBody0(),Ammo.btRigidBody)._cvr_rigidbody||null,q=Ammo.wrapPointer(m.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||
null;if(n&&(e=n.getSceneObject())&&(d=e.getEventHandler())&&d.hasEvent(b.event.CONTACT))c=d.triggerEvent(b.event.CONTACT),c.self=n,c.other=q,c.contacts?c.contacts.setManifold(m):c.contacts=new g(m);else if(q&&q.isStatic()&&(e=q.getSceneObject())&&(d=e.getEventHandler())&&d.hasEvent(b.event.CONTACT))c=d.triggerEvent(b.event.CONTACT),c.other=n,c.self=q,c.contacts?c.contacts.setManifold(m):c.contacts=new g(m)}}f=this.collisionObjects.length;for(a=0;a<f;a++)if(n=this.collisionObjects[a],(e=n.getSceneObject())&&
(d=e.getEventHandler())&&d.hasEvent(b.event.COLLIDE))if(c=d.getProperties(b.event.COLLIDE),m=c.collidesWith,c.mf=c.mf||[],c.alg=c.alg||[],m&&m.length){h=[];n=n.getBody();for(a=0,iMax=m.length;a<iMax;a++){var q=m[a],o=q.getBody();c.mf[a]||(c.mf[a]=new Ammo.btManifoldResult(n,o));c.alg[a]||(c.alg[a]=this.dynamicsWorld.getDispatcher().findAlgorithm(n,o));c.alg[a].processCollision(n,o,this.dynamicsWorld.getDispatchInfo(),c.mf[a]);0<c.mf[a].getPersistentManifold().getNumContacts()&&(h.push(q),this.dynamicsWorld.getDispatcher().clearManifold(c.mf[a].getPersistentManifold()))}if(h.length&&
(c=d.triggerEvent(b.event.COLLIDE)))c.collisions=h}f=this.ghostObjects.length;for(a=0;a<f;a++)if(c=this.ghostObjects[a],e=c.getSceneObject())if((d=e.getEventHandler())&&d.hasEvent(b.event.CONTACT_GHOST))if(e=c.getBody(),h=e.getNumOverlappingObjects()){c=d.triggerEvent(b.event.CONTACT_GHOST);c.contacts=c.contacts||[];if(c.contacts.length>h)c.contacts.length=h;for(d=0;d<h;d++)m=Ammo.btRigidBody.prototype.upcast(e.getOverlappingObject(d)),c.contacts[d]=m._cvr_rigidbody||null}},reset:function(){for(var a=
0,b=this.rigidObjects.length;a<b;a++)this.rigidObjects[a].reset()},getRayHit:function(a,b,d,e){var f,a=n(a);f=n(b);d=d||!1;e=e||!1;b=new Ammo.ClosestRayResultCallback(a,f);this.dynamicsWorld.rayTest(a,f,b);if(b.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(b.get_m_collisionObject()),body!==Ammo.NULL&&!(body.isStaticObject()&&!d||body.isKinematicObject()&&!e))){d=body;e=b.get_m_hitPointWorld();a=d.getCenterOfMassTransform().inverse().op_mul(e);if(f=d._cvr_rigidbody)return Ammo.destroy(b),{position:c(e),
localPosition:c(a),rigidBody:f,ammoBody:d};Ammo.destroy(b);return{position:c(e),localPosition:c(a),rigidBody:null,ammoBody:d}}Ammo.destroy(b)}};return{ScenePhysics:y,Constraint:q,RigidProperties:function(d){this.type=CubicVR.parseEnum(b.physics.body,d.type);this.mass=d.mass!==a?d.mass:this.type?1:0;this.size=d.size||[1,1,1];this.restitution=d.restitution||(this.type?0:1);this.friction=d.friction||1;if((this.collision=d.collision)&&!this.collision.getShapes)this.collision=new CubicVR.CollisionMap(this.collision);
this.blocker=d.blocker||!1},RigidBody:w,vec3bt_copy:z,btvec3_copy:function(a,b){b[0]=a.x();b[1]=a.y();b[2]=a.z()},quatbt_copy:t,btquat_copy:r}});
CubicVR.RegisterModule("Shader",function(w){function z(d,e){var h=CubicVR.util,g,q,o,r,t=n.gl;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];this.success=!0;this.fragmentLog=this.vertexLog="";-1!==d.indexOf("\n")?(o=d,g=a(n.gl,d,"x-shader/x-vertex")):(g=b(n.gl,d),null===g&&(o=h.getURL(d),g=a(n.gl,o,"x-shader/x-vertex")));if(!t.getShaderParameter(g,t.COMPILE_STATUS))this.vertexLog=t.getShaderInfoLog(g),this.success=!1;-1!==e.indexOf("\n")?(r=e,q=a(n.gl,e,"x-shader/x-fragment")):(q=
b(n.gl,e),null===q&&(r=h.getURL(e),q=a(n.gl,r,"x-shader/x-fragment")));if(!t.getShaderParameter(q,t.COMPILE_STATUS))this.fragmentLog=t.getShaderInfoLog(q),this.success=!1;if(this.success){if(this.shader=t.createProgram(),t.attachShader(this.shader,g),t.attachShader(this.shader,q),t.linkProgram(this.shader),!n.gl.getProgramParameter(this.shader,t.LINK_STATUS))c("Error linking shader:\n"+t.getProgramInfoLog(this.shader)),this.success=!1}else g=h.multiSplit(this.vertexLog,";\n"),h=h.multiSplit(this.fragmentLog,
";\n"),g.length&&this.dumpErrors(g,o),h.length&&this.dumpErrors(h,r)}function t(a){this._update=a.update||null;this._init=a.init||null;this._vertex=CubicVR.get(a.vertex)||null;this._fragment=CubicVR.get(a.fragment)||null;this._bindings=[];this._shaderVars=this._shaderInfo=this._shader=null;this._initialized=!1;a=(this._vertex||"")+(this._fragment||"");this._hasDepthPack=""!==a.trim()?/\s\!?LIGHT_DEPTH_PASS\s/.test(a):!1}var r=w.undef,n=w.GLCore,o=CubicVR.enums,c=w.log,g=CubicVR.util;o.shader={map:{COLOR:1,
SPECULAR:2,NORMAL:4,BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var a=function(a,b,c){if("x-shader/x-fragment"===c)c=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===c)c=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(c,b);a.compileShader(c);return c},b=function(a,b){var c=document.getElementById(b);if(!c)return null;for(var e="",g=c.firstChild;g;)3===g.nodeType&&
(e+=g.textContent),g=g.nextSibling;if("x-shader/x-fragment"===c.type)c=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===c.type)c=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(c,e);a.compileShader(c);return c};z.prototype={isCompiled:function(){return this.success},dumpErrors:function(a,b,c){for(var c=(c||"Error on line")+" ",b=b.split("\n"),e=0,g=a.length;e<g;e++){var n=a[e];if(0===n.indexOf("ERROR: ")){var n=n.substr(7).trim(),o=n.substr(0,n.indexOf(" ")),n=n.substr(o.length),
o=o.split(":"),o=parseInt(o[1],10);console.log(o+"> "+b[o-1]);console.log(c+o+", :"+n)}}},bindSelf:function(a){var b,c,e;-1!==a.indexOf(".")?-1!==a.indexOf("[")?(b=a.split("["),e=b[0],b=b[1].split("]"),c=b[0],b=b[1].split("."),b=b[1],this[e]===r&&(this[e]=[]),this[e][c]===r&&(this[e][c]={}),this[e][c][b]=this.uniforms[a]):(b=a.split("."),e=b[0],b=b[1],this[e]===r&&(this[e]={}),this[e][b]=this.uniforms[a]):-1!==a.indexOf("[")?(b=a.split("["),e=b[0],b=b[1].split("]"),c=b[0],this[e]===r&&(this[e]=[]),
this[e][c]=this.uniforms[a]):this[a]=this.uniforms[a]},addMatrix:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==r&&this.setMatrix(a,b);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);b!==r&&this.setVector(a,b);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==r&&this.setFloat(a,b);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.ARRAY_VERTEX;
this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addInt:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==r&&this.setInt(a,b);this.bindSelf(a);return this.uniforms[a]},use:function(){n.gl.useProgram(this.shader)},setMatrix:function(a,b){var c=this.uniforms[a];if(null!==c){var e=b.length;16===e?n.gl.uniformMatrix4fv(c,!1,b):9===e?n.gl.uniformMatrix3fv(c,
!1,b):4===e&&n.gl.uniformMatrix2fv(c,!1,b)}},setInt:function(a,b){var c=this.uniforms[a];null!==c&&n.gl.uniform1i(c,b)},setFloat:function(a,b){var c=this.uniforms[a];null!==c&&n.gl.uniform1f(c,b)},setVector:function(a,b){var c=this.uniforms[a];if(null!==c){var e=b.length;3==e?n.gl.uniform3fv(c,b):2==e?n.gl.uniform2fv(c,b):n.gl.uniform4fv(c,b)}},clearArray:function(a){a=this.uniforms[a];null!==a&&n.gl.disableVertexAttribArray(a)},bindArray:function(a,b){var c=n.gl,e=this.uniforms[a];if(null!==e){var g=
this.uniform_type[a];g===o.shader.uniform.ARRAY_VERTEX?(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(e,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(e)):g===o.shader.uniform.ARRAY_UV?(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(e,2,c.FLOAT,!1,0,0)):g===o.shader.uniform.ARRAY_FLOAT&&(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(e,1,c.FLOAT,!1,0,0))}}};var e={tidyScript:function(a){return a.replace(/\t+/g," ").replace(/\/\/.*$/gm,"").replace(/\/\*(.|\n)*\*\//g,"").replace(/ +/g,
" ").replace(/ *\[ */g,"[").replace(/ *\] */g,"]").replace(/ *; */g,";").replace(/ *$/gm,"").replace(/^ */gm,"")},getDefines:function(a){var b={},a=g.multiSplit(a,"\n;");for(i=0,iMax=a.length;i<iMax;i++){var c=a[i];0===c.indexOf("#define")&&(c=c.split(" "),2<c.length&&(b[c[1]]=c.slice(2).join(" ")))}return b},replaceAll:function(a,b,c,e){var c=c||"",e=e||"",g;for(g in b)if(b.hasOwnProperty(g))for(var n=c+g+e;-1!==a.indexOf(n);)a=a.replace(n,c+b[g]+e);return a},getShaderInfo:function(a,b){var c,m,
n,o,s,t,v=["uniform","attribute","varying"],w=[],z={};t={};var E;b===r&&(b="");a=e.tidyScript(a);b=e.tidyScript(b);z.v_define=e.getDefines(a);z.f_define=e.getDefines(b);a=e.replaceAll(a,z.v_define,"[","]");b=e.replaceAll(b,z.f_define,"[","]");E=g.multiSplit(a+"\n"+b,"\n;");var u=[];o=n=-1;for(c=0,m=E.length;c<m;c++)s=E[c],-1===n&&0===s.indexOf("struct")?n=c:-1===o&&-1!==n&&-1!==s.indexOf("}")&&(o=c+1),-1!==n&&-1!==o&&(s=E.slice(n,o).join("\n").replace(/(\{|\})/g,"\n").replace(/ +$/gm,"").replace(/^ +/gm,
"").replace(/\n\n/gm,"\n"),u.push({start:n,end:o,struct:s.split("\n")}),o=n=-1);for(c=0,m=u.length;c<m;c++){var x=u[c].struct,B=null;for(n=0,o=x.length;n<o;n++)s=x[n].split(" "),1>=s.length||("struct"==s[0]?(B=s[1],t[B]={}):B&&(t[B][s[1]]=s[0]))}z.struct=t;for(c=0,m=v.length;c<m;c++)z[v[c]]=[];for(c=0,m=E.length;c<m;c++){s=E[c];for(n=0,o=v.length;n<o;n++)if(u=v[n],0===s.indexOf(u)&&(t=s.split(" "),3===t.length&&t[0]==u&&-1===w.indexOf(t[2])))if(w.push(t[2]),-1!==t[2].indexOf("[")){var x=t[2].split("["),
B=x[1].replace("]",""),C=parseInt(B,10);C!==C||(B=C);z[u].push({name:x[0],type:t[1],isArray:!0,len:B})}else z[u].push({name:t[2],type:t[1]})}return z},genShaderVarList:function(a,b){var c=a[b],e=[],g,n,o,r,v,t;if(!c)return[];for(g=0,n=c.length;g<n;g++){var w=c[g];if(a.struct[w.type]){var z=a.struct[w.type];if(z&&w.isArray)for(o=0,r=w.len;o<r;o++)for(t in v=w.name+"["+o+"]",z)z.hasOwnProperty(t)&&e.push({location:v+"."+t,type:z[t],basename:w.name});else for(t in z)e.push({location:w.name+"."+t,type:z[t],
basename:w.name})}else if(w.isArray)for(o=0,r=w.len;o<r;o++)v=w.name+"["+o+"]",e.push({location:v,type:w.type,basename:w.name});else e.push({location:w.name,type:w.type,basename:w.name})}return e},getShaderVars:function(a){var b={};b.uniform=e.genShaderVarList(a,"uniform");b.attribute=e.genShaderVarList(a,"attribute");return b}};t.prototype={use:function(){this._initialized&&this._shader.use()},getShader:function(){return this._shader},ready:function(){return this._initialized},isReady:function(){return this._initialized},
hasDepthPack:function(){return this._hasDepthPack},_init_shader:function(a,b,c,g,n){c=c||[];a=CubicVR.util.get(a);b=CubicVR.util.get(b);n=n||"#define customShader_splice";if(g=g===r?this._vertex||this._fragment:g)g=a.indexOf(n),n=b.indexOf(n),-1!==g&&this._vertex&&(a=a.substr(0,g)+this._vertex),-1!==n&&this._fragment&&(b=b.substr(0,n)+this._fragment);this._shader=new CubicVR.Shader(a,b);this._shaderInfo=e.getShaderInfo(a,b);this._shaderVars=e.getShaderVars(this._shaderInfo);this._appendShaderVars(this._shaderVars,
"uniform",c);this._appendShaderVars(this._shaderVars,"attribute",c);(this._initialized=this._shader.isCompiled())&&this._init&&this._init(this)},_appendShaderVars:function(a,b,c){for(var a=0,e=this._shaderVars[b].length;a<e;a++){var g=this._shaderVars[b][a],n=g.location;if(-1===c.indexOf(g.basename))g=g.type,"vec3"===g?"attribute"===b?this._shader.addVertexArray(n):this._shader.addVector(n):"vec2"===g?"attribute"===b?this._shader.addUVArray(n):this._shader.addVector(n):"float"===g?"attribute"===b?
this._shader.addFloatArray(n):this._shader.addFloat(n):"sampler2D"===g||"int"===g?this._shader.addInt(n):("mat4"===g||"mat3"===g||"mat2"===g)&&this._shader.addMatrix(n),this._bindSelf(n)}},_bindSelf:function(a){var b,c,e,g;if(null!==this._shader.uniforms[a]&&(-1!==a.indexOf(".")?-1!==a.indexOf("[")?(b=a.split("["),e=b[0],b=b[1].split("]"),c=b[0],b=b[1].split("."),b=b[1],this[e]===r&&(this[e]=[]),this[e][c]===r&&(this[e][c]={}),g={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},
this[e][c][b]=g):(b=a.split("."),e=b[0],b=b[1],this[e]===r&&(this[e]={}),g={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[e][b]=g):-1!==a.indexOf("[")?(b=a.split("["),e=b[0],b=b[1].split("]"),c=b[0],this[e]===r&&(this[e]=[]),g={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[e][c]=g):(g={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[a]=g),this._bindings.push(g),g))g.set=function(a){return function(b){g.value=
b;a.update(g)}}(this,g)},_doUpdate:function(){if(this._initialized)if(this._update)this._update(this);else for(var a=0,b=this._bindings.length;a<b;a++)this.update(this._bindings[a])},update:function(a){if(this._initialized){var b=n.gl,c=a.value,e=a.location;if(null!==e)a.type===o.shader.uniform.MATRIX?(a=c.length,16===a?b.uniformMatrix4fv(e,!1,c):9===a?b.uniformMatrix3fv(e,!1,c):4===a&&b.uniformMatrix2fv(e,!1,c)):a.type===o.shader.uniform.INT?b.uniform1i(e,c):a.type===o.shader.uniform.VECTOR?(a=c.length,
3===a?b.uniform3fv(e,c):2===a?b.uniform2fv(e,c):b.uniform4fv(e,c)):a.type===o.shader.uniform.FLOAT?b.uniform1f(e,c):a.type===o.shader.uniform.ARRAY_VERTEX?(b.bindBuffer(b.ARRAY_BUFFER,c),b.vertexAttribPointer(e,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(e)):a.type===o.shader.uniform.ARRAY_UV?(b.bindBuffer(b.ARRAY_BUFFER,c),b.vertexAttribPointer(e,2,b.FLOAT,!1,0,0),b.enableVertexAttribArray(e)):a.type===o.shader.uniform.ARRAY_FLOAT&&(b.bindBuffer(b.ARRAY_BUFFER,c),b.vertexAttribPointer(e,1,b.FLOAT,
!1,0,0),b.enableVertexAttribArray(e))}}};return{Shader:z,shader_util:e,CustomShader:t}});
CubicVR.RegisterModule("UVMapper",function(w){function z(a){a=CubicVR.get(a)||{};this.rotation=a.rotation===t?[0,0,0]:a.rotation;this.scale=a.scale===t?[1,1,1]:a.scale;this.center=a.center===t?[0,0,0]:a.center;this.projection_mode=a.projectionMode===t?r.uv.projection.PLANAR:CubicVR.parseEnum(r.uv.projection,a.projectionMode);this.projection_axis=a.projectionAxis===t?r.uv.axis.X:CubicVR.parseEnum(r.uv.axis,a.projectionAxis);this.wrap_w_count=a.wrapW===t?1:a.wrapW;this.wrap_h_count=a.wrapH===t?1:a.wrapH}
var t=w.undef,r=CubicVR.enums,n=2*Math.PI,o=Math.PI/2;r.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var c=function(a,b,c){return 0===a&&0===c?0:0===c?0>a?o:-o:0>c?-Math.atan(a/c)+Math.PI:-Math.atan(a/c)},g=function(a,b,c){var d;0===a&&0===c?(d=0,a=0!==b?0>b?-o:o:0):(d=0===c?0>a?o:-o:0>c?-Math.atan(a/c)+Math.PI:-Math.atan(a/c),a=Math.sqrt(a*a+c*c),a=0===a?0>b?-o:o:Math.atan(b/a));return[d,a]};z.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=
a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=a},apply:function(a,b,e,d,f){var h=CubicVR.mat4,m,q,y,s,w,v=new CubicVR.Transform,z=!1,J=null;if(this.center[0]||this.center[1]||this.center[2])v.translate(-this.center[0],-this.center[1],-this.center[2]),z=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&
v.rotate(this.rotation[2],0,0,1),this.rotation[1]&&v.rotate(this.rotation[1],0,1,0),this.rotation[2]&&v.rotate(this.rotation[0],1,0,0),z=!0;z&&(J=v.getResult());"object"===typeof b&&(b=a.materials.indexOf(b));var v=0,E=a.faces.length;d&&(v=d);for(f&&(E=f+1);v<E;v++)if(a.faces[v].material===b&&!(e!==t&&a.faces[v].segment!==e)){var u,x,B;if(this.projection_mode===r.uv.projection.CUBIC||this.projection_mode===r.uv.projection.SKY)u=Math.abs(a.faces[v].normal[0]),x=Math.abs(a.faces[v].normal[1]),B=Math.abs(a.faces[v].normal[2]);
for(var d=[],f=0,C=a.faces[v].points.length;f<C;f++){q=a.faces[v].points[f];var D=a.faces[v].points[(f+1)%3],K=a.faces[v].points[(f+2)%3];m=a.points[q];var I=a.points[D],F=a.points[K],G;z&&(m=h.vec3_multiply(m,J));G=this.projection_mode;if(G===r.uv.projection.SKY)q=a.sky_mapping,u>=x&&u>=B&&(y=m[2]/this.scale[2]+this.scale[2]/2,s=-m[1]/this.scale[1]+this.scale[1]/2,0>a.faces[v].normal[0]?(y=(q[2][2]-q[2][0])*(1-y),s=1-(q[2][3]-q[2][1])*s,y+=q[2][0],s+=q[2][1]):(y*=q[3][2]-q[3][0],s=1-(q[3][3]-q[3][1])*
s,y+=q[3][0],s+=q[3][1])),x>=u&&x>=B&&(y=m[0]/this.scale[0]+this.scale[0]/2,s=-m[2]/this.scale[2]+this.scale[2]/2,0>a.faces[v].normal[1]?(y*=q[1][2]-q[1][0],s=1-(q[1][3]-q[1][1])*s,y+=q[1][0],s-=q[1][1]):(y*=q[0][2]-q[0][0],s=1-(q[0][3]-q[0][1])*s,y+=q[0][0],s-=q[0][1])),B>=u&&B>=x&&(y=m[0]/this.scale[0]+this.scale[0]/2,s=m[1]/this.scale[1]+this.scale[1]/2,0>a.faces[v].normal[2]?(y*=q[4][2]-q[4][0],s=1-(q[4][3]-q[4][1])*(1-s),y+=q[4][0],s-=q[4][1]):(y=(q[5][2]-q[5][0])*(1-y),s=1-(q[5][3]-q[5][1])*
(1-s),y+=q[5][0],s+=q[5][1])),a.faces[v].setUV([y,s],f);else if(G===r.uv.projection.CUBIC)u>=x&&u>=B&&(y=m[2]/this.scale[2]+0.5,s=m[1]/this.scale[1]+0.5),x>=u&&x>=B&&(y=-m[0]/this.scale[0]+0.5,s=m[2]/this.scale[2]+0.5),B>=u&&B>=x&&(y=-m[0]/this.scale[0]+0.5,s=m[1]/this.scale[1]+0.5),0<a.faces[v].normal[0]&&(y=-y),0>a.faces[v].normal[1]&&(y=-y),0<a.faces[v].normal[2]&&(y=-y),a.faces[v].setUV([y,s],f);else if(G===r.uv.projection.PLANAR)y=this.projection_axis===r.uv.axis.X?m[2]/this.scale[2]+0.5:-m[0]/
this.scale[0]+0.5,s=this.projection_axis===r.uv.axis.Y?m[2]/this.scale[2]+0.5:m[1]/this.scale[1]+0.5,a.faces[v].setUV([y,s],f);else{if(G===r.uv.projection.CYLINDRICAL)G=this.projection_axis,G===r.uv.axis.X?(w=c(m[2],m[0],-m[1]),s=-m[0]/this.scale[0]+0.5):G===r.uv.axis.Y?(w=c(-m[0],m[1],m[2]),s=-m[1]/this.scale[1]+0.5):G===r.uv.axis.Z&&(w=c(-m[0],m[2],-m[1]),s=-m[2]/this.scale[2]+0.5),w=1-w/n,1!==this.wrap_w_count&&(w*=this.wrap_w_count),m=w,q=s;else if(G===r.uv.projection.SPHERICAL){var L,O,N;G=this.projection_axis;
G===r.uv.axis.X?(L=d[q]?d[q]:g(m[2],m[0],-m[1]),d[q]||(d[q]=L),O=d[D]?d[D]:g(I[2],I[0],-I[1]),d[D]||(d[D]=O),N=d[K]?d[K]:g(F[2],F[0],-F[1]),d[K]||(d[K]=N)):G===r.uv.axis.Y?(L=d[q]?d[q]:g(m[0],-m[1],m[2]),d[q]||(d[q]=L),O=d[D]?d[D]:g(I[0],-I[1],I[2]),d[D]||(d[D]=O),N=d[K]?d[K]:g(F[0],-F[1],F[2]),d[K]||(d[K]=N)):G===r.uv.axis.Z&&(L=d[q]?d[q]:g(-m[0],m[2],-m[1]),d[q]||(d[q]=L),O=d[D]?d[D]:g(-I[0],I[2],-I[1]),d[D]||(d[D]=O),N=d[K]?d[K]:g(-F[0],F[2],-F[1]),d[K]||(d[K]=N));Math.abs(L[0]-O[0])>o&&Math.abs(L[0]-
N[0])>o&&(L[0]=L[0]>O[0]&&L[0]>N[0]?L[0]-n:L[0]+n);Math.abs(L[1]-O[1])>o&&Math.abs(L[1]-N[1])>o&&(L[1]=L[1]>O[1]&&L[1]>N[1]?L[1]-n:L[1]+n);w=1-L[0]/n;q=0.5-L[1]/Math.PI;1!==this.wrap_w_count&&(w*=this.wrap_w_count);1!==this.wrap_h_count&&(q*=this.wrap_h_count);m=w}else q=m=0;a.faces[v].setUV([m,q],f)}}}return this}};return{UVMapper:z}});
CubicVR.RegisterModule("Worker",function(w){function z(a){var b=this;this.message=a.message||function(){};this.send=function(a,b){postMessage({message:a,data:b})};self.addEventListener("message",function(a){"init"!==a.data.message&&b.message(a.data)},!1)}function t(a){function b(a){setTimeout(function(){c.send("test",a)},1E3)}a&&b(a);var c=new z({message:b})}function r(a){function b(a){a=q.getURL(a);c.send("done",a.length)}var c;c=new z({message:function(a){b(a)}});a&&b(a)}function n(a){function b(a){a=
q.getURL(a);c.send("loaded",a)}var c,d;c=new z({message:function(a){if("parse"===a.message)d=new m,CubicVR.loadCollada("","",d,a.data),c.send("parsed");else if("getMesh"===a.message){if(a=d.meshMap[":"+a.data]){var b=a.triangulateQuads().compileVBO(a.compileMap());c.send("getMesh",{mesh:a,vbo:b})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&b(a)}function o(b){function c(b){var e=new a,f;for(f in b)b.hasOwnProperty(f)&&(e[f]=b[f]);b=e.triangulateQuads().compileVBO(e.compileMap());
d.send("done",b)}var d;d=new z({message:function(a){c(a)}});b&&c(b)}try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(c){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var g=w.undef,a=CubicVR.Mesh,b=CubicVR.Texture,e=CubicVR.Material,d=CubicVR.SceneObject,f=CubicVR.Motion,h=CubicVR.Envelope,m=CubicVR.DeferredBin,q=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");
this.message=a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var b=this;this.worker.onmessage=function(a){b.message(a.data)};this.worker.onerror=function(a){b.error(a)};this.init=function(a){b.send("init",{type:b.type,data:a})};this.send=function(a,c){b.worker.postMessage({message:a,data:c})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&b.init(a.data)},ResourcePool:function(){function c(b){var d=
b.parsed||function(){},e={},f;b.url.match(/\.dae/)&&(f=new CubicVR.Worker({type:"sceneFile",data:b.url,message:function(b){if("loaded"===b.message){var b=(new DOMParser).parseFromString(b.data,"text/xml"),c=q.xml2badgerfish(b);console.log(b);f.send("parse",c)}else if("getMesh"===b.message){var c=new a,g;for(g in b.data.mesh)b.data.mesh.hasOwnProperty(g)&&(c[g]=b.data.mesh[g]);c.bindBuffer(c.bufferVBO(b.data.vbo));e.getMesh&&e.getMesh(c)}else"parsed"===b.message&&d()}}));this.getSceneObject=function(a,
b){f.send("getMesh",a);e.getMesh=b}}function f(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var g=this,h={};this.createSceneFileManager=function(a){var b=new c({url:a.url,parsed:a.parsed});return h[a.url]=b};this.removeSceneFileManager=function(a){if("string"===typeof settings)delete h[settings];else for(var b in h)h[b]===a&&delete h[b]};this.createSceneObjectFromMesh=function(c){var h=c.scene,m=c.object,n=c.assetBase||"",o=g.createSceneFileManager({url:c.mesh,parsed:function(){m&&
o.getSceneObject(m,function(c){for(var c=f(c,new a),g=0,m=c.materials.length;g<m;++g){for(var o=f(c.materials[g],new e),q=0,r=o.textures.length;q<r;++q){var t=o.textures[g];o.textures[g]=new b(n+t.img_path,t.filter_type)}c.materials[g]=o}c=new d(c);h.bindSceneObject(c)})}})};this.loadFile=function(a,b){b=b||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){b(a.data)}})}},loadColladaWorker:function(c,m,n,o){var q;try{q=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(r){throw Error("Can't find collada.js");
}var t=[],u=[];q.onmessage=function(m){function q(a,b){for(var c in a)b[c]=a[c]}function r(a){if(a.motion){for(var b=a.motion.controllers,c=[],d=0,e=b.length;d<e;++d){var g=b[d];if(g){for(var m=[],n=0,o=g.length;n<o;++n){var s=g[n];if(s){var t=s.keys[0];if(1<s.keys.length)t.prev=null,t.next=s.keys[1],t=s.keys[1];for(var u=1,v=s.keys.length-1;u<v;++u)t.prev=s.keys[u-1],t.next=s.keys[u+1],t=s.keys[u+1];if(1<s.keys.length)t=s.keys[s.keys.length-1],t.prev=s.keys[s.keys.length-2],t.next=null;s.firstKey=
s.keys[0];s.lastKey=s.keys[s.keys.length-1];s.keys=s.firstKey;t=new h;q(s,t);m[n]=t}else g[n]=null}c[d]=m}else b[d]=null}a.motion.controllers=c;b=new f;q(a.motion,b);a.motion=b}}function s(b){var e=new d;q(b,e);if(null!==b.obj){var f=u[b.obj.id];if(f===g)if(f=new a,q(b.obj,f),e.obj=f,u[b.obj.id]=f,o){if(0<f.points.length){o.addMesh(c,c+":"+f.id,f);for(var h=0,m=f.faces.length;h<m;++h){var n=f.faces[h],r=n.material;n.material=t[r]!==g?t[r]:0}}}else e.obj.triangulateQuads(),e.obj.calcNormals(),e.obj.compile(),
e.obj.clean();else e.obj=f}e.trans=new Transform;if(b.children&&0<b.children.length&&(e.children=[],b.children)){f=0;for(h=b.children.length;f<h;++f)m=s(b.children[f]),e.bindChild(m)}return e}var w;w=m.data.message;if("materials"==w){var z=JSON.parse(m.data.data);for(m=0,w=z.length;m<w;++m){var F=new e(z[m].name),G=F.material_id;q(z[m],F);F.material_id=G;t[z[m].material_id]=G;for(var G=0,H=z[m].textures.length;G<H;++G){var J=z[m].textures[G];if(J){var N=Texture_ref[J.img_path];N===g?(J=new b(J.img_path,
J.filter_type,o,c),F.textures[G]=J):F.textures[G]=Textures_obj[N]}else F.textures[G]=0}}}else if("scene"==w){z=JSON.parse(m.data.data);for(m=0,w=z.sceneObjects.length;m<w;++m){F=z.sceneObjects[m];null!==F.obj&&nop();if(F.reassembled===g)r(F),F.reassembled=!0;z.sceneObjects[m]=s(F)}F=new Scene;m=F.camera;w=m.transform;q(z.camera,m);q(z.camera.transform,w);r(m);F.camera=m;F.camera.transform=w;F.camera.frustum=new Frustum;for(m=0,w=z.sceneObjects.length;m<w;++m){G=z.sceneObjects[m];F.bindSceneObject(G);
try{G.getAABB()}catch(Y){}}for(m=0,w=z.lights.length;m<w;++m)G=new Light,q(z.lights[m],G),G.trans=new Transform,r(G),F.bindLight(G);n(F)}else console.log("message from collada worker:",m.data.message)};q.onerror=function(a){console.log("error from collada worker:",a.message)};q.postMessage({message:"start",params:{meshUrl:c,prefix:m,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:t,prepareMesh:o,file:r,sceneFile:n};self.addEventListener("message",function(b){if("init"===
b.data.message){var c=b.data.data.type;if(c in a)new a[c](b.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});window.CubicVR.CubicVRCoreVS="attribute vec3 vertexPosition;\nattribute vec3 vertexNormal;\nattribute vec2 vertexTexCoord;\n#if VERTEX_COLOR\nattribute vec3 vertexColor;\nvarying vec3 vertexColorOut;\n#endif\n#if VERTEX_MORPH\nattribute vec3 vertexMorphPosition;\nattribute vec3 vertexMorphNormal;\nuniform float materialMorphWeight;\n#endif\nvarying vec2 vertexTexCoordOut;\nuniform vec2 materialTexOffset;\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#endif\nuniform mat4 matrixModelView;\nuniform mat4 matrixProjection;\nuniform mat4 matrixObject;\nuniform mat3 matrixNormal;\nvarying vec3 vertexNormalOut;\nvarying vec4 vertexPositionOut;\n#if !LIGHT_DEPTH_PASS\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform mat4 lightShadowMatrix[LIGHT_COUNT];\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#endif \nvoid cubicvr_normalMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( vertexNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( vertexNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(vertexNormal, tangent);\nbinormal = normalize(binormal);\nmat4 uMVOMatrix = matrixModelView * matrixObject;\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (vertexNormal, 0.0)))\n);\nenvEyeVectorOut = vec3(uMVOMatrix * vec4(vertexPosition,1.0)) * TBNMatrix;\n#endif\n#endif\n}\nvoid cubicvr_environmentMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nenvTexCoordOut = normalize( vertexPositionOut.xyz );\n#else\nvec3 ws = (matrixModelView * vec4(vertexPosition,1.0)).xyz;\nvec3 r = reflect(ws, vertexNormalOut );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nenvTexCoordOut.s = r.x/m + 0.5;\nenvTexCoordOut.t = r.y/m + 0.5;\n#endif\n#endif\n#if VERTEX_COLOR\nvertexColorOut = vertexColor;\n#endif\n#endif\n}\nvoid cubicvr_shadowMap() {\n#if (LIGHT_IS_SPOT||LIGHT_IS_AREA) && LIGHT_SHADOWED\nfor (int i = 0; i < LIGHT_COUNT; i++)\n{\n#if LIGHT_SHADOWED\n#if VERTEX_MORPH\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0));\n#else\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n}\nvoid cubicvr_lighting() {\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),vertexNormalOut),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),vertexNormalOut),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vertexNormalOut, normalize(l)));\nfloat NdotH = max(0.0, dot(vertexNormalOut, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\nspec2 = lightSpecular[i] * materialSpecular * power;\nspecTotal += spec2*spotEffect;\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#endif \ncubicvr_normalMap();\ncubicvr_shadowMap();\ncubicvr_environmentMap();\n}\nvec2 cubicvr_texCoord() {\nreturn vertexTexCoord + materialTexOffset;\n}\nvec4 cubicvr_transform() {\n#if LIGHT_DEPTH_PASS\nvertexNormalOut = vec3(0.0,0.0,0.0);\n#endif\n#if VERTEX_MORPH\nvec4 vPos = matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0);\n#else\nvec4 vPos = matrixObject * vec4(vertexPosition, 1.0);\n#endif\nvertexPositionOut = matrixModelView * vPos;\nreturn vPos;\n}\nvec3 cubicvr_normal() {\n#if VERTEX_MORPH\nreturn normalize(matrixObject*vec4(vertexNormal+(vertexMorphNormal-vertexNormal)*materialMorphWeight,0.0)).xyz;\n#else\nreturn normalize(matrixObject*vec4(vertexNormal,0.0)).xyz;\n#endif\n}\n#define customShader_splice 1\nvoid main(void)\n{\nvertexTexCoordOut = cubicvr_texCoord();\ngl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n#if !LIGHT_DEPTH_PASS  \nvertexNormalOut = matrixNormal * cubicvr_normal();\ncubicvr_lighting();\n#endif \n}\n";
window.CubicVR.CubicVRCoreFS="#ifdef GL_ES\n#if LIGHT_PERPIXEL\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\nuniform vec3 materialAmbient;\nuniform vec3 lightAmbient;\nuniform vec3 materialColor;\n#if LIGHT_PERPIXEL\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\n#endif\n#if LIGHT_IS_PROJECTOR\nuniform sampler2D lightProjectionMap[LIGHT_COUNT];\n#endif\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform sampler2D lightShadowMap[LIGHT_COUNT];\nuniform vec3 lightDepthClip[LIGHT_COUNT];\n#endif\n#else \nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif  \nvarying vec3 vertexNormalOut;\nvarying vec2 vertexTexCoordOut;\n#if VERTEX_COLOR\nvarying vec3 vertexColorOut;\n#endif\n#if FX_DEPTH_ALPHA||LIGHT_DEPTH_PASS||LIGHT_SHADOWED\nuniform vec3 postDepthInfo;\nfloat ConvertDepth3(float d) { return (postDepthInfo.x*postDepthInfo.y)/(postDepthInfo.y-d*(postDepthInfo.y-postDepthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - postDepthInfo.x ) / ( postDepthInfo.y - postDepthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if LIGHT_DEPTH_PASS\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if LIGHT_SHADOWED\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if LIGHT_SHADOWED_SOFT\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\nuniform sampler2D textureColor;\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#if TEXTURE_BUMP\nuniform sampler2D textureBump;\n#endif\n#if TEXTURE_ENVSPHERE\nuniform sampler2D textureEnvSphere;\nuniform float materialEnvironment;\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_REFLECT\nuniform sampler2D textureReflect;\n#endif\n#if TEXTURE_NORMAL\nuniform sampler2D textureNormal;\n#endif\nuniform float materialAlpha;\n#if TEXTURE_AMBIENT\nuniform sampler2D textureAmbient;\n#endif\n#if TEXTURE_SPECULAR\nuniform sampler2D textureSpecular;\n#endif\n#endif \n#if TEXTURE_ALPHA\nuniform sampler2D textureAlpha;\n#endif\nvarying vec4 vertexPositionOut;\nvec2 cubicvr_texCoord() {\n#if LIGHT_DEPTH_PASS\nreturn vertexTexCoordOut;\n#else\n#if TEXTURE_BUMP\nfloat height = texture2D(textureBump, vertexTexCoordOut.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(envEyeVectorOut);\nreturn vertexTexCoordOut.xy + (eye.xy * v);\n#else\nreturn vertexTexCoordOut;\n#endif\n#endif\n}\nvec3 cubicvr_normal(vec2 texCoord) {\n#if TEXTURE_NORMAL && !LIGHT_DEPTH_PASS\nvec3 bumpNorm = vec3(texture2D(textureNormal, texCoord));\nvec3 n = (vec4(normalize(vertexNormalOut),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nreturn normalize((n+bumpNorm)/2.0);\n#else\nreturn normalize(vertexNormalOut);\n#endif\n}\nvec4 cubicvr_color(vec2 texCoord) {\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\n#if !(LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA)\ncolor = texture2D(textureColor, texCoord).rgba;\ncolor.rgb *= materialColor;\n#else\ncolor = texture2D(textureColor, texCoord).rgba;\n#if !TEXTURE_ALPHA\nif (color.a<=0.9) {\ndiscard;\n}\n#endif\ncolor.rgb *= materialColor;\n#endif\n#if VERTEX_COLOR\ncolor *= vec4(vertexColorOut,1.0);\n#endif\n#else\n#if VERTEX_COLOR\ncolor = vec4(vertexColorOut,1.0);\n#else\ncolor = vec4(materialColor,1.0);\n#endif\n#endif\n#if TEXTURE_ALPHA\ncolor.a = texture2D(textureAlpha, texCoord).r;\n#if FX_DEPTH_ALPHA\nif (color.a < 0.9) discard;\n#else\n#if MATERIAL_ALPHA\nif (color.a == 0.0) discard;\n#else\nif (color.a < 0.9) discard;\n#endif\n#endif\n#else\n#if MATERIAL_ALPHA\ncolor.a = materialAlpha;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_lighting(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\nvec3 accum = lightAmbient;\n#if LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nvec3 spec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_AREA\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\naccum += shadow * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#else\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if LIGHT_SHADOWED\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !LIGHT_IS_PROJECTOR\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if LIGHT_IS_PROJECTOR && LIGHT_SHADOWED\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lightProjectionMap[i],shadowCoord.st).rgb;\naccum += att * projTex * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n}\n#else\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lightSpecular[i] * materialSpecular * power;\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if LIGHT_SHADOWED\n#endif\n#endif\n#else\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb *= lightColorOut;\ncolor.rgb += lightSpecularOut;\n#endif\n#endif \n#if TEXTURE_AMBIENT\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb += texture2D(textureAmbient, texCoord).rgb*(vec3(1.0,1.0,1.0)+materialColor*materialAmbient);\n#else\ncolor.rgb = color.rgb*texture2D(textureAmbient, texCoord).rgb;\n#endif\n#else\n#if TEXTURE_COLOR\ncolor.rgb += materialAmbient*texture2D(textureColor, texCoord).rgb;\n#else\ncolor.rgb += materialColor*materialAmbient;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_environment(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_REFLECT\nfloat environmentAmount = texture2D( textureReflect, texCoord).r;\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvec3 r = reflect( envTexCoordOut, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * materialEnvironment;\n#endif\n#else\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * materialEnvironment;\n#endif\n#endif\n#endif \n#endif \n#if FX_DEPTH_ALPHA\n#if !MATERIAL_ALPHA\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\nreturn color;\n}\n#if LIGHT_DEPTH_PASS\nvec4 cubicvr_depthPack(vec2 texCoord) {\n#if TEXTURE_ALPHA\nfloat alphaVal = texture2D(textureAlpha, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\nreturn packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n}\n#endif\n#define customShader_splice 1\nvoid main(void)\n{\nvec2 texCoord = cubicvr_texCoord();\n#if !LIGHT_DEPTH_PASS\nvec4 color = cubicvr_color(texCoord);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n#else \ngl_FragColor = cubicvr_depthPack(texCoord);\n#endif\n}\n";